<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Raheem AI</title>
  <style>
    :root{
      --bg0:#050610; --bg1:#070a18; --bg2:#0a0f22;
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text:#f4f7ff; --muted: rgba(244,247,255,.72);
      --a1:#50ffd7; --a2:#65b7ff; --a3:#c7a5ff; --hot:#ff4fd8;
      --shadow: 0 28px 72px rgba(0,0,0,.58);
      --shadow2: 0 18px 48px rgba(0,0,0,.42);
      --r:22px; --r2:16px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% -10%, rgba(80,255,215,.14), transparent 60%),
        radial-gradient(1100px 650px at 85% 0%, rgba(101,183,255,.14), transparent 58%),
        radial-gradient(900px 620px at 50% 115%, rgba(199,165,255,.12), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
      overflow-x:hidden;
    }
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 330px 1fr;
      gap: 18px;
      padding: 18px;
    }
    @media (max-width: 980px){ .app{ grid-template-columns: 1fr; } }

    .side, .main{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .main{ box-shadow: var(--shadow); display:flex; flex-direction:column; min-height: calc(100vh - 36px); }

    .brand{
      display:flex; align-items:center; gap: 12px;
      padding: 16px 16px 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .logo{
      width: 46px; height: 46px; border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: 0 0 26px rgba(80,255,215,.10), 0 0 26px rgba(101,183,255,.08);
      display:grid; place-items:center; font-weight: 950;
      letter-spacing:.5px;
    }
    .brand h1{ margin:0; font-size: 18px; font-weight: 950; line-height:1.1; }
    .brand h1 span{
      background: linear-gradient(90deg, var(--a1), var(--a2), var(--a3));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .brand .sub{ margin-top:4px; font-size: 12px; color: rgba(244,247,255,.60); }

    .nav{ padding: 12px; display:flex; flex-direction:column; gap: 10px; }
    .navbtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      text-align:left;
    }
    .navbtn:hover{ transform: translateY(-1px); border-color: rgba(101,183,255,.34); background: rgba(0,0,0,.24); }
    .tag{
      font-size: 11px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(244,247,255,.80);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .tag.live{ border-color: rgba(80,255,215,.38); background: rgba(80,255,215,.10); }
    .tag.new{ border-color: rgba(199,165,255,.35); background: rgba(199,165,255,.10); }

    .sideFoot{
      padding: 12px 16px 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      color: rgba(244,247,255,.60);
      font-size: 12px;
      line-height:1.35;
    }

    .topbar{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .crumb{ display:flex; align-items:center; gap: 10px; min-width:0; }
    .title{ font-weight: 950; font-size: 15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hint{ font-size: 12px; color: rgba(244,247,255,.60); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      font-weight: 850;
      font-size: 13px;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(101,183,255,.36); background: rgba(255,255,255,.10); }
    .btn.primary{
      border-color: rgba(80,255,215,.34);
      background: linear-gradient(135deg, rgba(80,255,215,.16), rgba(101,183,255,.10));
      box-shadow: 0 0 18px rgba(80,255,215,.08);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none !important; }

    .view{ display:none; padding: 18px; }
    .view.show{ display:block; }

    .hero{
      padding: 16px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
    }
    .hero h2{ margin:0; font-size: 22px; font-weight: 950; }
    .hero p{ margin:8px 0 0 0; color: var(--muted); line-height:1.55; }

    .panel{
      margin-top: 14px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panelHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      background: rgba(0,0,0,.12);
      font-weight: 950;
    }
    .panelBody{ padding: 14px; }

    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding: 11px 11px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
      line-height:1.45;
      font-size: 13px;
    }
    textarea{ resize: vertical; }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; min-width: 200px; }
    .row.tight > *{ min-width: 150px; }

    .chatWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .chatBox{
      height: min(62vh, 620px);
      overflow:auto;
      padding: 12px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
    }
    .msg{
      display:flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .bubble{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(244,247,255,.92);
      white-space: pre-wrap;
      line-height:1.55;
      max-width: 920px;
    }
    .bubble.user{
      background: rgba(80,255,215,.10);
      border-color: rgba(80,255,215,.22);
    }
    .bubble.assistant{
      background: rgba(101,183,255,.08);
      border-color: rgba(101,183,255,.20);
    }
    .metaLine{
      font-size: 12px;
      color: rgba(244,247,255,.60);
      margin-top: 6px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 50;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color: rgba(244,247,255,.95);
      box-shadow: var(--shadow2);
      display:none;
      max-width: min(760px, calc(100vw - 26px));
      line-height:1.45;
    }
    .toast.show{ display:block; animation: pop .18s ease; }
    @keyframes pop{
      from{ transform: translateX(-50%) translateY(8px); opacity:0; }
      to{ transform: translateX(-50%) translateY(0); opacity:1; }
    }

    .small{ font-size:12px; color: rgba(244,247,255,.60); line-height:1.45; }

    .split{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      margin-top: 14px;
      align-items:start;
    }
    @media (max-width: 980px){ .split{ grid-template-columns: 1fr; } }

    .field{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      padding: 12px;
      margin-bottom: 12px;
    }
    .labelRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    label{
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.25px;
      color: rgba(244,247,255,.92);
    }
    .helpBtn{
      width: 26px; height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      font-size: 12px; font-weight: 950;
      cursor:pointer;
      user-select:none;
    }
    .helpText{
      margin-top: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(244,247,255,.75);
      line-height:1.45;
      font-size: 12px;
      display:none;
    }
    .helpText.show{ display:block; }

    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; color: rgba(244,247,255,.80); }
  </style>
</head>

<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <div class="logo">R</div>
        <div>
          <h1><span>Raheem AI</span></h1>
          <div class="sub">TGD chat (strict) + Fire Cert workflow</div>
        </div>
      </div>

      <div class="nav">
        <button class="navbtn" id="navHome" type="button">
          <div style="display:flex; gap:10px; align-items:center;">
            <span class="tag">Home</span>
            <div>
              <div style="font-weight:950">Overview</div>
              <div style="font-size:12px;color:rgba(244,247,255,.60);margin-top:2px">Quick start</div>
            </div>
          </div>
          <span class="tag">↗</span>
        </button>

        <button class="navbtn" id="navChat" type="button">
          <div style="display:flex; gap:10px; align-items:center;">
            <span class="tag live">Live</span>
            <div>
              <div style="font-weight:950">Chat</div>
              <div style="font-size:12px;color:rgba(244,247,255,.60);margin-top:2px">Your strict TGD assistant</div>
            </div>
          </div>
          <span class="tag">↗</span>
        </button>

        <button class="navbtn" id="navFireCert" type="button">
          <div style="display:flex; gap:10px; align-items:center;">
            <span class="tag new">New</span>
            <div>
              <div style="font-weight:950">Fire Cert</div>
              <div style="font-size:12px;color:rgba(244,247,255,.60);margin-top:2px">Questions → report</div>
            </div>
          </div>
          <span class="tag">↗</span>
        </button>
      </div>

      <div class="sideFoot">
        Backend: <span class="mono" id="apiBaseLabel"></span><br/>
        Chat strictness is controlled by your backend logic — this UI does not change it.
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="crumb">
          <div class="title" id="viewTitle">Overview</div>
          <div class="hint" id="viewHint">Quick start</div>
        </div>
        <div class="row tight" style="justify-content:flex-end; flex:0; min-width:unset;">
          <button class="btn" id="btnStatus" type="button">Status</button>
          <button class="btn primary" id="btnDocs" type="button">Docs</button>
        </div>
      </div>

      <!-- HOME -->
      <section class="view show" id="viewHome">
        <div class="hero">
          <h2>What you have right now</h2>
          <p>
            Chat is back and wired to your existing strict endpoint. Fire Cert collects answers and generates a report.
            No backend endpoints were changed by this HTML.
          </p>
        </div>

        <div class="panel">
          <div class="panelHead">Quick actions</div>
          <div class="panelBody">
            <div class="row">
              <button class="btn primary" id="goChat" type="button">Open Chat</button>
              <button class="btn primary" id="goFire" type="button">Open Fire Cert</button>
            </div>
            <div class="small" style="margin-top:10px;">
              Tip: For strict compliance answers, turn on “Evidence mode” and upload TGDs.
            </div>
          </div>
        </div>
      </section>

      <!-- CHAT -->
      <section class="view" id="viewChat">
        <div class="hero">
          <h2>Chat</h2>
          <p>
            This is wired to <span class="mono">POST /chat_stream</span> and will stream the answer.
            Evidence mode forces document-grounded behaviour. Your backend still enforces strict numeric rules.
          </p>
        </div>

        <div class="panel">
          <div class="panelHead">Evidence controls</div>
          <div class="panelBody">
            <div class="row">
              <div class="field" style="margin:0;">
                <div class="labelRow">
                  <label>Evidence mode (force docs)</label>
                  <span class="helpBtn" data-help="helpEvidence">i</span>
                </div>
                <select id="forceDocs">
                  <option value="false">Off</option>
                  <option value="true">On</option>
                </select>
                <div class="helpText" id="helpEvidence">
                  If On, the backend will treat your question as compliance-focused and try to use uploaded TGDs as SOURCES.
                  For numeric requirements, your backend will refuse unless the extracted text contains the numbers.
                </div>
              </div>

              <div class="field" style="margin:0;">
                <div class="labelRow">
                  <label>Choose a PDF (optional)</label>
                  <span class="helpBtn" data-help="helpPdf">i</span>
                </div>
                <select id="pdfSelect">
                  <option value="">Auto-pick (recommended)</option>
                </select>
                <div class="helpText" id="helpPdf">
                  If you select a PDF, the backend will try to pull the most relevant excerpts from that document.
                  If you leave it on Auto, it will choose based on your question.
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="field" style="margin:0;">
                <div class="labelRow">
                  <label>Upload PDF (TGD / guidance)</label>
                  <span class="helpBtn" data-help="helpUpload">i</span>
                </div>
                <input id="pdfUpload" type="file" accept="application/pdf" />
                <div class="helpText" id="helpUpload">
                  Upload the TGD PDFs you want the assistant to use. After upload, refresh the PDF list.
                </div>
                <div class="row tight" style="margin-top:10px;">
                  <button class="btn" id="btnUploadPdf" type="button">Upload</button>
                  <button class="btn" id="btnRefreshPdfs" type="button">Refresh PDF list</button>
                </div>
                <div class="small" id="uploadStatus" style="margin-top:8px;">No upload yet.</div>
              </div>

              <div class="field" style="margin:0;">
                <div class="labelRow">
                  <label>Chat session</label>
                  <span class="helpBtn" data-help="helpChatId">i</span>
                </div>
                <input id="chatId" type="text" placeholder="auto-generated chat id" />
                <div class="helpText" id="helpChatId">
                  This keeps conversation memory on the backend. Leave it as-is. If you change it, you start a new thread.
                </div>
                <div class="row tight" style="margin-top:10px;">
                  <button class="btn" id="btnNewChat" type="button">New chat</button>
                  <button class="btn danger" id="btnClearChatUI" type="button">Clear UI</button>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="panel">
          <div class="panelHead">Conversation</div>
          <div class="panelBody">
            <div class="chatWrap">
              <div class="chatBox" id="chatBox"></div>

              <div class="row">
                <div style="flex:1; min-width:240px;">
                  <textarea id="chatInput" rows="3" placeholder="Ask a question…"></textarea>
                  <div class="metaLine" id="chatMeta">Ready.</div>
                </div>
                <div style="flex:0; min-width:200px; display:flex; gap:10px; align-items:flex-start; justify-content:flex-end;">
                  <button class="btn primary" id="btnSend" type="button">Send</button>
                  <button class="btn" id="btnStop" type="button" disabled>Stop</button>
                </div>
              </div>

              <div class="small">
                If you ask for a numeric requirement (e.g., travel distance, stair width), your backend will only answer if it can ground the number in extracted TGD text.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FIRE CERT -->
      <section class="view" id="viewFireCert">
        <div class="hero">
          <h2>Fire Cert</h2>
          <p>
            This pulls your Fire Cert schema from <span class="mono">GET /firecert/schema</span>.
            Answers are saved to the backend per project and a report is generated.
          </p>
        </div>

        <div class="split">
          <div class="panel">
            <div class="panelHead">
              Wizard
              <span class="tag" id="fcProjectTag">Project: not started</span>
            </div>
            <div class="panelBody">
              <div class="row tight">
                <button class="btn primary" id="fcBtnInit" type="button">Start / Resume Project</button>
                <button class="btn" id="fcBtnRefresh" type="button">Refresh</button>
                <button class="btn danger" id="fcBtnReset" type="button">Reset Project</button>
              </div>

              <div class="small" style="margin-top:10px;">
                Your UI never prints JSON. It renders form fields. Everything is saved server-side.
              </div>

              <div class="panel" style="margin-top:12px;">
                <div class="panelHead" id="fcStepTitle">Loading…</div>
                <div class="panelBody" id="fcFormArea">
                  <div class="mono">Loading schema…</div>
                </div>
              </div>

              <div class="row tight" style="margin-top:12px;">
                <button class="btn" id="fcBack" type="button">Back</button>
                <button class="btn primary" id="fcNext" type="button">Next</button>
              </div>

              <div class="row tight" style="margin-top:10px;">
                <button class="btn primary" id="fcGenerateText" type="button">Generate Report (Preview)</button>
                <button class="btn primary" id="fcGenerateDocx" type="button">Generate DOCX</button>
              </div>

              <div class="small" style="margin-top:10px;">
                Preview uses <span class="mono">POST /firecert/generate-report</span>. DOCX uses <span class="mono">POST /firecert/generate</span> (if you added it).
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">Report Preview</div>
            <div class="panelBody">
              <textarea id="fcReportPreview" rows="22" placeholder="Your report will appear here…"></textarea>
              <div class="row tight" style="margin-top:10px;">
                <button class="btn" id="fcCopyReport" type="button">Copy</button>
              </div>
              <div class="small" style="margin-top:10px;">
                If you want “no JSON ever”, use the DOCX endpoint and auto-download the file.
              </div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const API_BASE = "https://complyr.onrender.com";
    document.getElementById("apiBaseLabel").textContent = API_BASE;

    function apiUrl(path){ return API_BASE.replace(/\/+$/,"") + path; }

    // =========================
    // TOAST
    // =========================
    const toast = document.getElementById("toast");
    let toastTimer = null;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 2800);
    }

    // =========================
    // NAV
    // =========================
    const viewTitle = document.getElementById("viewTitle");
    const viewHint = document.getElementById("viewHint");
    const views = {
      home: document.getElementById("viewHome"),
      chat: document.getElementById("viewChat"),
      fire: document.getElementById("viewFireCert")
    };
    function showView(which){
      Object.values(views).forEach(v=>v.classList.remove("show"));
      views[which].classList.add("show");
      if(which==="home"){ viewTitle.textContent="Overview"; viewHint.textContent="Quick start"; }
      if(which==="chat"){ viewTitle.textContent="Chat"; viewHint.textContent="Strict TGD assistant"; }
      if(which==="fire"){ viewTitle.textContent="Fire Cert"; viewHint.textContent="Questions → report"; fcInitOnce(); }
    }
    document.getElementById("navHome").onclick = ()=>showView("home");
    document.getElementById("navChat").onclick = ()=>showView("chat");
    document.getElementById("navFireCert").onclick = ()=>showView("fire");
    document.getElementById("goChat").onclick = ()=>showView("chat");
    document.getElementById("goFire").onclick = ()=>showView("fire");

    document.getElementById("btnDocs").onclick = ()=> window.open(apiUrl("/swagger"), "_blank");
    document.getElementById("btnStatus").onclick = async ()=>{
      try{
        const r = await fetch(apiUrl("/health"));
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok){ showToast("Status error"); return; }
        showToast(j.vertex_ready ? "Backend online (AI ready)" : "Backend online (AI not ready)");
      }catch(e){
        showToast("Backend unreachable (CORS/offline?)");
      }
    };

    // Help toggles
    document.addEventListener("click", (e)=>{
      const hb = e.target.closest(".helpBtn");
      if(!hb) return;
      const id = hb.getAttribute("data-help");
      if(!id) return;
      const el = document.getElementById(id);
      if(el) el.classList.toggle("show");
    });

    // =========================
    // CHAT (WORKING)
    // =========================
    const CHAT_ID_KEY = "raheem_chat_id_v1";
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const chatMeta = document.getElementById("chatMeta");
    const btnSend = document.getElementById("btnSend");
    const btnStop = document.getElementById("btnStop");
    const chatIdEl = document.getElementById("chatId");
    const forceDocsEl = document.getElementById("forceDocs");
    const pdfSelect = document.getElementById("pdfSelect");

    function newChatId(){
      return "chat_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function loadChatId(){
      let cid = localStorage.getItem(CHAT_ID_KEY);
      if(!cid){
        cid = newChatId();
        localStorage.setItem(CHAT_ID_KEY, cid);
      }
      chatIdEl.value = cid;
      return cid;
    }
    function setChatId(cid){
      localStorage.setItem(CHAT_ID_KEY, cid);
      chatIdEl.value = cid;
    }
    loadChatId();

    function addMsg(role, text){
      const wrap = document.createElement("div");
      wrap.className = "msg";
      const bub = document.createElement("div");
      bub.className = "bubble " + (role==="user" ? "user" : "assistant");
      bub.textContent = text;
      wrap.appendChild(bub);
      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
      return bub;
    }

    let aborter = null;

    async function refreshPdfs(){
      try{
        const r = await fetch(apiUrl("/pdfs"));
        const j = await r.json().catch(()=>({}));
        const list = (j.pdfs || []);
        // rebuild select
        pdfSelect.innerHTML = `<option value="">Auto-pick (recommended)</option>`;
        list.forEach(name=>{
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          pdfSelect.appendChild(opt);
        });
        showToast("PDF list updated (" + list.length + ")");
      }catch(e){
        showToast("Failed to load PDFs");
      }
    }
    document.getElementById("btnRefreshPdfs").onclick = refreshPdfs;
    refreshPdfs();

    document.getElementById("btnNewChat").onclick = ()=>{
      const cid = newChatId();
      setChatId(cid);
      showToast("New chat created");
    };

    document.getElementById("btnClearChatUI").onclick = ()=>{
      chatBox.innerHTML = "";
      showToast("Chat UI cleared (backend memory stays)");
    };

    // PDF upload
    document.getElementById("btnUploadPdf").onclick = async ()=>{
      const file = document.getElementById("pdfUpload").files?.[0];
      const statusEl = document.getElementById("uploadStatus");
      if(!file){ showToast("Choose a PDF first"); return; }

      try{
        statusEl.textContent = "Uploading…";
        const fd = new FormData();
        fd.append("file", file);
        const r = await fetch(apiUrl("/upload-pdf"), { method:"POST", body: fd });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok){
          statusEl.textContent = "Upload failed.";
          showToast("Upload failed");
          return;
        }
        statusEl.textContent = "Uploaded: " + (j.stored_as || file.name);
        showToast("PDF uploaded");
        await refreshPdfs();
      }catch(e){
        statusEl.textContent = "Upload error.";
        showToast("Upload error");
      }
    };

    function parseSseChunk(buffer){
      // returns array of {event, data}, and remaining buffer
      const out = [];
      let idx;
      while((idx = buffer.indexOf("\n\n")) !== -1){
        const block = buffer.slice(0, idx);
        buffer = buffer.slice(idx+2);
        let eventName = "";
        let data = "";
        block.split("\n").forEach(line=>{
          if(line.startsWith("event:")){
            eventName = line.slice(6).trim();
          } else if(line.startsWith("data:")){
            // server sends "data: xxx"
            data += (data ? "\n" : "") + line.slice(5).trimEnd();
          }
        });
        out.push({event: eventName || "message", data});
      }
      return {out, buffer};
    }

    async function sendChat(){
      const msg = (chatInput.value || "").trim();
      if(!msg) return;

      const chat_id = (chatIdEl.value || "").trim() || loadChatId();
      setChatId(chat_id);

      const force_docs = (forceDocsEl.value === "true");
      const pdf = (pdfSelect.value || "").trim() || null;

      addMsg("user", msg);
      chatInput.value = "";
      chatMeta.textContent = "Thinking…";
      btnSend.disabled = true;
      btnStop.disabled = false;

      const assistantBubble = addMsg("assistant", "");

      aborter = new AbortController();

      try{
        const payload = {
          chat_id,
          message: msg,
          force_docs,
          pdf
        };

        const r = await fetch(apiUrl("/chat_stream"), {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload),
          signal: aborter.signal
        });

        if(!r.ok){
          assistantBubble.textContent = "Error: backend returned HTTP " + r.status;
          chatMeta.textContent = "Error.";
          return;
        }

        const reader = r.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        let done = false;

        while(!done){
          const {value, done: rdDone} = await reader.read();
          if(rdDone) break;
          buffer += decoder.decode(value, {stream:true});
          const parsed = parseSseChunk(buffer);
          buffer = parsed.buffer;

          for(const evt of parsed.out){
            if(evt.event === "error"){
              assistantBubble.textContent += (assistantBubble.textContent ? "\n" : "") + evt.data;
              chatMeta.textContent = "Error.";
            } else if(evt.event === "done"){
              done = true;
              chatMeta.textContent = "Done.";
            } else {
              // normal streamed data tokens come as event "message" with data
              assistantBubble.textContent += evt.data;
              chatBox.scrollTop = chatBox.scrollHeight;
            }
          }
        }
      }catch(e){
        if(String(e).includes("AbortError")){
          assistantBubble.textContent += "\n\nStopped.";
          chatMeta.textContent = "Stopped.";
        }else{
          assistantBubble.textContent = "Network error. Check backend/CORS.";
          chatMeta.textContent = "Error.";
        }
      }finally{
        btnSend.disabled = false;
        btnStop.disabled = true;
        aborter = null;
      }
    }

    btnSend.onclick = sendChat;
    btnStop.onclick = ()=>{
      if(aborter) aborter.abort();
    };
    chatInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        sendChat();
      }
    });

    // =========================
    // FIRE CERT (BASIC WORKING UI)
    // =========================
    const FC_KEY = "raheem_firecert_project_v1";
    let fcInited = false;
    let fcSchema = null;
    let fcProjectId = null;
    let fcStepIndex = 0;

    const fcProjectTag = document.getElementById("fcProjectTag");
    const fcStepTitle = document.getElementById("fcStepTitle");
    const fcFormArea = document.getElementById("fcFormArea");
    const fcReportPreview = document.getElementById("fcReportPreview");

    function fcSaveLocal(){
      localStorage.setItem(FC_KEY, JSON.stringify({project_id: fcProjectId, step: fcStepIndex}));
    }
    function fcLoadLocal(){
      try{ return JSON.parse(localStorage.getItem(FC_KEY) || "{}"); }catch(e){ return {}; }
    }

    async function fcFetchSchema(){
      const r = await fetch(apiUrl("/firecert/schema"));
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok || !j.schema) throw new Error("Schema load failed");
      fcSchema = j.schema;
    }

    async function fcInitProject(){
      const local = fcLoadLocal();
      if(local.project_id){
        fcProjectId = local.project_id;
        fcStepIndex = Number.isFinite(local.step) ? local.step : 0;
        fcProjectTag.textContent = "Project: " + fcProjectId.slice(0,8) + "…";
        return;
      }
      const r = await fetch(apiUrl("/firecert/project/init"), {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({meta:{}})
      });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok || !j.project) throw new Error("Init failed");
      fcProjectId = j.project.project_id;
      fcStepIndex = 0;
      fcProjectTag.textContent = "Project: " + fcProjectId.slice(0,8) + "…";
      fcSaveLocal();
    }

    async function fcGetProject(){
      if(!fcProjectId) return null;
      const r = await fetch(apiUrl("/firecert/project?project_id="+encodeURIComponent(fcProjectId)));
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok || !j.project) return null;
      return j.project;
    }

    function fcMakeField(q, project){
      const qid = q.id;
      const label = q.label || qid;
      const help = q.help || "Fill in the value for your project.";

      const ans = project?.answers?.[qid] || null;
      const na = !!ans?.na;
      const value = ans?.value ?? null;
      const notes = ans?.notes ?? "";
      const refs = ans?.refs ?? "";

      const field = document.createElement("div");
      field.className = "field";

      const helpId = "fc_help_" + qid;

      const labelRow = document.createElement("div");
      labelRow.className = "labelRow";
      labelRow.innerHTML = `
        <label>${label}</label>
        <span class="helpBtn" data-help="${helpId}">i</span>
      `;
      field.appendChild(labelRow);

      const helpBox = document.createElement("div");
      helpBox.className = "helpText";
      helpBox.id = helpId;
      helpBox.textContent = help;
      field.appendChild(helpBox);

      let input;
      if(q.type === "bool"){
        input = document.createElement("select");
        input.innerHTML = `<option value=""></option><option value="true">Yes</option><option value="false">No</option>`;
        input.value = (value === true) ? "true" : (value === false) ? "false" : "";
      } else if(q.type === "select"){
        input = document.createElement("select");
        const opts = (q.options || []);
        input.innerHTML = `<option value=""></option>` + opts.map(o=>`<option value="${o}">${o}</option>`).join("");
        input.value = (value ?? "");
      } else if(q.type === "multiselect"){
        input = document.createElement("select");
        input.multiple = true;
        input.size = Math.min(8, Math.max(4, (q.options||[]).length || 4));
        input.innerHTML = (q.options || []).map(o=>`<option value="${o}">${o}</option>`).join("");
        const arr = Array.isArray(value) ? value : [];
        [...input.options].forEach(opt=> opt.selected = arr.includes(opt.value));
      } else if(q.type === "number"){
        input = document.createElement("input");
        input.type = "number";
        input.value = (value ?? "");
      } else {
        input = document.createElement("input");
        input.type = "text";
        input.value = (value ?? "");
      }

      input.disabled = na;
      field.appendChild(input);

      // NA + notes + refs + save
      const row = document.createElement("div");
      row.className = "row tight";
      row.style.marginTop = "10px";
      row.innerHTML = `
        <label class="small" style="display:flex; gap:8px; align-items:center; flex:0; min-width:180px;">
          <input type="checkbox" id="fc_na_${qid}" ${na ? "checked" : ""}/> Not applicable
        </label>
        <button class="btn" type="button" id="fc_save_${qid}">Save</button>
      `;
      field.appendChild(row);

      const extra = document.createElement("div");
      extra.style.marginTop = "10px";
      extra.innerHTML = `
        <div class="small" style="margin-bottom:6px;">Notes (optional)</div>
        <textarea id="fc_notes_${qid}" rows="2" placeholder="Assumptions / pending info…">${String(notes||"")}</textarea>
        <div class="small" style="margin:10px 0 6px 0;">Refs (optional)</div>
        <input id="fc_refs_${qid}" type="text" placeholder="e.g. TGD B Vol 1 Section X Table Y" value="${String(refs||"")}"/>
      `;
      field.appendChild(extra);

      // wiring
      field.querySelector("#fc_na_"+qid).addEventListener("change", (e)=>{
        const isNA = e.target.checked;
        input.disabled = isNA;
      });

      field.querySelector("#fc_save_"+qid).onclick = async ()=>{
        if(!fcProjectId){ showToast("Start a project first"); return; }

        const isNA = field.querySelector("#fc_na_"+qid).checked;
        let val = null;

        if(!isNA){
          if(q.type === "bool"){
            const v = String(input.value||"").trim();
            val = (v==="true") ? true : (v==="false") ? false : null;
          } else if(q.type === "multiselect"){
            val = [...input.selectedOptions].map(o=>o.value);
          } else if(q.type === "number"){
            const v = String(input.value||"").trim();
            val = v==="" ? null : Number(v);
            if(Number.isNaN(val)) val = null;
          } else {
            const v = String(input.value||"");
            val = v.trim()==="" ? null : v;
          }
        }

        const notesV = String(field.querySelector("#fc_notes_"+qid).value||"").trim();
        const refsV = String(field.querySelector("#fc_refs_"+qid).value||"").trim();

        const payload = { project_id: fcProjectId, qid, value: val, na: isNA, notes: notesV, refs: refsV };
        const r = await fetch(apiUrl("/firecert/answer"), {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok){
          showToast("Save failed");
          return;
        }
        showToast("Saved");
      };

      return field;
    }

    async function fcRenderStep(){
      if(!fcSchema){ return; }
      const steps = fcSchema.steps || [];
      const step = steps[fcStepIndex] || steps[0];
      if(!step){
        fcStepTitle.textContent = "No steps";
        fcFormArea.innerHTML = `<div class="mono">No schema steps found.</div>`;
        return;
      }
      fcStepTitle.textContent = step.title || step.id;

      const project = await fcGetProject();

      fcFormArea.innerHTML = "";
      (step.questions || []).forEach(q=>{
        fcFormArea.appendChild(fcMakeField(q, project));
      });
    }

    async function fcInitOnce(){
      if(fcInited) return;
      fcInited = true;

      try{
        await fcFetchSchema();
        const local = fcLoadLocal();
        if(local.project_id){
          fcProjectId = local.project_id;
          fcStepIndex = Number.isFinite(local.step) ? local.step : 0;
          fcProjectTag.textContent = "Project: " + fcProjectId.slice(0,8) + "…";
        }
        await fcRenderStep();
      }catch(e){
        fcFormArea.innerHTML = `<div class="mono">Fire Cert schema load failed. Check backend.</div>`;
      }
    }

    document.getElementById("fcBtnInit").onclick = async ()=>{
      try{
        await fcInitProject();
        await fcRenderStep();
        showToast("Project ready");
      }catch(e){
        showToast("Init failed");
      }
    };

    document.getElementById("fcBtnRefresh").onclick = async ()=>{
      await fcRenderStep();
      showToast("Refreshed");
    };

    document.getElementById("fcBtnReset").onclick = ()=>{
      localStorage.removeItem(FC_KEY);
      fcProjectId = null;
      fcStepIndex = 0;
      fcProjectTag.textContent = "Project: not started";
      showToast("Reset done");
    };

    document.getElementById("fcBack").onclick = async ()=>{
      if(!fcSchema) return;
      fcStepIndex = Math.max(0, fcStepIndex - 1);
      fcSaveLocal();
      await fcRenderStep();
    };

    document.getElementById("fcNext").onclick = async ()=>{
      if(!fcSchema) return;
      const max = (fcSchema.steps || []).length - 1;
      fcStepIndex = Math.min(max, fcStepIndex + 1);
      fcSaveLocal();
      await fcRenderStep();
    };

    document.getElementById("fcGenerateText").onclick = async ()=>{
      if(!fcProjectId){ showToast("Start a project first"); return; }
      try{
        showToast("Generating…");
        const r = await fetch(apiUrl("/firecert/generate-report"), {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ project_id: fcProjectId })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok){ showToast("Generate failed"); return; }
        fcReportPreview.value = (j.report || "");
        showToast("Report ready");
      }catch(e){
        showToast("Generate error");
      }
    };

    // DOCX: only works if your backend has POST /firecert/generate returning a file
    document.getElementById("fcGenerateDocx").onclick = async ()=>{
      if(!fcProjectId){ showToast("Start a project first"); return; }
      try{
        showToast("Generating DOCX…");
        const r = await fetch(apiUrl("/firecert/generate"), {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ project_id: fcProjectId })
        });
        if(!r.ok){
          showToast("DOCX endpoint missing or error");
          return;
        }
        const blob = await r.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "Fire_Safety_Report_Draft.docx";
        a.click();
        URL.revokeObjectURL(a.href);
        showToast("Downloaded");
      }catch(e){
        showToast("DOCX error");
      }
    };

    document.getElementById("fcCopyReport").onclick = ()=>{
      const t = fcReportPreview.value || "";
      if(!t.trim()){ showToast("No report to copy"); return; }
      navigator.clipboard.writeText(t).then(()=>showToast("Copied")).catch(()=>showToast("Copy failed"));
    };

    // default
    showView("home");
  </script>
</body>
</html>
