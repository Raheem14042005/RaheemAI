<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raheem AI</title>

  <meta name="description" content="Raheem AI â€” compliance-first chat and document reasoning for building workflows." />
  <meta name="theme-color" content="#060713" />
  <meta property="og:title" content="Raheem AI" />
  <meta property="og:description" content="Compliance-first chat and document reasoning for building workflows." />
  <meta property="og:type" content="website" />

  <style>
    :root{
      --bg0:#060713;
      --bg1:#070a1a;
      --bg2:#0b1030;

      --glass: rgba(255,255,255,.07);
      --glass2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.12);

      --text:#f4f7ff;
      --muted: rgba(244,247,255,.78);
      --muted2: rgba(244,247,255,.58);

      --a1:#50ffd7;
      --a2:#65b7ff;
      --a3:#c7a5ff;
      --hot:#ff4fd8;
      --ok: rgba(80,255,215,.45);
      --warn: rgba(255,204,102,.42);
      --bad: rgba(255,79,216,.44);

      --shadow: 0 28px 72px rgba(0,0,0,.58);
      --shadow2: 0 18px 48px rgba(0,0,0,.42);

      --r:24px;
      --r2:18px;

      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;

      --neon1: 0 0 18px rgba(80,255,215,.10), 0 0 40px rgba(101,183,255,.10);
      --neon2: 0 0 18px rgba(255,79,216,.12), 0 0 42px rgba(199,165,255,.08);

      --btnPad: 10px 12px;

      --headerH: 72px;
      --railW: 84px;
      --drawerW: 360px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(80,255,215,.15), transparent 60%),
        radial-gradient(1100px 650px at 85% 0%, rgba(101,183,255,.16), transparent 58%),
        radial-gradient(900px 620px at 50% 115%, rgba(199,165,255,.14), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 38%, var(--bg2));
      overflow-x:hidden;
    }

    /* ====== BACKGROUND FX ====== */
    .bg-wrap{ position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
    .aurora{
      position:absolute; inset:-25%;
      background:
        radial-gradient(980px 560px at 12% 18%, rgba(80,255,215,.16) 0%, rgba(80,255,215,0) 64%),
        radial-gradient(980px 560px at 88% 14%, rgba(101,183,255,.16) 0%, rgba(101,183,255,0) 62%),
        radial-gradient(1080px 620px at 50% 108%, rgba(199,165,255,.14) 0%, rgba(199,165,255,0) 60%),
        radial-gradient(860px 520px at 45% 42%, rgba(255,79,216,.07) 0%, rgba(255,79,216,0) 60%);
      filter: blur(22px);
      opacity:.85;
      transform: translate3d(0,0,0);
      animation: auroraMove 22s ease-in-out infinite;
    }
    @keyframes auroraMove{
      0%,100%{ transform: translate3d(0,0,0) scale(1); }
      45%{ transform: translate3d(16px,-12px,0) scale(1.02); }
      75%{ transform: translate3d(-14px,12px,0) scale(1.015); }
    }
    canvas#particles{ position:absolute; inset:0; opacity:.16; filter: blur(.2px); }
    .vignette{
      position:absolute; inset:-1px;
      background:
        radial-gradient(900px 520px at 50% 18%, rgba(0,0,0,0), rgba(0,0,0,.62));
      opacity:.9;
    }
    @media (prefers-reduced-motion: reduce){
      .aurora{ animation:none; }
      canvas#particles{ display:none; }
      .shine{ display:none; }
    }

    /* ====== APP SHELL ====== */
    .shell{
      position:relative;
      z-index:1;
      min-height:100vh;
      display:grid;
      grid-template-rows: var(--headerH) 1fr;
    }

    /* ====== HEADER ====== */
    header{
      height: var(--headerH);
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(0,0,0,.46), rgba(0,0,0,.16));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .headerInner{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 12px 14px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .brandRow{ display:flex; align-items:center; gap: 12px; min-width:0; }
    .logoMark{
      width: 46px; height:46px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      box-shadow: var(--neon1);
      display:grid; place-items:center;
      overflow:hidden;
      position:relative;
      flex-shrink:0;
    }
    .logoMark svg{ width:38px; height:38px; opacity:.95; }
    .brandText{ min-width:0; }
    .brandText .name{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .5px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .name span{
      background: linear-gradient(90deg, var(--a1), var(--a2), var(--a3));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 18px rgba(101,183,255,.12);
    }
    .brandText .sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .headerCenter{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:center;
      min-width: 0;
    }

    .navPills{
      display:flex;
      gap: 8px;
      align-items:center;
      padding: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 0 0 1px rgba(0,0,0,.10) inset;
      overflow:auto;
      scrollbar-width:none;
    }
    .navPills::-webkit-scrollbar{ display:none; }

    .navpill{
      border: 1px solid transparent;
      background: transparent;
      color: rgba(244,247,255,.92);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap: 8px;
      transition: background .15s ease, transform .15s ease, border-color .15s ease, box-shadow .15s ease;
      white-space:nowrap;
    }
    .navpill:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.06);
      border-color: rgba(101,183,255,.28);
      box-shadow: var(--neon1);
    }
    .navpill.active{
      background: linear-gradient(135deg, rgba(80,255,215,.16), rgba(101,183,255,.10));
      border-color: rgba(80,255,215,.34);
      box-shadow: var(--neon1);
    }
    .navpill .dot{
      width: 8px; height:8px; border-radius:999px; background: rgba(244,247,255,.28);
    }
    .navpill.active .dot{
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.0) 60%),
                  linear-gradient(90deg, var(--a1), var(--a2));
      box-shadow: 0 0 12px rgba(80,255,215,.16);
    }

    .headerRight{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .tag{
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
      user-select:none;
    }
    .tag.live{ border-color: var(--ok); color: rgba(230,255,240,.92); background: rgba(80,255,215,.10); }
    .tag.warn{ border-color: var(--warn); color: rgba(255,235,200,.95); background: rgba(255,204,102,.10); }
    .tag.bad{  border-color: var(--bad);  color: rgba(255,215,242,.95); background: rgba(255,79,216,.10); }

    .btn{
      padding: var(--btnPad);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
      font-weight: 900;
      font-size: 13px;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.36);
      background: rgba(255,255,255,.10);
      box-shadow: var(--neon1);
    }
    .btn.primary{
      border-color: rgba(80,255,215,.34);
      background: linear-gradient(135deg, rgba(80,255,215,.18), rgba(101,183,255,.10));
      box-shadow: var(--neon1);
    }
    .btn.ghost{ background: rgba(0,0,0,.18); }

    .iconBtn{
      width:44px; height:44px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(244,247,255,.92);
      cursor:pointer;
      display:grid; place-items:center;
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
      font-weight: 950;
      line-height:1;
      user-select:none;
    }
    .iconBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.36);
      background: rgba(255,255,255,.08);
      box-shadow: var(--neon1);
    }
    .iconBtn.danger{
      border-color: rgba(255,79,216,.30);
      background: rgba(255,79,216,.08);
    }
    .iconBtn.danger:hover{
      border-color: rgba(255,79,216,.48);
      background: rgba(255,79,216,.12);
      box-shadow: var(--neon2);
    }

    /* ====== MAIN GRID ====== */
    .gridWrap{
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      padding: 14px;
      display:grid;
      grid-template-columns: var(--railW) 1fr;
      gap: 14px;
      align-items: start;
    }

    /* Left Rail (icon-only) */
    .rail{
      position:sticky;
      top: calc(var(--headerH) + 14px);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius: var(--r);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .rail .railInner{
      display:flex;
      flex-direction:column;
      padding: 10px;
      gap: 10px;
    }
    .railBtn{
      width:100%;
      border-radius: 18px;
      padding: 12px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(244,247,255,.92);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
      display:grid;
      place-items:center;
      position:relative;
    }
    .railBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.28);
      box-shadow: var(--neon1);
      background: rgba(255,255,255,.10);
    }
    .railBtn.active{
      border-color: rgba(80,255,215,.34);
      background: linear-gradient(135deg, rgba(80,255,215,.14), rgba(101,183,255,.08));
      box-shadow: var(--neon1);
    }
    .railBtn .hint{
      position:absolute;
      left: calc(100% + 10px);
      top: 50%;
      transform: translateY(-50%);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      font-size: 12px;
      color: rgba(244,247,255,.92);
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .12s ease;
    }
    .railBtn:hover .hint{ opacity: 1; }

    /* Main Surface */
    .surface{
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
      min-height: calc(100vh - var(--headerH) - 28px);
    }

    .shine{
      position:absolute;
      inset:-2px;
      pointer-events:none;
      background:
        radial-gradient(600px 220px at 20% 0%, rgba(80,255,215,.10), transparent 65%),
        radial-gradient(600px 220px at 80% 0%, rgba(101,183,255,.08), transparent 65%),
        radial-gradient(600px 260px at 50% 110%, rgba(199,165,255,.08), transparent 65%);
      opacity:.7;
      filter: blur(10px);
    }

    .surfaceTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      position:relative;
      z-index:1;
    }

    .crumb{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 0;
    }
    .crumb .title{
      font-weight: 950;
      letter-spacing:.2px;
      font-size: 16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .crumb .hint{
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .surfaceActions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .view{ display:none; padding: 18px; position:relative; z-index:1; }
    .view.show{ display:block; }

    /* ====== HOME (marketing + product) ====== */
    .hero{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(1100px 360px at 16% 0%, rgba(80,255,215,.14), transparent 65%),
        radial-gradient(1100px 360px at 88% 0%, rgba(101,183,255,.12), transparent 62%),
        rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
      overflow:hidden;
      padding: 18px;
      position:relative;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(520px 220px at 28% 0%, rgba(80,255,215,.12), transparent 60%),
        radial-gradient(520px 220px at 72% 0%, rgba(101,183,255,.10), transparent 60%),
        radial-gradient(560px 240px at 50% 120%, rgba(255,79,216,.06), transparent 60%);
      opacity:.65;
      filter: blur(12px);
      pointer-events:none;
    }
    .heroHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    .hero h2{
      margin:0;
      font-size: 26px;
      letter-spacing:.2px;
      line-height:1.15;
    }
    .hero p{
      margin:10px 0 0 0;
      color: var(--muted);
      max-width: 980px;
      line-height:1.55;
      position:relative;
      z-index:1;
      font-size: 14px;
    }
    .heroBadges{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .quote{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(244,247,255,.92);
      line-height:1.45;
      position:relative;
      z-index:1;
    }
    .heroCTA{
      margin-top: 14px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .split{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 1060px){
      .split{ grid-template-columns: 1fr; }
    }

    .panel{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panelHead{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .panelHead .t{
      font-weight: 950;
      letter-spacing:.25px;
      font-size: 13px;
      text-transform: uppercase;
      color: rgba(244,247,255,.82);
    }
    .panelBody{ padding: 14px; }
    .statRow{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 600px){
      .statRow{ grid-template-columns: 1fr; }
    }
    .stat{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px;
      min-height: 86px;
      position:relative;
      overflow:hidden;
    }
    .stat::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(220px 120px at 20% 0%, rgba(80,255,215,.10), transparent 60%),
        radial-gradient(220px 120px at 80% 0%, rgba(101,183,255,.08), transparent 60%);
      opacity:.7;
      filter: blur(12px);
      pointer-events:none;
    }
    .stat .k{ position:relative; z-index:1; font-size: 12px; color: var(--muted2); font-weight:900; }
    .stat .v{ position:relative; z-index:1; margin-top:8px; font-size: 18px; font-weight: 950; }
    .stat .s{ position:relative; z-index:1; margin-top:6px; font-size: 12px; color: var(--muted2); line-height:1.3; }

    .featureGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 980px){ .featureGrid{ grid-template-columns: 1fr; } }

    .card{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 170px;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(380px 180px at 10% 0%, rgba(80,255,215,.08), transparent 60%),
        radial-gradient(380px 180px at 90% 0%, rgba(101,183,255,.06), transparent 60%);
      opacity:.65;
      filter: blur(14px);
      pointer-events:none;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(101,183,255,.22);
      box-shadow: var(--shadow2), var(--neon1);
    }
    .cardhead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      position:relative;
      z-index:1;
    }
    .cardtitle{ display:flex; gap: 12px; align-items:flex-start; }
    .icon{
      width: 44px; height: 44px; border-radius: 16px;
      display:grid; place-items:center;
      font-weight: 950;
      letter-spacing:.4px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(80,255,215,.14), rgba(101,183,255,.10), rgba(199,165,255,.08));
      box-shadow: var(--neon1);
      user-select:none;
      flex-shrink:0;
    }
    .card h4{ margin:0; font-size: 15px; position:relative; z-index:1; }
    .card p{ margin:6px 0 0 0; color: var(--muted); line-height:1.5; position:relative; z-index:1; }
    .pill{
      font-size: 11px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
      align-self:flex-start;
      user-select:none;
      position:relative;
      z-index:1;
    }
    .pill.live{ border-color: rgba(80,255,215,.38); background: rgba(80,255,215,.10); color: rgba(230,255,240,.92); }
    .cta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top:auto;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .li{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .li b{ font-weight: 950; }
    .li .s{ margin-top:4px; color: var(--muted2); font-size: 12px; line-height:1.35; }
    .li .badge{
      margin-left:auto;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(244,247,255,.86);
      font-size: 11px;
      white-space:nowrap;
      user-select:none;
      flex-shrink:0;
    }

    /* ====== CHAT (full product feel) ====== */
    .chatShell{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 1100px){
      .chatShell{ grid-template-columns: 1fr; }
    }

    .chatwrap{
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 620px;
      height: calc(100vh - var(--headerH) - 210px);
    }
    @media (max-width: 700px){
      .chatwrap{ height: calc(100vh - var(--headerH) - 240px); }
    }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }

    .toggle{
      display:flex; align-items:center; gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .toggle:hover{
      border-color: rgba(101,183,255,.28);
      box-shadow: 0 0 0 3px rgba(101,183,255,.08);
    }
    .toggle input{ transform: translateY(1px); }

    .chatbox{
      flex:1;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      padding: 14px;
      overflow:auto;
      scroll-behavior:smooth;
      box-shadow: var(--shadow2);
    }

    .msg{
      max-width: 78%;
      padding: 12px 12px;
      border-radius: 18px;
      margin: 10px 0;
      line-height:1.55;
      border: 1px solid rgba(255,255,255,.12);
      white-space: pre-wrap;
      word-wrap: break-word;
      position:relative;
    }
    .msg.user{
      margin-left:auto;
      background: linear-gradient(135deg, rgba(80,255,215,.18), rgba(101,183,255,.12));
      border-color: rgba(80,255,215,.30);
      box-shadow: 0 0 14px rgba(80,255,215,.06);
    }
    .msg.ai{
      background: rgba(255,255,255,.06);
    }

    .msgTools{
      margin-top: 8px;
      display:flex; gap: 8px; flex-wrap:wrap;
      opacity:.95;
    }
    .miniBtn{
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(244,247,255,.92);
      cursor:pointer;
      font-size: 12px;
      font-weight: 900;
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
    }
    .miniBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.36);
      background: rgba(0,0,0,.28);
      box-shadow: var(--neon1);
    }

    .typing{
      display:inline-flex; align-items:center; gap:8px;
      color: var(--muted2);
      font-size: 12px;
      margin-top: 6px;
      user-select:none;
    }
    .dots{ display:inline-flex; gap:4px; transform: translateY(1px); }
    .dot{
      width:6px;height:6px;border-radius:999px;
      background: rgba(244,247,255,.55);
      animation: bounce 1.1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .12s; }
    .dot:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{
      0%, 80%, 100%{ transform: translateY(0); opacity:.55; }
      40%{ transform: translateY(-4px); opacity:1; }
    }

    .composer{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    textarea{
      flex:1;
      min-height: 46px;
      max-height: 170px;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      line-height:1.45;
    }
    textarea:focus{
      border-color: rgba(101,183,255,.40);
      box-shadow: 0 0 0 3px rgba(101,183,255,.12);
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      border-radius: 10px;
      padding: 2px 8px;
      color: rgba(244,247,255,.92);
    }

    /* ====== RIGHT INFO PANEL ====== */
    .sideInfo{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:sticky;
      top: calc(var(--headerH) + 14px);
    }
    .sideInfo .head{
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .sideInfo .head .t{
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.25px;
      text-transform: uppercase;
      color: rgba(244,247,255,.82);
    }
    .sideInfo .body{ padding: 14px; }
    .muted{ color: var(--muted2); font-size: 12px; line-height:1.45; }
    .pillRow{ display:flex; gap: 8px; flex-wrap:wrap; margin-top: 10px; }

    /* ====== SAVED CHATS (drawer panel) ====== */
    .chatlist{
      display:none;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:fixed;
      top: calc(var(--headerH) + 14px);
      left: calc((100vw - 1400px)/2 + var(--railW) + 14px); /* align with content */
      width: min(var(--drawerW), calc(100vw - 28px));
      max-height: calc(100vh - var(--headerH) - 28px);
      z-index: 50;
    }
    /* if viewport narrower than max container, align to left margin */
    @media (max-width: 1430px){
      .chatlist{
        left: calc(14px + var(--railW) + 14px);
      }
    }
    .chatlist.show{ display:block; animation: slideIn .14s ease; }
    @keyframes slideIn{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .chatlistTop{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .chatlistTop .t{
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.25px;
      text-transform: uppercase;
      color: rgba(244,247,255,.84);
    }

    .chatSearch{ padding: 10px 14px 12px 14px; }
    .chatSearch input{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
    }
    .chatSearch input:focus{
      border-color: rgba(101,183,255,.40);
      box-shadow: 0 0 0 3px rgba(101,183,255,.12);
    }

    .chatItemsScroll{
      padding: 0 14px 14px 14px;
      overflow:auto;
      max-height: calc(100vh - var(--headerH) - 28px - 140px);
    }

    .chatitem{
      width:100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: var(--text);
      cursor:pointer;
      margin-bottom: 10px;
      transition: border-color .15s ease, transform .15s ease, background .15s ease, box-shadow .15s ease;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      position:relative;
    }
    .chatitem:hover{
      transform: translateY(-1px);
      border-color: rgba(80,255,215,.26);
      background: rgba(0,0,0,.20);
      box-shadow: 0 0 18px rgba(80,255,215,.06);
    }
    .chatitem.active{
      border-color: rgba(101,183,255,.34);
      background: rgba(0,0,0,.22);
      box-shadow: 0 0 18px rgba(101,183,255,.06);
    }
    .chatitem .metaWrap{ min-width:0; flex:1; }
    .chatitem .t{ font-weight:950; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chatitem .s{ margin-top:5px; font-size: 11px; color: var(--muted2); display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .chip{
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(244,247,255,.86);
      user-select:none;
    }

    /* Dropdown menu */
    .menu{
      position:absolute;
      right:10px;
      top:44px;
      min-width: 210px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,12,24,.92);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      display:none;
      z-index: 60;
    }
    .menu.show{ display:block; animation: menuPop .12s ease; }
    @keyframes menuPop{
      from{ transform: translateY(-6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .menu button{
      width:100%;
      border:0;
      background: transparent;
      color: rgba(244,247,255,.92);
      padding: 10px 12px;
      text-align:left;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .menu button:hover{ background: rgba(255,255,255,.06); }
    .menu .sep{ height:1px; background: rgba(255,255,255,.10); }

    /* ====== FOOTER ====== */
    .footer{
      margin-top: 16px;
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      background: rgba(0,0,0,.10);
      border-radius: 18px;
    }
    .copy{ color: rgba(244,247,255,.78); }

    /* ====== TOAST ====== */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 90;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color: rgba(244,247,255,.95);
      box-shadow: var(--shadow2);
      display:none;
      max-width: min(820px, calc(100vw - 26px));
      line-height:1.45;
    }
    .toast.show{ display:block; animation: pop .18s ease; }
    @keyframes pop{
      from{ transform: translateX(-50%) translateY(8px); opacity:0; }
      to{ transform: translateX(-50%) translateY(0); opacity:1; }
    }
    .toastRow{
      display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap:wrap;
    }
    .toastActions{ display:flex; gap: 8px; }
    .toastActions button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(244,247,255,.95);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 900;
    }
    .toastActions button:hover{ box-shadow: var(--neon1); border-color: rgba(101,183,255,.32); }

    /* ====== NBS BUILD-UP WIZARD ====== */
    .wizardLayout{
      display:grid;
      grid-template-columns: minmax(240px, 320px) 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .wizardLayout{ grid-template-columns: 1fr; }
    }
    .wizardPanel{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
      padding: 14px;
    }
    .wizardPanel h3{
      margin: 0 0 10px 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .3px;
    }
    .wizardList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .wizardList .item{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .wizardMain h3{
      margin-top:0;
      font-size: 16px;
    }
    .wizardField{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 12px;
    }
    .wizardField label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .wizardField input,
    .wizardField select,
    .wizardField textarea{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.2);
      color: var(--text);
      padding: 10px 12px;
      font-size: 13px;
      font-family: var(--font);
    }
    .wizardField textarea{ min-height: 90px; resize: vertical; }
    .wizardRow{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 700px){
      .wizardRow{ grid-template-columns: 1fr; }
    }
    .wizardActions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .layerCard{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 10px;
      margin-bottom: 10px;
    }
    .layerCard header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size: 12px;
      color: var(--muted2);
      margin-bottom: 8px;
    }
    .layerControls{
      display:flex;
      gap: 6px;
    }
    .layerControls button{
      padding: 6px 8px;
      font-size: 11px;
    }
    .reviewCard{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.2);
      padding: 12px;
      font-size: 12px;
      color: var(--muted);
      white-space: pre-wrap;
    }

    /* ====== MODAL ====== */
    .modalOverlay{
      position:fixed; inset:0;
      display:none;
      z-index:100;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      padding: 18px;
    }
    .modalOverlay.show{ display:grid; place-items:center; }
    .modal{
      width: min(980px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,12,24,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 200px at 20% 0%, rgba(80,255,215,.12), transparent 60%),
        radial-gradient(520px 200px at 80% 0%, rgba(101,183,255,.10), transparent 60%);
      filter: blur(12px);
      opacity:.6;
      pointer-events:none;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      position:relative; z-index:1;
    }
    .modalTitle{ font-weight: 950; letter-spacing:.2px; }
    .modalBody{
      padding: 14px 16px;
      color: rgba(244,247,255,.9);
      line-height:1.55;
      max-height: min(70vh, 560px);
      overflow:auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      position:relative; z-index:1;
    }
    .modalFoot{
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      position:relative; z-index:1;
    }

    :focus-visible{
      outline: 3px solid rgba(101,183,255,.20);
      outline-offset: 2px;
      border-radius: 14px;
    }

    /* Status pulse when online */
    .tag.live{ position: relative; }
    .tag.live::after{
      content:"";
      position:absolute; inset:-3px;
      border-radius:999px;
      border:1px solid rgba(80,255,215,.22);
      opacity:0;
      animation: pulse 2.2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform:scale(1); opacity:0; }
      25%{ opacity:.55; }
      70%{ transform:scale(1.12); opacity:0; }
      100%{ transform:scale(1.12); opacity:0; }
    }

    /* Mobile tweaks */
    @media (max-width: 860px){
      .gridWrap{ grid-template-columns: 1fr; }
      .rail{ position:relative; top:auto; }
      .rail .railInner{ flex-direction:row; justify-content:space-between; }
      .railBtn .hint{ display:none; }
      .chatlist{ left: 14px; }
    }
  </style>
</head>

<body>
  <div class="bg-wrap">
    <div class="aurora"></div>
    <canvas id="particles"></canvas>
    <div class="vignette"></div>
  </div>

  <div class="shell">
    <!-- ====== HEADER ====== -->
    <header>
      <div class="headerInner">
        <div class="brandRow">
          <div class="logoMark" aria-hidden="true">
            <svg viewBox="0 0 64 64" fill="none">
              <defs>
                <linearGradient id="g1" x1="6" y1="10" x2="58" y2="54" gradientUnits="userSpaceOnUse">
                  <stop stop-color="#50FFD7"/>
                  <stop offset="0.55" stop-color="#65B7FF"/>
                  <stop offset="1" stop-color="#C7A5FF"/>
                </linearGradient>
                <filter id="glow" x="-40%" y="-40%" width="180%" height="180%">
                  <feGaussianBlur stdDeviation="2.4" result="b"/>
                  <feMerge>
                    <feMergeNode in="b"/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
              </defs>
              <path filter="url(#glow)" d="M14 50V14h18c8 0 14 6 14 14 0 6-3 10-8 12l10 10h-10l-9-9H24v9H14Zm10-27h8c3 0 5 2 5 5s-2 5-5 5h-8V23Z" fill="url(#g1)" opacity="0.95"/>
              <path filter="url(#glow)" d="M48 50l-5-12h8l5 12h-8Z" fill="#FF4FD8" opacity="0.7"/>
            </svg>
          </div>
          <div class="brandText">
            <div class="name"><span>Raheem AI</span></div>
            <div class="sub">Compliance-first chat & document reasoning</div>
          </div>
        </div>

        <!-- Center: premium pill nav -->
        <div class="headerCenter">
          <div class="navPills" aria-label="Primary navigation">
            <!-- Keep these IDs for JS -->
            <button class="navpill active" id="navHome" type="button" aria-label="Go to Overview">
              <span class="dot" aria-hidden="true"></span> Overview
            </button>
            <button class="navpill" id="navChat" type="button" aria-label="Go to Chat">
              <span class="dot" aria-hidden="true"></span> Chat
            </button>
            <button class="navpill" id="navTools" type="button" aria-label="Go to Tools">
              <span class="dot" aria-hidden="true"></span> Tools
            </button>
            <!-- All features now live on the main page -->
          </div>
        </div>

        <div class="headerRight">
          <span class="tag warn" id="apiPill">Checkingâ€¦</span>
          <button class="btn" id="btnStatus" type="button" title="Backend status details">Status</button>
          <button class="btn ghost" id="btnShortcuts" type="button" title="Keyboard shortcuts">Shortcuts</button>
        </div>
      </div>
    </header>

    <!-- ====== CONTENT GRID ====== -->
    <div class="gridWrap">
      <!-- Icon Rail (secondary feel, super premium) -->
      <aside class="rail" aria-label="Quick actions rail">
        <div class="railInner">
          <!-- We keep the same nav IDs already in header; rail buttons just call showView via JS by clicking those -->
          <button class="railBtn active" type="button" onclick="document.getElementById('navHome').click()">
            âœ¦ <span class="hint">Overview</span>
          </button>
          <button class="railBtn" type="button" onclick="document.getElementById('navChat').click()">
            ðŸ’¬ <span class="hint">Chat</span>
          </button>
          <button class="railBtn" type="button" onclick="document.getElementById('navTools').click()">
            ðŸ§° <span class="hint">Tools</span>
          </button>
          <!-- All features now live on the main page -->
        </div>
      </aside>

      <!-- Main Surface -->
      <main class="surface">
        <div class="shine"></div>

        <div class="surfaceTop">
          <div class="crumb">
            <div class="title" id="viewTitle">Overview</div>
            <div class="hint" id="viewHint">Product summary and quick start</div>
          </div>
          <div class="surfaceActions">
            <button class="btn primary" id="btnStartChat" type="button">Open Chat</button>
            <button class="btn" id="btnOpenTools" type="button">Open Tools</button>
          </div>
        </div>

        <!-- ====== HOME ====== -->
        <section class="view show" id="viewHome">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Build faster. Stay compliant. Ship cleaner submissions.</h2>
                <p>
                  Raheem AI is a compliance-first assistant built for real building workflows: Irish TGDs, Planning logic, Fire/DAC reporting,
                  specs, and energy performanceâ€”without the messy outputs.
                </p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Compliance-first</span>
                <span class="tag">Citations-ready</span>
                <span class="tag">Workflow tools</span>
              </div>
            </div>

            <div class="quote">
              <b>What makes it sellable:</b> consistent structure, traceable evidence (when needed), and purpose-built tools (Fire, DAC, Specs, BER).
            </div>

            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="document.getElementById('navChat').click()">Start a chat</button>
              <button class="btn" type="button" onclick="document.getElementById('navTools').click()">Explore tools</button>
              <span class="muted">Tip: press <span class="kbd">/</span> to jump into Chat.</span>
            </div>
          </div>

          <div class="split">
            <!-- Left: Core modules (sellable) -->
            <div class="panel">
              <div class="panelHead">
                <div class="t">Core modules</div>
                <span class="tag">Product suite</span>
              </div>
              <div class="panelBody">
                <div class="featureGrid">
                  <article class="card">
                    <div class="cardhead">
                      <div class="cardtitle">
                        <div class="icon">AI</div>
                        <div>
                          <h4>TGD & Planning Copilot</h4>
                          <p>Ask project-specific questions in plain language. Evidence mode for stricter answers and clause references.</p>
                        </div>
                      </div>
                      <span class="pill live">Live</span>
                    </div>
                    <div class="cta">
                      <span class="pill">Saved sessions</span>
                      <button class="btn primary" type="button" onclick="document.getElementById('navChat').click()">Open chat</button>
                    </div>
                  </article>

                  <article class="card">
                    <div class="cardhead">
                      <div class="cardtitle">
                        <div class="icon">ðŸ§°</div>
                        <div>
                          <h4>Generators</h4>
                          <p>Fire Cert, DAC, Specs, BER workflows â€” guided inputs â†’ structured outputs ready for review.</p>
                        </div>
                      </div>
                      <span class="pill">Starter</span>
                    </div>
                    <div class="cta">
                      <span class="pill">Questionnaires</span>
                      <button class="btn" type="button" onclick="document.getElementById('navTools').click()">Open</button>
                    </div>
                  </article>
                </div>

                <div style="margin-top:12px" class="statRow">
                  <div class="stat">
                    <div class="k">Output style</div>
                    <div class="v">Structured</div>
                    <div class="s">Report-ready, consistent formatting.</div>
                  </div>
                  <div class="stat">
                    <div class="k">Evidence mode</div>
                    <div class="v">On-demand</div>
                    <div class="s">Use when you need traceability.</div>
                  </div>
                  <div class="stat">
                    <div class="k">Design feedback</div>
                    <div class="v">Practical</div>
                    <div class="s">Red flags + fix suggestions.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right: â€œWhat youâ€™re building nextâ€ (your list, productized) -->
            <div class="panel">
              <div class="panelHead">
                <div class="t">Available now</div>
                <span class="tag live">Preview access</span>
              </div>
              <div class="panelBody">
                <div class="list">
                  <div class="li">
                    <div>
                      <b>TGD Smart Checker</b>
                      <div class="s">Upload a plan or describe a scheme â†’ instant red flags, mapped to correct TGD parts.</div>
                    </div>
                    <span class="badge">Available</span>
                  </div>
                  <div class="li">
                    <div>
                      <b>Submission Pack Builder</b>
                      <div class="s">Fire + DAC outputs â†’ combined bundle with drawing index + cover letter templates.</div>
                    </div>
                    <span class="badge">Available</span>
                  </div>
                  <div class="li">
                    <div>
                      <b>Design Debate Room</b>
                      <div class="s">Two AIs argue for/against (sprinklers vs passive etc.) and converge on best choice.</div>
                    </div>
                    <span class="badge">Available</span>
                  </div>
                  <div class="li">
                    <div>
                      <b>Revit-first Layout Generator</b>
                      <div class="s">Areas + adjacencies â†’ native rooms/walls/doors + reg-aware hints in-model.</div>
                    </div>
                    <span class="badge">Available</span>
                  </div>
                </div>

                <div class="footer" style="margin-top:14px;">
                  <div class="copy">Â© 2026 Raheem AI. All rights reserved.</div>
                  <div>Built by Abdulraheem Hayder Ahmed</div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Platform modules</div>
              <span class="tag live">Main suite</span>
            </div>
            <div class="panelBody">
              <div class="featureGrid">
                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">SC</div>
                      <div>
                        <h4>TGD Smart Checker</h4>
                        <p>Upload a plan or describe a scheme. Get red flags, likely non-compliances, and fix suggestions mapped to TGDs.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Compliance</span>
                    <button
                      class="btn primary"
                      data-module="tgd-smart-checker"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">FCS</div>
                      <div>
                        <h4>Fire Safety Certificate Generator (Non-dwellings)</h4>
                        <p>TGD B questionnaire that produces a structured Fire Safety Certificate report and submission checklist.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Fire</span>
                    <button
                      class="btn primary"
                      data-module="fire-safety-cert"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">DAC</div>
                      <div>
                        <h4>Disability Access Certificate (DAC) Generator</h4>
                        <p>TGD M questionnaire capturing access strategy details with risk highlights and a DAC report draft.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Access</span>
                    <button
                      class="btn primary"
                      data-module="dac-generator"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">PK</div>
                      <div>
                        <h4>Submission Pack Builder</h4>
                        <p>Combine Fire + DAC outputs into a ready-to-submit bundle with report, drawing index, and cover letters.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Docs</span>
                    <button
                      class="btn primary"
                      data-module="submission-pack"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">DB</div>
                      <div>
                        <h4>Design Debate Room</h4>
                        <p>Two AIs argue for/against design options, then converge on a recommended choice with reasoning.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Decision</span>
                    <button
                      class="btn primary"
                      data-module="design-debate"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">SIM</div>
                      <div>
                        <h4>â€œWhat-Ifâ€ Reg Simulator</h4>
                        <p>Change height, area, occupancy, or use and see Fire, DAC, Planning, and energy impacts shift.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Simulator</span>
                    <button
                      class="btn primary"
                      data-module="what-if-simulator"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">NBS</div>
                      <div>
                    <h4>NBS Build-up Wizard</h4>
                    <p>Guided build-up wizard for specification-ready element data and structured export outputs.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Specs</span>
                    <button
                      class="btn primary"
                      data-module="nbs-buildup"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">RS</div>
                      <div>
                        <h4>Reverse Spec from Datasheet</h4>
                        <p>Paste a datasheet or link and get a draft spec clause with missing performance data flagged.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Spec Assist</span>
                    <button
                      class="btn primary"
                      data-module="reverse-spec"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">LAY</div>
                      <div>
                        <h4>AI Layout Generator (Revit-first)</h4>
                        <p>Send building type, areas, adjacencies, constraints â€” generate native layout options in Revit.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">BIM</span>
                    <button
                      class="btn primary"
                      data-module="layout-generator"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">RH</div>
                      <div>
                        <h4>Reg-Aware Layout Hints</h4>
                        <p>In-model warnings for escape distances, corridor widths, turning circles, and other TGD issues.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Compliance</span>
                    <button
                      class="btn primary"
                      data-module="layout-hints"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">BER</div>
                      <div>
                        <h4>BER / DEAP Copilot</h4>
                        <p>Upload BIM exports later. Extract systems and areas, pre-fill DEAP inputs, and guide the rest.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Energy</span>
                    <button
                      class="btn primary"
                      data-module="ber-copilot"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">CMP</div>
                      <div>
                        <h4>Option-to-Option BER Comparison</h4>
                        <p>Compare design variants and see how geometry and fabric changes impact BER and energy outputs.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Comparison</span>
                    <button
                      class="btn primary"
                      data-module="ber-comparison"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">ED</div>
                      <div>
                        <h4>Learning Mode for Students</h4>
                        <p>Hints, clause breakdowns, and quizzes to learn TGDs, spec logic, and energy rules.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Education</span>
                    <button
                      class="btn primary"
                      data-module="learning-mode"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>

                <article class="card">
                  <div class="cardhead">
                    <div class="cardtitle">
                      <div class="icon">CL</div>
                      <div>
                        <h4>Client Explain Mode</h4>
                        <p>Convert technical outputs into plain English for client-facing reports and emails.</p>
                      </div>
                    </div>
                    <span class="pill live">Available</span>
                  </div>
                  <div class="cta">
                    <span class="pill">Client</span>
                    <button
                      class="btn primary"
                      data-module="client-explain"
                      type="button"
                    >
                      Open
                    </button>
                  </div>
                </article>
              </div>
            </div>
          </div>
        </section>

        <!-- ====== CHAT ====== -->
        <section class="view" id="viewChat">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Chat</h2>
                <p>
                  Keep conversations clean with saved sessions. Use Evidence mode for stricter, citation-ready answers (ideal for regs / reports).
                </p>
              </div>
            <div class="heroBadges">
              <button class="btn" id="btnExportChat" type="button" title="Export current chat as a text file">Export</button>
              <span class="tag">Keyboard: <span class="kbd">Enter</span> send â€¢ <span class="kbd">Shift</span>+<span class="kbd">Enter</span> newline</span>
            </div>
            </div>
            <div class="quote">
              Tip: click <b>Chat</b> again to pop open your <b>Saved chats</b> drawer.
              Press <span class="kbd">/</span> to focus input.
            </div>
          </div>

          <div class="chatShell">
            <!-- Main chat column -->
            <div>
              <div class="row" style="justify-content:space-between; margin-top: 12px;">
                <div class="row">
                  <label class="toggle" title="Prefer stricter, evidence-oriented responses">
                    <input type="checkbox" id="forceDocs" />
                    Evidence mode
                  </label>
                  <label class="toggle" title="Enable streaming typewriter effect (cosmetic)">
                    <input type="checkbox" id="typewriter" />
                    Typewriter
                  </label>
                  <label class="toggle" title="Stop responses quickly if needed">
                    <input type="checkbox" id="fastMode" />
                    Fast mode
                  </label>
                  <label class="toggle" title="Keep backend warm (helpful for Render free-tier)">
                    <input type="checkbox" id="keepWarm" />
                    Keep warm
                  </label>
                </div>
                <div class="row">
                  <button class="btn" id="btnClear" type="button">Clear chat</button>
                </div>
              </div>

              <div class="chatwrap">
                <div class="chatbox" id="chatBox" aria-live="polite"></div>

                <div class="composer">
                  <textarea id="msg" placeholder="Ask about TGDs, planning, specs, Fire/DAC, BERâ€¦ (Shift + Enter for a new line)"></textarea>
                  <button class="btn primary" id="send" type="button">Send</button>
                </div>
              </div>

              <div class="footer">
                <div class="copy">Â© 2026 Raheem AI. All rights reserved.</div>
                <div>Tip: Evidence mode is best for technical checks.</div>
              </div>
            </div>

            <!-- Right info panel (sellable â€œassistâ€ feel) -->
            <aside class="sideInfo">
              <div class="head">
                <div class="t">How to use</div>
                <span class="tag">Pro tips</span>
              </div>
              <div class="body">
                <div class="muted">
                  <b>Best practice:</b> ask one question per message, include building type + occupancy + whether itâ€™s new build or existing.
                </div>
                <div class="pillRow">
                  <span class="pill">Fire (TGD B)</span>
                  <span class="pill">DAC (TGD M)</span>
                  <span class="pill">Planning</span>
                  <span class="pill">Specs</span>
                  <span class="pill">BER</span>
                </div>

                <div style="margin-top:14px" class="muted">
                  <b>Shortcuts:</b><br/>
                  <span class="kbd">/</span> focus chat â€¢ <span class="kbd">Ctrl</span>+<span class="kbd">K</span> clear â€¢ <span class="kbd">Esc</span> close dialogs
                </div>

                <div style="margin-top:14px" class="muted">
                  <b>Available modes:</b> Learning Mode (students) + Client Explain Mode (plain English for reports/emails).
                </div>

                <div style="margin-top:14px">
                  <button class="btn" type="button" onclick="document.getElementById('navHome').click()">Browse modules</button>
                </div>
              </div>
            </aside>
          </div>
        </section>

        <!-- ====== TOOLS ====== -->
        <section class="view" id="viewTools">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Tools</h2>
                <p>Every tool is available now in preview mode. You answer questions; Raheem AI produces structured outputs ready for review and submission packs.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available now</span>
                <span class="tag">Preview mode</span>
              </div>
            </div>
            <div class="quote">
              All tools below are live in preview so you can explore the full platform today.
            </div>
          </div>

          <div style="margin-top:14px" class="featureGrid">
            <article class="card">
              <div class="cardhead">
                <div class="cardtitle">
                  <div class="icon">FCS</div>
                  <div>
                    <h4>Fire Safety Certificate Generator (Non-dwellings)</h4>
                    <p>Guided questionnaire based on TGD B â†’ structured Fire Safety report + submission checklist.</p>
                  </div>
                </div>
                <span class="pill live">Available</span>
              </div>
              <div class="cta">
                <span class="pill">Non-dwellings</span>
                <button
                  class="btn primary"
                  data-module="fire-safety-cert"
                  type="button"
                >
                  Open
                </button>
              </div>
            </article>

            <article class="card">
              <div class="cardhead">
                <div class="cardtitle">
                  <div class="icon">DAC</div>
                  <div>
                    <h4>Disability Access Certificate (DAC) Generator</h4>
                    <p>TGD M questionnaire â†’ DAC report draft with non-compliance risks highlighted.</p>
                  </div>
                </div>
                <span class="pill live">Available</span>
              </div>
              <div class="cta">
                <span class="pill">Access & use</span>
                <button
                  class="btn primary"
                  data-module="dac-generator"
                  type="button"
                >
                  Open
                </button>
              </div>
            </article>

            <article class="card">
              <div class="cardhead">
                <div class="cardtitle">
                  <div class="icon">NBS</div>
                  <div>
                  <h4>NBS Build-up Wizard</h4>
                  <p>Guided build-up wizard â†’ spec-ready data + structured export outputs.</p>
                  </div>
                </div>
                <span class="pill live">Available</span>
              </div>
              <div class="cta">
                <span class="pill">Specs</span>
                <button
                  class="btn primary"
                  data-module="nbs-buildup"
                  type="button"
                >
                  Open
                </button>
              </div>
            </article>

            <article class="card">
              <div class="cardhead">
                <div class="cardtitle">
                  <div class="icon">BER</div>
                  <div>
                    <h4>BER / DEAP Copilot</h4>
                    <p>Upload BIM export later (IFC/gbXML). Extract areas/systems â†’ guide remaining inputs and outputs key results.</p>
                  </div>
                </div>
                <span class="pill live">Available</span>
              </div>
              <div class="cta">
                <span class="pill">Energy</span>
                <button
                  class="btn primary"
                  data-module="ber-copilot"
                  type="button"
                >
                  Open
                </button>
              </div>
            </article>

            <article class="card">
              <div class="cardhead">
                <div class="cardtitle">
                  <div class="icon">RS</div>
                  <div>
                    <h4>Reverse Spec from Datasheet</h4>
                    <p>Paste a datasheet/link â†’ draft spec clause + missing performance data called out.</p>
                  </div>
                </div>
                <span class="pill live">Available</span>
              </div>
              <div class="cta">
                <span class="pill">Spec Assist</span>
                <button
                  class="btn primary"
                  data-module="reverse-spec"
                  type="button"
                >
                  Open
                </button>
              </div>
            </article>

            <article class="card">
              <div class="cardhead">
                <div class="cardtitle">
                  <div class="icon">PK</div>
                  <div>
                    <h4>Submission Pack Builder</h4>
                    <p>Combine Fire + DAC outputs into a submission bundle with cover letters and indices.</p>
                  </div>
                </div>
                <span class="pill live">Available</span>
              </div>
              <div class="cta">
                <span class="pill">Docs</span>
                <button
                  class="btn primary"
                  data-module="submission-pack"
                  type="button"
                >
                  Open
                </button>
              </div>
            </article>
          </div>

          <div class="footer">
            <div class="copy">Â© 2026 Raheem AI. All rights reserved.</div>
            <div>Generators preview</div>
          </div>
        </section>

        <!-- ====== MODULE PAGES ====== -->
        <section class="view moduleView" id="module-tgd-smart-checker" data-title="TGD Smart Checker" data-hint="Instant compliance triage for early-stage schemes">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>TGD Smart Checker</h2>
                <p>Upload a plan or describe a scheme and get red flags, likely non-compliances, and suggested design fixes mapped to the correct TGD parts.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Compliance</span>
              </div>
            </div>
            <div class="quote">Best for early checks, pre-planning reviews, and fast sanity passes before deep design work.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">What it covers</div>
              <span class="tag">Preview workflow</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Scheme summary, key constraints, occupancy, height/area, and any drawings or notes.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Non-compliance risks with clause references, fixes, and design notes for follow-up.</div></div></div>
                <div class="li"><div><b>Deliverables</b><div class="s">Structured red-flag list ready to drop into early design reports.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-fire-safety-cert" data-title="Fire Safety Certificate Generator" data-hint="TGD B-driven fire certification workflow">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Fire Safety Certificate Generator (Non-dwellings)</h2>
                <p>Guided questionnaire based on TGD B that produces a structured Fire Safety Certificate report and a submission checklist.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Fire</span>
              </div>
            </div>
            <div class="quote">Collects the right inputs in the right order to reduce revisions during certification.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Workflow highlights</div>
              <span class="tag">Report-ready</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Occupancy, compartmentation, fire strategy, detection, suppression, and escape routes.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Fire Safety Certificate report draft with structured sections and compliance notes.</div></div></div>
                <div class="li"><div><b>Checklist</b><div class="s">Submission checklist tailored for non-dwellings to reduce missing items.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-dac-generator" data-title="Disability Access Certificate Generator" data-hint="TGD M-driven DAC reporting">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Disability Access Certificate (DAC) Generator</h2>
                <p>TGD M questionnaire capturing access strategy details and outputting a professional DAC report with risk highlights.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Access</span>
              </div>
            </div>
            <div class="quote">Designed for consistent, compliant access narratives that are easy for reviewers to follow.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">What you get</div>
              <span class="tag">DAC-ready</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Access routes, parking, entrances, vertical circulation, and sanitary provisions.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">DAC report draft with sectioned compliance statements and risk flags.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Ideal for early design reviews and certification submissions.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-submission-pack" data-title="Submission Pack Builder" data-hint="Bundle Fire + DAC into ready-to-submit packs">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Submission Pack Builder</h2>
                <p>Combines Fire and DAC outputs into ready-to-use submission bundles with reports, drawing indices, and cover letter templates.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Docs</span>
              </div>
            </div>
            <div class="quote">Keeps submissions consistent and avoids missing attachments.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Bundle contents</div>
              <span class="tag">Pack builder</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Fire report, DAC report, drawing list, and project metadata.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Combined submission pack with cover letter and indexed drawings.</div></div></div>
                <div class="li"><div><b>Export</b><div class="s">Structured pack ready for PDF packaging or client handoff.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-design-debate" data-title="Design Debate Room" data-hint="Multi-agent design tradeoff analysis">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Design Debate Room</h2>
                <p>Two AIs argue for and against an option (sprinklers vs passive, timber vs block), then converge on a recommended choice.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Decision</span>
              </div>
            </div>
            <div class="quote">Use for design reviews, value engineering, or option comparison workshops.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Decision workflow</div>
              <span class="tag">Reasoned outputs</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Two or more design options with constraints and priorities.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Argument summary, risks, and a recommended path with rationale.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Internal design choices, client-facing justification, or consultant review.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-what-if-simulator" data-title="What-If Reg Simulator" data-hint="Instant compliance impact of design changes">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>â€œWhat-Ifâ€ Reg Simulator</h2>
                <p>Change height, area, occupancy, or use and see Fire, DAC, Planning, and energy implications shift instantly.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Simulator</span>
              </div>
            </div>
            <div class="quote">Great for early feasibility testing and quick compliance sensitivity checks.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Scenario checks</div>
              <span class="tag">Preview workflow</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Baseline scheme parameters and the change you want to test.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Impact summary across Fire, DAC, Planning, and BER with risks flagged.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Feasibility workshops, client comparisons, and design iterations.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-nbs-buildup" data-title="NBS Build-up Wizard" data-hint="Guided element build-up with spec-ready export">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>NBS Build-up Wizard</h2>
                <p>Build element specifications with a guided wizard, validate required inputs, and export spec-ready JSON plus an original clause-style specification document.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Specs</span>
              </div>
            </div>
            <div class="quote">No proprietary clause libraries used â€” all output is generated from your inputs in original language.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="wizardLayout" id="nbsWizard">
            <aside class="wizardPanel" aria-label="Progress and missing items">
              <h3>Progress</h3>
              <div class="wizardList" id="nbsProgressList"></div>
              <h3 style="margin-top:16px;">Missing items</h3>
              <div class="wizardList" id="nbsMissingList"></div>
              <h3 style="margin-top:16px;">Warnings</h3>
              <div class="wizardList" id="nbsWarningList"></div>
            </aside>

            <div class="wizardPanel wizardMain" id="nbsWizardMain"></div>
          </div>
        </section>

        <section class="view moduleView" id="module-reverse-spec" data-title="Reverse Spec from Datasheet" data-hint="Draft specs from product data">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Reverse Spec from Datasheet</h2>
                <p>Paste a manufacturer datasheet or link and get a draft spec clause with gaps and missing performance data called out.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Spec Assist</span>
              </div>
            </div>
            <div class="quote">Fast way to translate product data into spec language and catch missing details.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Spec extraction</div>
              <span class="tag">Product-focused</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Datasheet text or URL, and required performance criteria.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Draft clause plus missing data checklist for procurement follow-up.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Product evaluation and specification QA.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-layout-generator" data-title="AI Layout Generator" data-hint="Revit-first layout generation">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>AI Layout Generator (Revit-first)</h2>
                <p>Provide building type, areas, adjacencies, and constraints to generate layout options as native Revit rooms, walls, and doors.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">BIM</span>
              </div>
            </div>
            <div class="quote">Turns planning constraints into layout concepts while keeping geometry editable.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Layout inputs</div>
              <span class="tag">Revit-first</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Program areas, adjacency rules, core requirements, and constraints.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Layout options and room schedules ready for Revit iteration.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Early concept planning and quick option studies.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-layout-hints" data-title="Reg-Aware Layout Hints" data-hint="In-model compliance warnings">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Reg-Aware Layout Hints</h2>
                <p>In-model warnings for escape distances, corridor widths, turning circles, and other TGD-related issues.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Compliance overlays</span>
              </div>
            </div>
            <div class="quote">Surface compliance hints directly on the layout to reduce back-and-forth QA.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Hint types</div>
              <span class="tag">BIM overlays</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Checks</b><div class="s">Escape routes, corridor widths, turning circles, and access clearances.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Visual warnings and a list of flagged items to address.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Realtime guidance during layout edits.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-ber-copilot" data-title="BER / DEAP Copilot" data-hint="Energy performance inputs and guidance">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>BER / DEAP Copilot</h2>
                <p>Upload a BIM export (IFC/gbXML) to extract areas and systems, pre-fill DEAP-style data, and guide remaining inputs.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Energy</span>
              </div>
            </div>
            <div class="quote">Streamlines BER preparation and highlights the biggest performance levers.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Energy workflow</div>
              <span class="tag">BER-ready</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">BIM exports, fabric specs, HVAC systems, and renewables data.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Pre-filled BER dataset, energy summary, and sensitivity notes.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">BER submissions and quick energy option reviews.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-ber-comparison" data-title="Option-to-Option BER Comparison" data-hint="Compare two design energy variants">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Option-to-Option BER Comparison</h2>
                <p>Compare two design variants and see how geometry and fabric changes affect BER, primary energy, and COâ‚‚ outputs.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Comparison</span>
              </div>
            </div>
            <div class="quote">Provides decision-ready energy comparisons for design reviews.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Comparison outputs</div>
              <span class="tag">Option review</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Baseline and proposed variants with fabric, systems, and geometry data.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Delta summaries for BER, primary energy, and COâ‚‚ emissions.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Option selection and client-facing energy tradeoffs.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-learning-mode" data-title="Learning Mode" data-hint="Student-friendly guidance and quizzes">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Learning Mode for Students</h2>
                <p>Explanatory mode with hints, clause breakdowns, and quizzes to learn TGDs, spec logic, and energy rules.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Education</span>
              </div>
            </div>
            <div class="quote">Guided learning that still keeps compliance context accurate and structured.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Learning tools</div>
              <span class="tag">Explain mode</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Topic, TGD part, or practice question set.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Explanations, quizzes, and examples tied back to regulations.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Teaching, onboarding, and junior staff training.</div></div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="view moduleView" id="module-client-explain" data-title="Client Explain Mode" data-hint="Plain-English outputs for clients">
          <div class="hero">
            <div class="heroHead">
              <div>
                <h2>Client Explain Mode</h2>
                <p>Convert technical outputs (Fire, DAC, BER, planning issues) into clear client-friendly explanations for reports and emails.</p>
              </div>
              <div class="heroBadges">
                <span class="tag live">Available</span>
                <span class="tag">Client</span>
              </div>
            </div>
            <div class="quote">Ideal for simplifying compliance outputs without losing essential meaning.</div>
            <div class="heroCTA">
              <button class="btn primary" type="button" onclick="showView('chat')">Open Chat</button>
              <button class="btn" type="button" onclick="showView('home')">Back to Overview</button>
            </div>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panelHead">
              <div class="t">Client-ready outputs</div>
              <span class="tag">Plain English</span>
            </div>
            <div class="panelBody">
              <div class="list">
                <div class="li"><div><b>Inputs</b><div class="s">Compliance output or draft report sections to translate.</div></div></div>
                <div class="li"><div><b>Outputs</b><div class="s">Clear summaries, action lists, and suggested next steps.</div></div></div>
                <div class="li"><div><b>Use case</b><div class="s">Client emails, reports, and stakeholder updates.</div></div></div>
              </div>
            </div>
          </div>
        </section>

      </main>

      <!-- Saved chats drawer -->
      <div class="chatlist" id="chatList" aria-label="Saved chats drawer">
        <div class="chatlistTop">
          <div class="t">Saved chats</div>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" id="btnNewChat" type="button" style="padding:8px 10px; border-radius:14px;">New</button>
            <button class="iconBtn danger" id="btnDeleteAllChats" type="button" title="Delete all chats" aria-label="Delete all chats">ðŸ—‘</button>
          </div>
        </div>

        <div class="chatSearch">
          <input id="chatFilter" type="text" placeholder="Search chats..." autocomplete="off" />
        </div>

        <div class="chatItemsScroll">
          <div id="chatItems"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">Modal</div>
        <button class="iconBtn" id="modalClose" type="button" aria-label="Close modal">Ã—</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot" style="display:none;"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // 1) API CONFIG
    // =========================================================
    const CONFIG = {
      API_BASE_DEFAULT: "http://127.0.0.1:8001",
      HEALTH_PATH: "/health",
      CHAT_PATH: "/chat",
      PDFS_PATH: "/pdfs",
      HEALTH_TIMEOUT_MS: 9000,
      STATUS_POLL_MS: 20000,
      WARM_PING_MS: 240000,
      CHAT_TIMEOUT_MS: 75000,
      CHAT_RETRY_ONCE: true
    };

    const apiBaseOverride = (localStorage.getItem("RAHEEM_API_BASE") || "").trim();
    const inferredApiBase = (() => {
      if(apiBaseOverride) return apiBaseOverride;
      const host = window.location.hostname;
      const isLocal = host === "127.0.0.1" || host === "localhost";
      if(!isLocal && window.location.origin){
        return window.location.origin;
      }
      return CONFIG.API_BASE_DEFAULT;
    })();
    const API_BASE = inferredApiBase.replace(/\/+$/, "");
    function apiUrl(path){
      if(!path) path = "/";
      if(!path.startsWith("/")) path = "/" + path;
      return API_BASE + path;
    }

    // =========================================================
    // Toast (supports Undo actions)
    // =========================================================
    const toast = document.getElementById("toast");
    let toastTimer = null;
    function showToast(msg, actions){
      clearTimeout(toastTimer);
      toast.innerHTML = "";

      if(actions && actions.length){
        const row = document.createElement("div");
        row.className = "toastRow";
        const left = document.createElement("div");
        left.textContent = msg;
        const right = document.createElement("div");
        right.className = "toastActions";
        actions.forEach(a=>{
          const b = document.createElement("button");
          b.type = "button";
          b.textContent = a.label;
          b.onclick = () => { try{ a.onClick(); } finally { hideToast(); } };
          right.appendChild(b);
        });
        row.appendChild(left);
        row.appendChild(right);
        toast.appendChild(row);
      } else {
        toast.textContent = msg;
      }

      toast.classList.add("show");
      toastTimer = setTimeout(()=> toast.classList.remove("show"), 3200);
    }
    function hideToast(){ toast.classList.remove("show"); }

    // =========================================================
    // Modal (supports confirm + custom buttons)
    // =========================================================
    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalFoot = document.getElementById("modalFoot");
    const modalClose = document.getElementById("modalClose");

    function openModal(title, bodyText, footerButtons){
      modalTitle.textContent = title || "Info";
      modalBody.textContent = bodyText || "";
      modalFoot.innerHTML = "";
      if(footerButtons && footerButtons.length){
        modalFoot.style.display = "flex";
        footerButtons.forEach(btn=>{
          const b = document.createElement("button");
          b.type = "button";
          b.className = "btn" + (btn.primary ? " primary" : "");
          b.textContent = btn.label;
          b.onclick = () => { if(btn.onClick) btn.onClick(); };
          modalFoot.appendChild(b);
        });
      } else {
        modalFoot.style.display = "none";
      }
      modalOverlay.classList.add("show");
    }
    function closeModal(){ modalOverlay.classList.remove("show"); }
    modalClose.onclick = closeModal;
    modalOverlay.addEventListener("click", (e)=>{ if(e.target === modalOverlay) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(); });

    // =========================================================
    // Navigation (keeps your IDs + localStorage behavior)
    // =========================================================
    const viewTitleEl = document.getElementById("viewTitle");
    const viewHintEl  = document.getElementById("viewHint");
    const viewHome    = document.getElementById("viewHome");
    const viewChat    = document.getElementById("viewChat");
    const viewTools   = document.getElementById("viewTools");
    const moduleViews = Array.from(document.querySelectorAll(".moduleView"));
    const chatList    = document.getElementById("chatList");

    const navHome   = document.getElementById("navHome");
    const navChat   = document.getElementById("navChat");
    const navTools  = document.getElementById("navTools");
    const navFuture = null;

    function setNavActive(which){
      // header pills
      [navHome, navChat, navTools].forEach(b=>b.classList.remove("active"));
      if(which==="home") navHome.classList.add("active");
      if(which==="chat") navChat.classList.add("active");
      if(which==="tools") navTools.classList.add("active");

      // rail buttons
      const railBtns = document.querySelectorAll(".railBtn");
      railBtns.forEach(b=>b.classList.remove("active"));
      if(which==="home") railBtns[0]?.classList.add("active");
      if(which==="chat") railBtns[1]?.classList.add("active");
      if(which==="tools") railBtns[2]?.classList.add("active");
    }

    function hideAllViews(){
      [viewHome, viewChat, viewTools, ...moduleViews].forEach(v=>v.classList.remove("show"));
    }

    function showView(which){
      hideAllViews();

      if(which==="home"){
        viewHome.classList.add("show");
        viewTitleEl.textContent = "Overview";
        viewHintEl.textContent  = "Product summary and quick start";
        chatList.classList.remove("show");
      }
      if(which==="chat"){
        viewChat.classList.add("show");
        viewTitleEl.textContent = "Chat";
        viewHintEl.textContent  = "Saved sessions and continuous context";
        ensureActiveChat();
        renderChatList();
        renderChat();
        setTimeout(()=> msgEl.focus(), 50);

        // Open drawer when entering chat
        chatList.classList.add("show");
      }
      if(which==="tools"){
        viewTools.classList.add("show");
        viewTitleEl.textContent = "Tools";
        viewHintEl.textContent  = "Generators, specs, compliance workflows";
        chatList.classList.remove("show");
      }

      setNavActive(which);
      localStorage.setItem("RAHEEM_VIEW", which);
    }

    function showModule(moduleId){
      const target = document.getElementById(`module-${moduleId}`);
      if(!target) return;
      hideAllViews();
      target.classList.add("show");
      viewTitleEl.textContent = target.dataset.title || "Module";
      viewHintEl.textContent = target.dataset.hint || "Module overview";
      chatList.classList.remove("show");
      setNavActive(null);
      localStorage.setItem("RAHEEM_VIEW", `module:${moduleId}`);
      window.scrollTo({ top: 0, behavior: "smooth" });
      if(moduleId === "nbs-buildup"){
        renderNbsWizard();
      }
    }

    function showModule(moduleId){
      const target = document.getElementById(`module-${moduleId}`);
      if(!target) return;
      hideAllViews();
      target.classList.add("show");
      viewTitleEl.textContent = target.dataset.title || "Module";
      viewHintEl.textContent = target.dataset.hint || "Module overview";
      chatList.classList.remove("show");
      setNavActive(null);
      localStorage.setItem("RAHEEM_VIEW", `module:${moduleId}`);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showModule(moduleId){
      const target = document.getElementById(`module-${moduleId}`);
      if(!target) return;
      hideAllViews();
      target.classList.add("show");
      viewTitleEl.textContent = target.dataset.title || "Module";
      viewHintEl.textContent = target.dataset.hint || "Module overview";
      chatList.classList.remove("show");
      setNavActive(null);
      localStorage.setItem("RAHEEM_VIEW", `module:${moduleId}`);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Toggle drawer when clicking Chat pill repeatedly
    navChat.onclick = ()=>{
      const saved = (localStorage.getItem("RAHEEM_VIEW") || "home").toLowerCase();
      if(saved === "chat" && viewChat.classList.contains("show")){
        chatList.classList.toggle("show");
      } else {
        showView("chat");
      }
    };
    navHome.onclick = ()=>showView("home");
    navTools.onclick = ()=>showView("tools");

    document.getElementById("btnStartChat").onclick = ()=>showView("chat");
    document.getElementById("btnOpenTools").onclick = ()=>showView("tools");

    window.addEventListener("DOMContentLoaded", () => {
      const saved = (localStorage.getItem("RAHEEM_VIEW") || "home");
      if(saved.startsWith("module:")){
        const moduleId = saved.replace("module:", "").trim();
        if(moduleId){
          showModule(moduleId);
          return;
        }
      }
      showView(["home","chat","tools"].includes(saved) ? saved : "home");
    });

    // =========================================================
    // NBS Build-up Wizard
    // =========================================================
    const nbsWizardState = {
      stepIndex: 0,
      project: {
        projectName: "",
        projectType: "",
        location: "",
        stage: "",
        performanceTargets: ""
      },
      elementsSelected: [],
      externalWall: {
        summary: {
          wallSystemType: "",
          totalThicknessMm: "",
          externalFinish: "",
          internalFinish: ""
        },
        layers: [],
        performance: {
          targetUValue: "",
          fireRating: "None/Unknown",
          acousticRequirement: "",
          airtightnessNotes: "",
          moistureStrategy: "Unknown"
        },
        standards: {
          standardsNotes: ""
        },
        attachments: []
      }
    };

    const nbsSteps = [
      { key: "project", title: "Project basics" },
      { key: "elements", title: "Choose elements" },
      { key: "externalWall", title: "External wall module" },
      { key: "review", title: "Review & export" }
    ];

    function renderNbsWizard(){
      const progressList = document.getElementById("nbsProgressList");
      const missingList = document.getElementById("nbsMissingList");
      const warningList = document.getElementById("nbsWarningList");
      const main = document.getElementById("nbsWizardMain");
      if(!progressList || !missingList || !warningList || !main) return;

      progressList.innerHTML = "";
      nbsSteps.forEach((step, idx) => {
        const item = document.createElement("div");
        item.className = "item";
        item.textContent = `${idx + 1}. ${step.title}`;
        if(idx === nbsWizardState.stepIndex){
          item.style.borderColor = "rgba(80,255,215,.4)";
          item.style.color = "rgba(244,247,255,.95)";
        }
        progressList.appendChild(item);
      });

      const { blocking, warnings } = getNbsIssues();
      missingList.innerHTML = blocking.length
        ? blocking.map(text => `<div class="item">${text}</div>`).join("")
        : `<div class="item">All required items complete.</div>`;
      warningList.innerHTML = warnings.length
        ? warnings.map(text => `<div class="item">${text}</div>`).join("")
        : `<div class="item">No warnings.</div>`;

      const stepKey = nbsSteps[nbsWizardState.stepIndex]?.key;
      if(stepKey === "project") renderNbsProjectStep(main);
      if(stepKey === "elements") renderNbsElementsStep(main);
      if(stepKey === "externalWall") renderNbsExternalWallStep(main);
      if(stepKey === "review") renderNbsReviewStep(main);
    }

    function renderNbsProjectStep(main){
      main.innerHTML = `
        <h3>Step 1: Project basics</h3>
        <div class="wizardRow">
          <div class="wizardField">
            <label>Project name (required)</label>
            <input data-field="projectName" value="${escapeHtml(nbsWizardState.project.projectName)}" />
          </div>
          <div class="wizardField">
            <label>Project type (required)</label>
            <select data-field="projectType">
              ${renderOptions(["", "House", "Apartments", "Office", "School", "Other"], nbsWizardState.project.projectType)}
            </select>
          </div>
        </div>
        <div class="wizardRow">
          <div class="wizardField">
            <label>Location (required)</label>
            <input data-field="location" value="${escapeHtml(nbsWizardState.project.location)}" />
          </div>
          <div class="wizardField">
            <label>Stage (required)</label>
            <select data-field="stage">
              ${renderOptions(["", "Concept", "Planning", "Tender", "Construction"], nbsWizardState.project.stage)}
            </select>
          </div>
        </div>
        <div class="wizardField">
          <label>Performance targets (optional)</label>
          <textarea data-field="performanceTargets">${escapeHtml(nbsWizardState.project.performanceTargets)}</textarea>
        </div>
        <div class="wizardActions">
          <button class="btn primary" id="nbsNextProject">Next</button>
        </div>
      `;
      main.querySelectorAll("[data-field]").forEach(el => {
        el.addEventListener("input", () => {
          const key = el.getAttribute("data-field");
          nbsWizardState.project[key] = el.value;
          renderNbsWizard();
        });
      });
      const nextBtn = document.getElementById("nbsNextProject");
      nextBtn.disabled = !isProjectValid();
      nextBtn.onclick = () => {
        nbsWizardState.stepIndex = 1;
        renderNbsWizard();
      };
    }

    function renderNbsElementsStep(main){
      const elementOptions = [
        "External Wall",
        "Internal Partition",
        "Ground Floor",
        "Upper Floor",
        "Roof",
        "Windows",
        "Doors"
      ];
      main.innerHTML = `
        <h3>Step 2: Choose elements</h3>
        <div class="wizardField">
          <label>Select at least one element</label>
          <div class="wizardList">
            ${elementOptions.map(opt => `
              <label class="item" style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" value="${opt}" ${nbsWizardState.elementsSelected.includes(opt) ? "checked" : ""}/>
                <span>${opt}</span>
              </label>
            `).join("")}
          </div>
        </div>
        <div class="wizardActions">
          <button class="btn" id="nbsPrevElements">Back</button>
          <button class="btn primary" id="nbsNextElements">Next</button>
        </div>
      `;
      main.querySelectorAll("input[type='checkbox']").forEach(el => {
        el.addEventListener("change", () => {
          const value = el.value;
          if(el.checked){
            if(!nbsWizardState.elementsSelected.includes(value)) nbsWizardState.elementsSelected.push(value);
          } else {
            nbsWizardState.elementsSelected = nbsWizardState.elementsSelected.filter(item => item !== value);
          }
          renderNbsWizard();
        });
      });
      document.getElementById("nbsPrevElements").onclick = () => {
        nbsWizardState.stepIndex = 0;
        renderNbsWizard();
      };
      const nextBtn = document.getElementById("nbsNextElements");
      nextBtn.disabled = nbsWizardState.elementsSelected.length === 0;
      nextBtn.onclick = () => {
        nbsWizardState.stepIndex = 2;
        renderNbsWizard();
      };
    }

    function renderNbsExternalWallStep(main){
      if(!nbsWizardState.elementsSelected.includes("External Wall")){
        const nextElement = nbsWizardState.elementsSelected[0] || "Element";
        main.innerHTML = `
          <h3>Step 3: ${escapeHtml(nextElement)} module</h3>
          <p class="muted">This module is coming next. The data structure is reserved in the export.</p>
          <div class="wizardActions">
            <button class="btn" id="nbsPrevWall">Back</button>
            <button class="btn primary" id="nbsNextWall">Next</button>
          </div>
        `;
        document.getElementById("nbsPrevWall").onclick = () => {
          nbsWizardState.stepIndex = 1;
          renderNbsWizard();
        };
        document.getElementById("nbsNextWall").onclick = () => {
          nbsWizardState.stepIndex = 3;
          renderNbsWizard();
        };
        return;
      }
      const summary = nbsWizardState.externalWall.summary;
      const performance = nbsWizardState.externalWall.performance;
      const standards = nbsWizardState.externalWall.standards;
      const layers = nbsWizardState.externalWall.layers;
      main.innerHTML = `
        <h3>Step 3: External wall module</h3>
        <p class="muted">Other element modules are coming next, but their data structure will follow this pattern.</p>
        <div class="wizardPanel" style="margin-bottom:12px;">
          <h3>Element summary</h3>
          <div class="wizardRow">
            <div class="wizardField">
              <label>Wall system type (required)</label>
              <select data-summary="wallSystemType">
                ${renderOptions(["", "Cavity Masonry", "Timber Frame", "SFS", "Solid Masonry", "Rainscreen over Backup Wall", "Other"], summary.wallSystemType)}
              </select>
            </div>
            <div class="wizardField">
              <label>Total thickness (mm) (required)</label>
              <input type="number" data-summary="totalThicknessMm" value="${escapeHtml(summary.totalThicknessMm)}" />
            </div>
          </div>
          <div class="wizardRow">
            <div class="wizardField">
              <label>External finish (required)</label>
              <select data-summary="externalFinish">
                ${renderOptions(["", "Brick", "Render", "Rainscreen", "Stone", "Other"], summary.externalFinish)}
              </select>
            </div>
            <div class="wizardField">
              <label>Internal finish (required)</label>
              <select data-summary="internalFinish">
                ${renderOptions(["", "Plasterboard", "Plaster", "Exposed", "Other"], summary.internalFinish)}
              </select>
            </div>
          </div>
        </div>

        <div class="wizardPanel" style="margin-bottom:12px;">
          <h3>Build-up layers</h3>
          ${layers.length ? layers.map((layer, idx) => `
            <div class="layerCard">
              <header>
                <span>Layer ${idx + 1}</span>
                <div class="layerControls">
                  <button class="btn" data-layer-action="up" data-layer-index="${idx}">â†‘</button>
                  <button class="btn" data-layer-action="down" data-layer-index="${idx}">â†“</button>
                  <button class="btn" data-layer-action="remove" data-layer-index="${idx}">Remove</button>
                </div>
              </header>
              <div class="wizardRow">
                <div class="wizardField">
                  <label>Layer name (required)</label>
                  <input data-layer-field="layerName" data-layer-index="${idx}" value="${escapeHtml(layer.layerName)}" />
                </div>
                <div class="wizardField">
                  <label>Material (required)</label>
                  <input data-layer-field="material" data-layer-index="${idx}" value="${escapeHtml(layer.material)}" />
                </div>
              </div>
              <div class="wizardRow">
                <div class="wizardField">
                  <label>Thickness (mm) (required)</label>
                  <input type="number" data-layer-field="thicknessMm" data-layer-index="${idx}" value="${escapeHtml(layer.thicknessMm)}" />
                </div>
                <div class="wizardField">
                  <label>Function (required)</label>
                  <select data-layer-field="function" data-layer-index="${idx}">
                    ${renderOptions(["", "Structural", "Insulation", "Vapour Control", "Air Barrier", "Sheathing", "Cavity", "Finish", "Other"], layer.function)}
                  </select>
                </div>
              </div>
              <div class="wizardRow">
                <div class="wizardField">
                  <label>Manufacturer (optional)</label>
                  <input data-layer-field="manufacturer" data-layer-index="${idx}" value="${escapeHtml(layer.manufacturer || "")}" />
                </div>
                <div class="wizardField">
                  <label>Product reference (optional)</label>
                  <input data-layer-field="productRef" data-layer-index="${idx}" value="${escapeHtml(layer.productRef || "")}" />
                </div>
              </div>
            </div>
          `).join("") : `<div class="item">No layers added yet.</div>`}
          <div class="wizardActions">
            <button class="btn" id="nbsAddLayer">Add layer</button>
          </div>
        </div>

        <div class="wizardPanel" style="margin-bottom:12px;">
          <h3>Performance</h3>
          <div class="wizardRow">
            <div class="wizardField">
              <label>Target U-value (optional)</label>
              <input type="number" data-performance="targetUValue" value="${escapeHtml(performance.targetUValue)}" />
            </div>
            <div class="wizardField">
              <label>Fire rating (required)</label>
              <select data-performance="fireRating">
                ${renderOptions(["None/Unknown", "30", "60", "90", "120"], performance.fireRating)}
              </select>
            </div>
          </div>
          <div class="wizardRow">
            <div class="wizardField">
              <label>Acoustic requirement (optional)</label>
              <input data-performance="acousticRequirement" value="${escapeHtml(performance.acousticRequirement)}" placeholder="e.g. 45 dB Rw" />
            </div>
            <div class="wizardField">
              <label>Moisture strategy (optional)</label>
              <select data-performance="moistureStrategy">
                ${renderOptions(["Unknown", "VCL internal", "VCL external", "Breathable", "Other"], performance.moistureStrategy)}
              </select>
            </div>
          </div>
          <div class="wizardField">
            <label>Airtightness notes (optional)</label>
            <textarea data-performance="airtightnessNotes">${escapeHtml(performance.airtightnessNotes)}</textarea>
          </div>
        </div>

        <div class="wizardPanel" style="margin-bottom:12px;">
          <h3>Compliance & standards</h3>
          <div class="wizardField">
            <label>Standards notes (optional)</label>
            <textarea data-standards="standardsNotes">${escapeHtml(standards.standardsNotes)}</textarea>
          </div>
        </div>

        <div class="wizardPanel">
          <h3>Attachments</h3>
          <div class="wizardField">
            <label>Add note (optional)</label>
            <textarea id="nbsAttachmentNote" placeholder="Paste notes or references here..."></textarea>
          </div>
          <div class="wizardActions">
            <button class="btn" id="nbsAddNote">Add note</button>
          </div>
          ${renderAttachmentsList()}
        </div>

        <div class="wizardActions">
          <button class="btn" id="nbsPrevWall">Back</button>
          <button class="btn primary" id="nbsNextWall">Next</button>
        </div>
      `;

      main.querySelectorAll("[data-summary]").forEach(el => {
        el.addEventListener("input", () => {
          summary[el.getAttribute("data-summary")] = el.value;
          renderNbsWizard();
        });
      });
      main.querySelectorAll("[data-layer-field]").forEach(el => {
        el.addEventListener("input", () => {
          const idx = Number(el.getAttribute("data-layer-index"));
          const key = el.getAttribute("data-layer-field");
          layers[idx][key] = el.value;
          renderNbsWizard();
        });
      });
      main.querySelectorAll("[data-layer-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.getAttribute("data-layer-index"));
          const action = btn.getAttribute("data-layer-action");
          if(action === "remove") layers.splice(idx, 1);
          if(action === "up" && idx > 0) layers.splice(idx - 1, 0, layers.splice(idx, 1)[0]);
          if(action === "down" && idx < layers.length - 1) layers.splice(idx + 1, 0, layers.splice(idx, 1)[0]);
          renderNbsWizard();
        });
      });
      main.querySelectorAll("[data-performance]").forEach(el => {
        el.addEventListener("input", () => {
          performance[el.getAttribute("data-performance")] = el.value;
          renderNbsWizard();
        });
      });
      main.querySelectorAll("[data-standards]").forEach(el => {
        el.addEventListener("input", () => {
          standards[el.getAttribute("data-standards")] = el.value;
          renderNbsWizard();
        });
      });
      document.getElementById("nbsAddLayer").onclick = () => {
        layers.push({
          layerName: "",
          material: "",
          thicknessMm: "",
          function: "",
          manufacturer: "",
          productRef: ""
        });
        renderNbsWizard();
      };
      document.getElementById("nbsAddNote").onclick = () => {
        const note = document.getElementById("nbsAttachmentNote").value.trim();
        if(!note) return;
        nbsWizardState.externalWall.attachments.push({
          type: "note",
          name: `Note ${nbsWizardState.externalWall.attachments.length + 1}`,
          contentOrUrl: note
        });
        renderNbsWizard();
      };
      document.getElementById("nbsPrevWall").onclick = () => {
        nbsWizardState.stepIndex = 1;
        renderNbsWizard();
      };
      const nextBtn = document.getElementById("nbsNextWall");
      nextBtn.disabled = !isExternalWallValid();
      nextBtn.onclick = () => {
        nbsWizardState.stepIndex = 3;
        renderNbsWizard();
      };
    }

    function renderNbsReviewStep(main){
      const payload = buildNbsPayload();
      const specMarkdown = buildNbsSpecMarkdown(payload);
      main.innerHTML = `
        <h3>Step 4: Review & export</h3>
        <div class="reviewCard">${escapeHtml(JSON.stringify(payload, null, 2))}</div>
        <div class="wizardActions">
          <button class="btn" id="nbsCopyJson">Copy JSON</button>
          <button class="btn" id="nbsDownloadJson">Download JSON</button>
        </div>
        <h3 style="margin-top:16px;">Specification document (preview)</h3>
        <div class="reviewCard">${escapeHtml(specMarkdown)}</div>
        <div class="wizardActions">
          <button class="btn" id="nbsCopySpec">Copy Spec (Markdown)</button>
          <button class="btn" id="nbsDownloadSpecHtml">Download Spec (HTML)</button>
          <button class="btn" id="nbsDownloadSpecPdf">Download Spec (PDF)</button>
        </div>
        <div class="wizardActions">
          <button class="btn" id="nbsPrevReview">Back</button>
        </div>
      `;
      document.getElementById("nbsCopyJson").onclick = () => copyToClipboard(JSON.stringify(payload, null, 2));
      document.getElementById("nbsDownloadJson").onclick = () => downloadBlob(JSON.stringify(payload, null, 2), "nbs-spec.json", "application/json");
      document.getElementById("nbsCopySpec").onclick = () => copyToClipboard(specMarkdown);
      document.getElementById("nbsDownloadSpecHtml").onclick = () => {
        const html = buildNbsSpecHtml(payload);
        downloadBlob(html, "nbs-spec.html", "text/html");
      };
      document.getElementById("nbsDownloadSpecPdf").onclick = () => {
        const html = buildNbsSpecHtml(payload);
        const printWindow = window.open("", "_blank");
        if(!printWindow) return;
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
      };
      document.getElementById("nbsPrevReview").onclick = () => {
        nbsWizardState.stepIndex = 2;
        renderNbsWizard();
      };
    }

    function renderAttachmentsList(){
      const attachments = nbsWizardState.externalWall.attachments;
      if(!attachments.length) return `<div class="item">No attachments added.</div>`;
      return `
        <div class="wizardList">
          ${attachments.map((att, idx) => `
            <div class="item">
              <div><b>${escapeHtml(att.name || `Attachment ${idx + 1}`)}</b></div>
              <div class="muted">${escapeHtml(att.type)} - ${escapeHtml(att.contentOrUrl || "")}</div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function renderOptions(options, selected){
      return options.map(opt => {
        const value = opt;
        const label = opt || "Selectâ€¦";
        return `<option value="${escapeHtml(value)}" ${value === selected ? "selected" : ""}>${escapeHtml(label)}</option>`;
      }).join("");
    }

    function isProjectValid(){
      const p = nbsWizardState.project;
      return p.projectName.trim() && p.projectType.trim() && p.location.trim() && p.stage.trim();
    }

    function isExternalWallValid(){
      const summary = nbsWizardState.externalWall.summary;
      const requiredSummary = summary.wallSystemType && summary.totalThicknessMm && summary.externalFinish && summary.internalFinish;
      const layersOk = nbsWizardState.externalWall.layers.length > 0 && nbsWizardState.externalWall.layers.every(layer =>
        layer.layerName && layer.material && layer.thicknessMm && layer.function
      );
      return requiredSummary && layersOk && nbsWizardState.externalWall.performance.fireRating;
    }

    function getNbsIssues(){
      const blocking = [];
      const warnings = [];
      if(!isProjectValid()){
        if(!nbsWizardState.project.projectName.trim()) blocking.push("Project name is required.");
        if(!nbsWizardState.project.projectType.trim()) blocking.push("Project type is required.");
        if(!nbsWizardState.project.location.trim()) blocking.push("Location is required.");
        if(!nbsWizardState.project.stage.trim()) blocking.push("Stage is required.");
      }
      if(nbsWizardState.elementsSelected.length === 0){
        blocking.push("Select at least one element.");
      }
      const summary = nbsWizardState.externalWall.summary;
      if(nbsWizardState.elementsSelected.includes("External Wall")){
        if(!summary.wallSystemType) blocking.push("External wall system type is required.");
        if(!summary.totalThicknessMm) blocking.push("External wall total thickness is required.");
        if(!summary.externalFinish) blocking.push("External wall external finish is required.");
        if(!summary.internalFinish) blocking.push("External wall internal finish is required.");
        if(nbsWizardState.externalWall.layers.length === 0){
          blocking.push("Add at least one build-up layer.");
        }
      }
      if(nbsWizardState.externalWall.performance.fireRating === "None/Unknown"){
        warnings.push("Fire rating is set to None/Unknown.");
      }
      const thicknessMismatch = getThicknessMismatch();
      if(thicknessMismatch > 5){
        warnings.push(`Total thickness differs from sum of layers by ${thicknessMismatch} mm.`);
      }
      return { blocking, warnings };
    }

    function getThicknessMismatch(){
      const total = Number(nbsWizardState.externalWall.summary.totalThicknessMm || 0);
      const sum = nbsWizardState.externalWall.layers.reduce((acc, layer) => acc + Number(layer.thicknessMm || 0), 0);
      return Math.abs(total - sum);
    }

    function buildNbsPayload(){
      const elements = [];
      if(nbsWizardState.elementsSelected.includes("External Wall")){
        elements.push({
          elementType: "ExternalWall",
          summary: { ...nbsWizardState.externalWall.summary },
          layers: nbsWizardState.externalWall.layers.map(layer => ({ ...layer })),
          performance: { ...nbsWizardState.externalWall.performance },
          standards: { ...nbsWizardState.externalWall.standards },
          attachments: nbsWizardState.externalWall.attachments.map(att => ({ ...att }))
        });
      }
      nbsWizardState.elementsSelected.forEach(element => {
        if(element !== "External Wall"){
          elements.push({
            elementType: element.replace(/\s+/g, ""),
            summary: {},
            layers: [],
            performance: {},
            standards: {},
            attachments: []
          });
        }
      });
      return {
        project: { ...nbsWizardState.project },
        elements
      };
    }

    function buildNbsSpecMarkdown(payload){
      const lines = [];
      lines.push(`# Specification Document`);
      lines.push(`Project: ${payload.project.projectName}`);
      lines.push(`Location: ${payload.project.location}`);
      lines.push(`Stage: ${payload.project.stage}`);
      if(payload.project.performanceTargets){
        lines.push(`Performance targets: ${payload.project.performanceTargets}`);
      }
      lines.push("");
      payload.elements.forEach(element => {
        if(element.elementType === "ExternalWall"){
          lines.push(`## External walls`);
          lines.push(`- System type: ${element.summary.wallSystemType || "Not specified"}`);
          lines.push(`- Total thickness: ${element.summary.totalThicknessMm || "Not specified"} mm`);
          lines.push(`- External finish: ${element.summary.externalFinish || "Not specified"}`);
          lines.push(`- Internal finish: ${element.summary.internalFinish || "Not specified"}`);
          lines.push(`- Fire rating: ${element.performance.fireRating || "None/Unknown"} minutes`);
          if(element.performance.targetUValue) lines.push(`- Target U-value: ${element.performance.targetUValue} W/mÂ²K`);
          if(element.performance.acousticRequirement) lines.push(`- Acoustic requirement: ${element.performance.acousticRequirement}`);
          if(element.performance.moistureStrategy) lines.push(`- Moisture strategy: ${element.performance.moistureStrategy}`);
          if(element.performance.airtightnessNotes) lines.push(`- Airtightness notes: ${element.performance.airtightnessNotes}`);
          lines.push(`- Build-up layers:`);
          element.layers.forEach((layer, idx) => {
            lines.push(`  - Layer ${idx + 1}: ${layer.layerName} | ${layer.material} | ${layer.thicknessMm} mm | ${layer.function}`);
          });
          if(element.standards.standardsNotes){
            lines.push(`- Standards notes: ${element.standards.standardsNotes}`);
          }
          lines.push("");
          return;
        }
        const heading = element.elementType
          .replace(/([A-Z])/g, " $1")
          .replace(/\s+/g, " ")
          .trim();
        lines.push(`## ${heading}`);
        lines.push(`- Module stub: details to be completed.`);
        lines.push("");
      });
      return lines.join("\n");
    }

    function buildNbsSpecHtml(payload){
      const markdown = buildNbsSpecMarkdown(payload);
      const htmlLines = markdown.split("\n").map(line => {
        if(line.startsWith("## ")){ return `<h2>${escapeHtml(line.replace("## ", ""))}</h2>`; }
        if(line.startsWith("# ")){ return `<h1>${escapeHtml(line.replace("# ", ""))}</h1>`; }
        if(line.startsWith("- ")){ return `<li>${escapeHtml(line.replace("- ", ""))}</li>`; }
        if(line.trim() === "") return "<br/>";
        return `<p>${escapeHtml(line)}</p>`;
      }).join("\n");
      return `
        <html>
          <head>
            <meta charset="utf-8"/>
            <title>Specification Document</title>
            <style>
              body{ font-family: Arial, sans-serif; padding: 24px; line-height: 1.6; }
              h1{ margin-bottom: 8px; }
              h2{ margin-top: 18px; }
              ul{ margin-left: 18px; }
            </style>
          </head>
          <body>${htmlLines}</body>
        </html>
      `;
    }

    function copyToClipboard(text){
      navigator.clipboard.writeText(text).then(() => showToast("Copied to clipboard."), () => showToast("Copy failed."));
    }

    function downloadBlob(content, filename, type){
      const blob = new Blob([content], { type: type || "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }


    // =========================================================
    // Particles
    // =========================================================
    const canvas = document.getElementById("particles");
    const ctx = canvas.getContext("2d");
    let W=0,H=0, particles=[];
    function resize(){
      W = canvas.width = window.innerWidth;
      H = canvas.height = window.innerHeight;
      const base = Math.floor(Math.min(90, Math.max(40, W/24)));
      particles = Array.from({length:base}).map(()=>( {
        x: Math.random()*W,
        y: Math.random()*H,
        r: Math.random()*1.4 + 0.4,
        vx:(Math.random()*0.22+0.05)*(Math.random()<0.5?-1:1),
        vy:(Math.random()*0.18+0.04)*(Math.random()<0.5?-1:1),
        a: Math.random()*0.45 + 0.10
      }));
    }
    window.addEventListener("resize", resize);
    resize();
    function tick(){
      ctx.clearRect(0,0,W,H);
      for(const p of particles){
        p.x += p.vx; p.y += p.vy;
        if(p.x < -20) p.x = W+20;
        if(p.x > W+20) p.x = -20;
        if(p.y < -20) p.y = H+20;
        if(p.y > H+20) p.y = -20;
        ctx.globalAlpha = p.a;
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fillStyle = "white";
        ctx.fill();
      }
      ctx.globalAlpha = 1;
      requestAnimationFrame(tick);
    }
    if(!window.matchMedia("(prefers-reduced-motion: reduce)").matches){ tick(); }

    // =========================================================
    // Status monitor (cold-start friendly)
    // =========================================================
    const apiPill = document.getElementById("apiPill");
    const btnStatus = document.getElementById("btnStatus");

    const STATUS = {
      state: "checking",          // checking | online | waking | offline
      lastOkTs: 0,
      lastErr: "",
      attempts: 0,
      lastJson: null,
      warmTimer: null,
      pollTimer: null,
      wakingTimer: null
    };

    function setPill(state, text){
      apiPill.classList.remove("live","warn","bad");
      if(state === "online") apiPill.classList.add("live");
      if(state === "checking" || state === "waking") apiPill.classList.add("warn");
      if(state === "offline") apiPill.classList.add("bad");
      apiPill.textContent = text;
    }

    async function fetchWithTimeout(url, options, ms){
      const controller = new AbortController();
      const timer = setTimeout(()=> controller.abort(), ms);
      try{
        return await fetch(url, {
          ...options,
          mode: "cors",
          cache: "no-store",
          signal: controller.signal
        });
      } finally {
        clearTimeout(timer);
      }
    }

    async function pingHealth(){
      const url = apiUrl(CONFIG.HEALTH_PATH);
      try{
        const res = await fetchWithTimeout(url, { method:"GET" }, CONFIG.HEALTH_TIMEOUT_MS);
        const txt = await res.text().catch(()=> "");
        let json = null;
        try{ json = JSON.parse(txt); }catch(e){ /* ignore */ }
        if(res.ok){
          STATUS.lastOkTs = Date.now();
          STATUS.lastErr = "";
          STATUS.lastJson = json;
          return { ok:true, json };
        }
        STATUS.lastErr = "HTTP " + res.status + " " + txt.slice(0,300);
        return { ok:false, err: STATUS.lastErr };
      }catch(e){
        const isAbort = String(e && e.name).includes("AbortError");
        STATUS.lastErr = isAbort ? "Health check timed out" : ("Health check failed: " + (e && e.message ? e.message : String(e)));
        return { ok:false, err: STATUS.lastErr };
      }
    }

    function scheduleWakingLoop(){
      clearInterval(STATUS.wakingTimer);
      STATUS.wakingTimer = setInterval(async ()=>{
        if(STATUS.state !== "waking") return;
        const dots = ".".repeat((STATUS.attempts % 3) + 1);
        setPill("waking", "Waking server" + dots);

        const r = await pingHealth();
        STATUS.attempts++;

        if(r.ok){
          STATUS.state = "online";
          STATUS.attempts = 0;
          setPill("online", "Online");
          showToast("Backend is online.");
          clearInterval(STATUS.wakingTimer);
        } else {
          if(STATUS.attempts > 8){
            STATUS.state = "offline";
            setPill("offline", "Offline");
            clearInterval(STATUS.wakingTimer);
          }
        }
      }, 3500);
    }

    async function refreshStatusPill(){
      setPill("checking", "Checkingâ€¦");
      const r = await pingHealth();
      if(r.ok){
        STATUS.state = "online";
        STATUS.attempts = 0;
        setPill("online", "Online");
        return;
      }
      STATUS.state = "waking";
      STATUS.attempts = 0;
      setPill("waking", "Waking serverâ€¦");
      scheduleWakingLoop();
    }

    btnStatus.onclick = async ()=>{
      const r = await pingHealth();
      const json = r.ok ? (r.json || { ok:true }) : null;

      if(r.ok){
        openModal(
          "Backend status",
          JSON.stringify({
            api_base: API_BASE,
            state: STATUS.state,
            last_ok: STATUS.lastOkTs ? new Date(STATUS.lastOkTs).toLocaleString() : null,
            health: json
          }, null, 2),
          [{ label:"Close", onClick: closeModal }]
        );
        showToast("Online.");
      } else {
        openModal(
          "Backend status",
          [
            "API Base: " + API_BASE,
            "State: " + STATUS.state,
            "",
            "Error:",
            STATUS.lastErr || "Unknown error",
            "",
            "Tip:",
            "If you're on Render free-tier, cold starts are normal.",
            "Turn on 'Keep warm' in Chat to reduce cold starts."
          ].join("\n"),
          [
            { label:"Close", onClick: closeModal },
            { label:"Retry now", primary:true, onClick: async ()=>{ closeModal(); await refreshStatusPill(); } }
          ]
        );
      }
    };

    // Start status polling
    refreshStatusPill();
    STATUS.pollTimer = setInterval(() => {
      if(STATUS.state === "online") refreshStatusPill();
      if(STATUS.state === "offline") {
        STATUS.state = "waking";
        STATUS.attempts = 0;
        scheduleWakingLoop();
      }
    }, CONFIG.STATUS_POLL_MS);

    // Shortcuts modal
    document.getElementById("btnShortcuts").onclick = ()=>{
      openModal(
        "Keyboard shortcuts",
        [
          "Enter  â€” Send message",
          "Shift + Enter  â€” New line",
          "/  â€” Focus message input",
          "Ctrl + K  â€” Clear chat",
          "Esc  â€” Close dialogs"
        ].join("\n"),
        [{ label:"Close", onClick: closeModal }]
      );
    };

    // =========================================================
    // Chat state + delete UX (same behavior)
    // =========================================================
    const chatBox = document.getElementById("chatBox");
    const msgEl = document.getElementById("msg");

    // =========================================================
    // Module navigation
    // =========================================================
    document.querySelectorAll("[data-module]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const moduleId = btn.getAttribute("data-module");
        if(moduleId) showModule(moduleId);
      });
    });
    const sendBtn = document.getElementById("send");
    const forceDocsEl = document.getElementById("forceDocs");
    const typewriterEl = document.getElementById("typewriter");
    const fastModeEl = document.getElementById("fastMode");
    const keepWarmEl = document.getElementById("keepWarm");

    const btnClear = document.getElementById("btnClear");
    const btnNewChat = document.getElementById("btnNewChat");
    const chatItemsWrap = document.getElementById("chatItems");
    const btnDeleteAllChats = document.getElementById("btnDeleteAllChats");
    const chatFilterEl = document.getElementById("chatFilter");
    const btnExportChat = document.getElementById("btnExportChat");

    const STORAGE_KEY = "raheem_ai_chats_v6";
    const ACTIVE_CHAT_KEY = "raheem_active_chat_id";
    const CHAT_ID_KEY = "complyr_chat_id";
    const ACTIVE_PDF_KEY = "complyr_active_pdf";

    function getChatId(){
      let chatId = (localStorage.getItem(CHAT_ID_KEY) || "").trim();
      if(!chatId){
        chatId = "chat_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
        localStorage.setItem(CHAT_ID_KEY, chatId);
      }
      return chatId;
    }

    let activePdf = (localStorage.getItem(ACTIVE_PDF_KEY) || "").trim();
    function setActivePdf(pdfName){
      activePdf = (pdfName || "").trim();
      if(activePdf){
        localStorage.setItem(ACTIVE_PDF_KEY, activePdf);
      } else {
        localStorage.removeItem(ACTIVE_PDF_KEY);
      }
    }

    function loadAllChats(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
      catch(e){ return {}; }
    }
    function saveAllChats(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    function newChatId(){ return "chat_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7); }

    function fmtTime(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleString(undefined, { day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit" });
      }catch(e){ return ""; }
    }

    let activeChatId = (localStorage.getItem(ACTIVE_CHAT_KEY) || "").trim() || null;
    function persistActiveChatId(){ if(activeChatId) localStorage.setItem(ACTIVE_CHAT_KEY, activeChatId); }

    function ensureActiveChat(){
      const all = loadAllChats();
      if(activeChatId && all[activeChatId]){ persistActiveChatId(); return all; }
      activeChatId = newChatId();
      all[activeChatId] = {
        title: "New chat",
        updated: Date.now(),
        messages: [{ role:"assistant", content:"Hello. How can I help today?" }]
      };
      saveAllChats(all);
      persistActiveChatId();
      return all;
    }

    async function refreshPdfs(){
      try{
        const res = await fetchWithTimeout(apiUrl(CONFIG.PDFS_PATH), { method:"GET" }, 8000);
        if(!res.ok) return;
        const data = await res.json().catch(()=> null);
        const pdfs = Array.isArray(data && data.pdfs) ? data.pdfs : [];
        if(!pdfs.length) return;
        if(activePdf && pdfs.includes(activePdf)) return;
        setActivePdf(pdfs[0]);
      }catch(e){
        /* ignore */
      }
    }

    async function refreshPdfs(){
      try{
        const res = await fetchWithTimeout(apiUrl(CONFIG.PDFS_PATH), { method:"GET" }, 8000);
        if(!res.ok) return;
        const data = await res.json().catch(()=> null);
        const pdfs = Array.isArray(data && data.pdfs) ? data.pdfs : [];
        if(!pdfs.length) return;
        if(activePdf && pdfs.includes(activePdf)) return;
        setActivePdf(pdfs[0]);
      }catch(e){
        /* ignore */
      }
    }

    async function refreshPdfs(){
      try{
        const res = await fetchWithTimeout(apiUrl(CONFIG.PDFS_PATH), { method:"GET" }, 8000);
        if(!res.ok) return;
        const data = await res.json().catch(()=> null);
        const pdfs = Array.isArray(data && data.pdfs) ? data.pdfs : [];
        if(!pdfs.length) return;
        if(activePdf && pdfs.includes(activePdf)) return;
        setActivePdf(pdfs[0]);
      }catch(e){
        /* ignore */
      }
    }

    async function refreshPdfs(){
      try{
        const res = await fetchWithTimeout(apiUrl(CONFIG.PDFS_PATH), { method:"GET" }, 8000);
        if(!res.ok) return;
        const data = await res.json().catch(()=> null);
        const pdfs = Array.isArray(data && data.pdfs) ? data.pdfs : [];
        if(!pdfs.length) return;
        if(activePdf && pdfs.includes(activePdf)) return;
        setActivePdf(pdfs[0]);
      }catch(e){
        /* ignore */
      }
    }

    function setChatTitleFromFirstUser(all, chatId){
      const c = all[chatId]; if(!c) return;
      const firstUser = (c.messages || []).find(m=>m.role==="user");
      if(firstUser && (c.title==="New chat" || !c.title)){
        const s = (firstUser.content || "").trim();
        c.title = s.slice(0, 44) + (s.length>44 ? "..." : "");
      }
    }

    // Undo buffer
    let lastDeleted = null; // { chatId, chatObj }
    function offerUndoToast(){
      if(!lastDeleted) return;
      showToast("Chat deleted.", [
        { label:"Undo", onClick: ()=>{
          const all = loadAllChats();
          all[lastDeleted.chatId] = lastDeleted.chatObj;
          saveAllChats(all);
          activeChatId = lastDeleted.chatId;
          persistActiveChatId();
          lastDeleted = null;
          renderChatList();
          renderChat();
          showToast("Restored.");
        }}
      ]);
      setTimeout(()=>{ lastDeleted = null; }, 6000);
    }

    function escapeHtml(s){
      return (s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function closeAllMenus(){
      document.querySelectorAll(".menu.show").forEach(m=>m.classList.remove("show"));
    }
    document.addEventListener("click", (e)=>{
      const inMenu = e.target && (e.target.closest && e.target.closest(".menu"));
      const inMenuBtn = e.target && (e.target.closest && e.target.closest("[data-menubtn]"));
      if(!inMenu && !inMenuBtn) closeAllMenus();
    });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeAllMenus(); });

    function deleteChatConfirm(chatId){
      const all = loadAllChats();
      const c = all[chatId];
      if(!c) return;

      openModal(
        "Delete chat?",
        [
          "This will delete:",
          "â€¢ " + (c.title || "New chat"),
          "",
          "You can undo for a few seconds after deleting."
        ].join("\n"),
        [
          { label:"Cancel", onClick: closeModal },
          { label:"Delete", primary:true, onClick: ()=>{
            closeModal();
            const all2 = loadAllChats();
            const chatObj = all2[chatId];
            if(!chatObj) return;

            lastDeleted = { chatId, chatObj };
            delete all2[chatId];

            if(chatId === activeChatId){
              const remaining = Object.keys(all2).sort((a,b)=>(all2[b].updated||0)-(all2[a].updated||0));
              activeChatId = remaining[0] || null;
              if(!activeChatId){
                saveAllChats(all2);
                localStorage.removeItem(ACTIVE_CHAT_KEY);
                ensureActiveChat();
              } else {
                persistActiveChatId();
                saveAllChats(all2);
              }
            } else {
              saveAllChats(all2);
            }

            renderChatList();
            renderChat();
            offerUndoToast();
          }}
        ]
      );
    }

    function renameChatPrompt(chatId){
      const all = loadAllChats();
      const c = all[chatId];
      if(!c) return;

      openModal(
        "Rename chat",
        "Enter a new chat title in the box below:",
        [
          { label:"Cancel", onClick: closeModal },
          { label:"Rename", primary:true, onClick: ()=>{
            const newTitle = (document.getElementById("__renameInput")?.value || "").trim();
            if(!newTitle){
              showToast("Title can't be empty.");
              return;
            }
            const all2 = loadAllChats();
            if(!all2[chatId]) return;
            all2[chatId].title = newTitle.slice(0, 80);
            all2[chatId].updated = Date.now();
            saveAllChats(all2);
            closeModal();
            renderChatList();
            showToast("Renamed.");
          }}
        ]
      );

      modalBody.innerHTML = `
        <div style="color: rgba(244,247,255,.88); margin-bottom:10px; line-height:1.5;">
          Enter a new chat title:
        </div>
        <input id="__renameInput" type="text" value="${escapeHtml(c.title || "New chat")}"
          style="width:100%; padding: 12px 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,.14);
          background: rgba(0,0,0,.20); color: rgba(244,247,255,.95); outline:none;"
        />
        <div style="margin-top:10px; color: rgba(244,247,255,.60); font-size: 12px;">
          Tip: Keep it short like â€œBER checks â€“ Dwelling Aâ€.
        </div>
      `;
      setTimeout(()=> document.getElementById("__renameInput")?.focus(), 50);
    }

    function exportChat(chatId){
      const all = loadAllChats();
      const c = all[chatId];
      if(!c) return;

      const title = (c.title || "raheem-ai-chat").replace(/[^\w\- ]+/g, "").trim().replace(/\s+/g, "-").toLowerCase() || "raheem-ai-chat";
      const lines = [];
      (c.messages||[]).forEach(m=>{
        const who = m.role === "user" ? "USER" : "ASSISTANT";
        lines.push("[" + who + "]\n" + (m.content || "") + "\n");
      });
      const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = title + ".txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      showToast("Exported chat.");
    }

    function renderChatList(){
      const all = ensureActiveChat();
      const q = (chatFilterEl.value || "").trim().toLowerCase();

      const ids = Object.keys(all)
        .sort((a,b)=>(all[b].updated||0)-(all[a].updated||0))
        .filter(id=>{
          if(!q) return true;
          const c = all[id];
          const title = (c.title || "").toLowerCase();
          if(title.includes(q)) return true;
          const msgs = (c.messages||[]);
          return msgs.slice(-20).some(m => (m.content||"").toLowerCase().includes(q));
        });

      chatItemsWrap.innerHTML = "";
      ids.forEach(id=>{
        const c = all[id];
        const row = document.createElement("div");
        row.style.position = "relative";

        const btn = document.createElement("button");
        btn.className = "chatitem" + (id===activeChatId ? " active" : "");
        btn.type = "button";

        const title = c.title || "New chat";
        const time = fmtTime(c.updated || Date.now());
        const msgCount = (c.messages||[]).length;

        btn.innerHTML = `
          <div class="metaWrap">
            <div class="t">${escapeHtml(title)}</div>
            <div class="s">
              <span>${escapeHtml(time)}</span><span style="opacity:.7">â€¢</span>
              <span class="chip">${msgCount} msgs</span>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-shrink:0;">
            <button class="iconBtn" data-menubtn="1" type="button" aria-label="Chat menu" title="More" style="width:38px;height:38px;border-radius:14px;">â‹¯</button>
          </div>
        `;

        const menu = document.createElement("div");
        menu.className = "menu";
        menu.innerHTML = `
          <button type="button" data-act="open">Open <span style="opacity:.65">â†©</span></button>
          <button type="button" data-act="rename">Rename <span style="opacity:.65">âœŽ</span></button>
          <button type="button" data-act="export">Export <span style="opacity:.65">â‡©</span></button>
          <div class="sep"></div>
          <button type="button" data-act="delete" style="color: rgba(255,215,242,.95);">Delete <span style="opacity:.65">ðŸ—‘</span></button>
        `;

        btn.addEventListener("click", (ev)=>{
          const menuBtn = ev.target && ev.target.closest && ev.target.closest("[data-menubtn]");
          if(menuBtn) return;
          activeChatId = id;
          persistActiveChatId();
          renderChatList();
          renderChat();
        });

        const menuBtn = btn.querySelector("[data-menubtn]");
        menuBtn.addEventListener("click", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const showing = menu.classList.contains("show");
          closeAllMenus();
          if(!showing) menu.classList.add("show");
        });

        menu.addEventListener("click", (ev)=>{
          const act = ev.target && ev.target.getAttribute && ev.target.getAttribute("data-act");
          if(!act) return;
          ev.preventDefault();
          ev.stopPropagation();
          closeAllMenus();
          if(act === "open"){
            activeChatId = id;
            persistActiveChatId();
            renderChatList();
            renderChat();
            return;
          }
          if(act === "rename") return renameChatPrompt(id);
          if(act === "export") return exportChat(id);
          if(act === "delete") return deleteChatConfirm(id);
        });

        row.appendChild(btn);
        row.appendChild(menu);
        chatItemsWrap.appendChild(row);
      });

      if(!ids.length){
        const empty = document.createElement("div");
        empty.style.padding = "10px 6px";
        empty.style.color = "rgba(244,247,255,.65)";
        empty.style.fontSize = "12px";
        empty.textContent = "No chats match your search.";
        chatItemsWrap.appendChild(empty);
      }
    }

    function attachMsgTools(aiDiv, text){
      const tools = document.createElement("div");
      tools.className = "msgTools";

      const copyBtn = document.createElement("button");
      copyBtn.className = "miniBtn";
      copyBtn.type = "button";
      copyBtn.textContent = "Copy";
      copyBtn.onclick = async ()=>{
        try{ await navigator.clipboard.writeText(text || ""); showToast("Copied."); }
        catch(e){ showToast("Copy failed."); }
      };

      const quoteBtn = document.createElement("button");
      quoteBtn.className = "miniBtn";
      quoteBtn.type = "button";
      quoteBtn.textContent = "Quote";
      quoteBtn.onclick = ()=>{
        const q = (text || "").trim();
        if(!q) return;
        const snippet = q.length > 700 ? q.slice(0,700) + "â€¦" : q;
        msgEl.value = (msgEl.value ? (msgEl.value + "\n\n") : "") + "> " + snippet.replace(/\n/g, "\n> ");
        msgEl.focus();
        showToast("Quoted into input.");
      };

      const openBtn = document.createElement("button");
      openBtn.className = "miniBtn";
      openBtn.type = "button";
      openBtn.textContent = "Open";
      openBtn.onclick = ()=> openModal("Assistant reply", text || "", [{ label:"Close", onClick: closeModal }]);

      tools.appendChild(copyBtn);
      tools.appendChild(quoteBtn);
      tools.appendChild(openBtn);
      aiDiv.appendChild(tools);
    }

    function addMsg(who, text, scroll=true){
      const div = document.createElement("div");
      div.className = "msg " + (who==="user" ? "user" : "ai");
      div.textContent = text;
      chatBox.appendChild(div);
      if(who !== "user") attachMsgTools(div, text);
      if(scroll) chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    function addTypingIndicator(targetDiv){
      const wrap = document.createElement("div");
      wrap.className = "typing";
      wrap.innerHTML = `<span>Raheem AI is responding</span><span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      targetDiv.appendChild(wrap);
      return wrap;
    }

    function renderChat(){
      const all = ensureActiveChat();
      const c = all[activeChatId];
      chatBox.innerHTML = "";
      (c.messages||[]).forEach(m=> addMsg(m.role==="user" ? "user" : "ai", m.content, false));
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function clearChat(){
      const all = ensureActiveChat();
      all[activeChatId].messages = [{ role:"assistant", content:"Cleared. What would you like to do next?" }];
      all[activeChatId].updated = Date.now();
      saveAllChats(all);
      renderChat();
      renderChatList();
      showToast("Chat cleared.");
    }
    document.getElementById("btnClear").onclick = clearChat;

    document.getElementById("btnNewChat").onclick = ()=>{
      const all = loadAllChats();
      activeChatId = newChatId();
      all[activeChatId] = {
        title: "New chat",
        updated: Date.now(),
        messages: [{ role:"assistant", content:"Hello. How can I help today?" }]
      };
      saveAllChats(all);
      persistActiveChatId();
      renderChatList();
      renderChat();
      showToast("New chat created.");
    };

    document.getElementById("btnDeleteAllChats").onclick = ()=>{
      openModal(
        "Delete ALL chats?",
        [
          "This removes every saved chat from this browser.",
          "",
          "This cannot be undone."
        ].join("\n"),
        [
          { label:"Cancel", onClick: closeModal },
          { label:"Delete all", primary:true, onClick: ()=>{
            closeModal();
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(ACTIVE_CHAT_KEY);
            activeChatId = null;
            ensureActiveChat();
            renderChatList();
            renderChat();
            showToast("All chats deleted.");
          }}
        ]
      );
    };

    chatFilterEl.addEventListener("input", ()=> renderChatList());
    btnExportChat.onclick = ()=> exportChat(activeChatId);

    // Init chat state once
    ensureActiveChat();
    refreshPdfs();
    setInterval(refreshPdfs, 30000);

    // =========================================================
    // SSE parsing + streaming
    // =========================================================
    function typewriterSet(el, text){
      el.textContent = "";
      let i = 0;
      const step = ()=>{
        i += Math.max(2, Math.floor(text.length / 240));
        el.textContent = text.slice(0, i);
        if(i < text.length) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    async function fetchChat(url, body){
      try{
        return await fetchWithTimeout(url, {
          method: "POST",
          headers: { "Content-Type":"application/json", "Accept":"text/event-stream" },
          body
        }, CONFIG.CHAT_TIMEOUT_MS);
      }catch(e){
        if(CONFIG.CHAT_RETRY_ONCE){
          await new Promise(r=>setTimeout(r, 650));
          return await fetchWithTimeout(url, {
            method: "POST",
            headers: { "Content-Type":"application/json", "Accept":"text/event-stream" },
            body
          }, CONFIG.CHAT_TIMEOUT_MS);
        }
        throw e;
      }
    }

    // =========================================================
    // Send chat: no infinite "thinking"
    // =========================================================
    async function send(){
      const text = (msgEl.value || "").trim();
      if(!text) return;
      msgEl.value = "";

      if(STATUS.state === "offline" || STATUS.state === "waking"){
        setPill("waking", "Waking serverâ€¦");
        const r = await pingHealth();
        if(!r.ok){
          showToast("Backend status check failed. Attempting chat anyway.");
        } else {
          STATUS.state = "online";
          setPill("online", "Online");
        }
      }

      const all = ensureActiveChat();
      const c = all[activeChatId];
      c.messages.push({ role:"user", content:text });
      c.updated = Date.now();
      setChatTitleFromFirstUser(all, activeChatId);
      saveAllChats(all);

      addMsg("user", text);
      const aiDiv = addMsg("ai", "");
      const typing = addTypingIndicator(aiDiv);

      const chatId = getChatId();
      const url =
        apiUrl(CONFIG.CHAT_PATH)
        + "?pdf=" + encodeURIComponent(activePdf || "")
        + "&chat_id=" + encodeURIComponent(chatId);

      const body = JSON.stringify({ message: text });

      let full = "";
      let gotAnyToken = false;

      const watchdog = setTimeout(() => {
        try{
          if(typing && typing.parentNode) typing.parentNode.removeChild(typing);
          const msg = "No response received (timeout). Try again.";
          aiDiv.textContent = msg;
          attachMsgTools(aiDiv, msg);
        }catch(e){}
      }, CONFIG.CHAT_TIMEOUT_MS + 1200);

      try{
        const res = await fetchChat(url, body);

        if(!res.ok){
          const errText = await res.text().catch(()=>"(no error body)");
          if(typing && typing.parentNode) typing.parentNode.removeChild(typing);
          const msg = "Server error " + res.status + ": " + (errText || "").slice(0, 1600);
          aiDiv.textContent = msg;
          attachMsgTools(aiDiv, msg);
          STATUS.state = "offline";
          setPill("offline", "Offline");
          return;
        }

        const reader = res.body && res.body.getReader ? res.body.getReader() : null;
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        let doneSeen = false;

        const applyDelta = (delta)=>{
          if(!delta) return;
          gotAnyToken = true;
          if(typing && typing.parentNode) typing.parentNode.removeChild(typing);
          full += delta;
          aiDiv.textContent = full;
          chatBox.scrollTop = chatBox.scrollHeight;
        };

        const handleLine = (line)=>{
          const trimmed = (line || "").trim();
          if(!trimmed) return;
          if(trimmed.includes("event: done")){
            doneSeen = true;
            return;
          }
          if(trimmed.startsWith("data:")){
            const delta = trimmed.replace(/^data:\s?/, "").replaceAll("\\n","\n");
            applyDelta(delta);
          }
        };

        if(!reader){
          const raw = await res.text().catch(()=> "");
          raw.split(/\r?\n/).forEach(handleLine);
        } else {
          while(true){
            const { value, done } = await reader.read();
            if(done) break;
            buffer += decoder.decode(value, { stream:true });
            const lines = buffer.split(/\r?\n/);
            buffer = lines.pop() || "";
            for(const line of lines){
              handleLine(line);
              if(doneSeen) break;
            }
            if(doneSeen) break;
          }
          if(buffer && !doneSeen){
            handleLine(buffer);
          }
        }

        if(!gotAnyToken && typing && typing.parentNode) typing.parentNode.removeChild(typing);

        const finalText = full.trim() || " ";
        if(typewriterEl.checked && finalText.length < 4500) typewriterSet(aiDiv, finalText);
        else aiDiv.textContent = finalText;
        attachMsgTools(aiDiv, finalText);

        const all2 = ensureActiveChat();
        const c2 = all2[activeChatId];
        c2.messages.push({ role:"assistant", content: finalText });
        c2.updated = Date.now();
        saveAllChats(all2);
        renderChatList();

        STATUS.state = "online";
        setPill("online", "Online");
      }catch(e){
        console.error("Chat send error:", e);
        if(typing && typing.parentNode) typing.parentNode.removeChild(typing);

        let msg = "Connection error. Try again.";
        if(String(e && e.name).includes("AbortError")){
          msg = "Request timed out (cold start or slow backend). Try again.";
        }
        aiDiv.textContent = msg;
        attachMsgTools(aiDiv, msg);

        STATUS.state = "waking";
        setPill("waking", "Waking serverâ€¦");
        scheduleWakingLoop();
      }finally{
        clearTimeout(watchdog);
      }
    }

    sendBtn.onclick = send;
    msgEl.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // =========================================================
    // Keep-warm ping (optional)
    // =========================================================
    function setKeepWarm(on){
      localStorage.setItem("RAHEEM_KEEP_WARM", on ? "1" : "0");
      clearInterval(STATUS.warmTimer);
      if(!on) return;

      STATUS.warmTimer = setInterval(async ()=>{
        try{
          await fetchWithTimeout(apiUrl(CONFIG.HEALTH_PATH), { method:"GET" }, 8000);
        }catch(e){ /* ignore */ }
      }, CONFIG.WARM_PING_MS);
    }
    keepWarmEl.checked = (localStorage.getItem("RAHEEM_KEEP_WARM") === "1");
    setKeepWarm(keepWarmEl.checked);
    keepWarmEl.addEventListener("change", ()=>{
      setKeepWarm(keepWarmEl.checked);
      showToast(keepWarmEl.checked ? "Keep warm enabled." : "Keep warm disabled.");
    });

    // =========================================================
    // Keyboard shortcuts
    // =========================================================
    document.addEventListener("keydown", (e)=>{
      if(e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
        const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
        if(tag !== "textarea" && tag !== "input"){
          e.preventDefault();
          showView("chat");
          msgEl.focus();
        }
      }
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
        e.preventDefault();
        clearChat();
      }
    });

    // Make sure first render happens if user lands in Chat
    window.addEventListener("DOMContentLoaded", ()=>{
      const saved = (localStorage.getItem("RAHEEM_VIEW") || "home").toLowerCase();
      if(saved === "chat"){
        renderChatList();
        renderChat();
      }
    });
  </script>
</body>
</html>

