<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raheem AI</title>

  <meta name="description" content="Raheem AI ‚Äî compliance-first chat and document reasoning for building workflows." />
  <meta name="theme-color" content="#050610" />
  <meta property="og:title" content="Raheem AI" />
  <meta property="og:description" content="Compliance-first chat and document reasoning for building workflows." />
  <meta property="og:type" content="website" />

  <style>
    :root{
      --bg0:#050610; --bg1:#070a18; --bg2:#0a0f22;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.11);
      --stroke: rgba(255,255,255,.14);
      --text:#f4f7ff;
      --muted: rgba(244,247,255,.78);
      --muted2: rgba(244,247,255,.60);

      --a1:#50ffd7; --a2:#65b7ff; --a3:#c7a5ff; --hot:#ff4fd8;
      --ok: rgba(80,255,215,.45);
      --warn: rgba(255,204,102,.42);
      --bad: rgba(255,79,216,.44);

      --shadow: 0 28px 72px rgba(0,0,0,.58);
      --shadow2: 0 18px 48px rgba(0,0,0,.42);

      --r:22px; --r2:16px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --btnPad: 10px 12px;

      --neon1: 0 0 18px rgba(80,255,215,.12), 0 0 34px rgba(101,183,255,.10);
      --neon2: 0 0 18px rgba(255,79,216,.12), 0 0 34px rgba(199,165,255,.08);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: var(--font); color: var(--text);
      background:
        radial-gradient(1200px 700px at 18% -10%, rgba(80,255,215,.14), transparent 60%),
        radial-gradient(1100px 650px at 85% 0%, rgba(101,183,255,.14), transparent 58%),
        radial-gradient(900px 620px at 50% 115%, rgba(199,165,255,.12), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
      overflow-x:hidden;
    }

    /* Background effects */
    .bg-wrap{ position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
    .aurora{
      position:absolute; inset:-25%;
      background:
        radial-gradient(900px 520px at 12% 18%, rgba(80,255,215,.14) 0%, rgba(80,255,215,0) 65%),
        radial-gradient(900px 520px at 88% 14%, rgba(101,183,255,.14) 0%, rgba(101,183,255,0) 62%),
        radial-gradient(980px 560px at 50% 108%, rgba(199,165,255,.12) 0%, rgba(199,165,255,0) 60%),
        radial-gradient(840px 520px at 45% 40%, rgba(255,79,216,.06) 0%, rgba(255,79,216,0) 60%);
      filter: blur(22px); opacity:.85;
      transform: translate3d(0,0,0);
      animation: auroraMove 22s ease-in-out infinite;
    }
    @keyframes auroraMove{
      0%,100%{ transform: translate3d(0,0,0) scale(1); }
      45%{ transform: translate3d(12px,-10px,0) scale(1.02); }
      75%{ transform: translate3d(-12px,10px,0) scale(1.015); }
    }
    canvas#particles{ position:absolute; inset:0; opacity:.18; filter: blur(.2px); }
    .vignette{ position:absolute; inset:-1px; background: radial-gradient(900px 520px at 50% 22%, rgba(0,0,0,0), rgba(0,0,0,.58)); opacity:.9; }
    @media (prefers-reduced-motion: reduce){
      .aurora{ animation:none; }
      canvas#particles{ display:none; }
      .glowline{ display:none; }
    }

    /* Layout */
    .app{
      position:relative; z-index:1;
      min-height:100vh;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 18px;
      padding: 18px;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .side{ position:sticky; top:0; }
    }
    .side, .main{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
      position:relative;
    }
    .main{ box-shadow: var(--shadow); display:flex; flex-direction:column; min-height: calc(100vh - 36px); }

    /* Subtle neon line */
    .glowline{
      position:absolute; left:-120px; right:-120px; top:-40px; height:140px;
      background: radial-gradient(closest-side, rgba(80,255,215,.12), transparent 70%);
      filter: blur(10px);
      opacity:.65;
      pointer-events:none;
    }

    /* Brand */
    .brand{
      display:flex; align-items:center; gap: 12px;
      padding: 16px 16px 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .logoMark{
      width: 46px; height: 46px; border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: var(--neon1);
      display:grid; place-items:center; overflow:hidden; position:relative;
    }
    .logoMark svg{ width:38px; height:38px; opacity:.95; }
    .brand h1{ margin:0; font-size: 18px; letter-spacing:.5px; font-weight: 900; line-height:1.1; }
    .brand h1 span{
      background: linear-gradient(90deg, var(--a1), var(--a2), var(--a3));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 18px rgba(101,183,255,.12);
    }
    .brand .sub{ margin-top:4px; font-size: 12px; color: var(--muted2); line-height:1.2; }

    /* Sidebar nav */
    .nav{ padding: 12px; display:flex; flex-direction:column; gap: 10px; }
    .navbtn{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      width:100%; padding: 12px 12px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
      text-align:left;
    }
    .navbtn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.34);
      background: rgba(0,0,0,.24);
      box-shadow: var(--neon1);
    }
    .navbtn.active{
      border-color: rgba(80,255,215,.34);
      background: linear-gradient(135deg, rgba(80,255,215,.12), rgba(101,183,255,.08));
      box-shadow: var(--neon1);
    }
    .navbtn .left{ display:flex; align-items:center; gap: 10px; min-width:0; }

    .tag{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
      user-select:none;
    }
    .tag.live{ border-color: var(--ok); color: rgba(230,255,240,.92); background: rgba(80,255,215,.10); }
    .tag.warn{ border-color: var(--warn); color: rgba(255,235,200,.95); background: rgba(255,204,102,.10); }
    .tag.bad{  border-color: var(--bad);  color: rgba(255,215,242,.95); background: rgba(255,79,216,.10); }

    /* Saved chats */
    .chatlist{ display:none; padding: 10px 12px 12px 12px; border-top: 1px solid rgba(255,255,255,.10); }
    .chatlist.show{ display:block; }
    .chatlist h3{
      margin: 10px 4px 8px 4px;
      font-size: 12px; color: var(--muted2);
      font-weight:800; letter-spacing:.35px; text-transform:uppercase;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .chatSearch{ padding: 0 12px 10px 12px; }
    .chatSearch input{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
    }
    .chatSearch input:focus{
      border-color: rgba(101,183,255,.40);
      box-shadow: 0 0 0 3px rgba(101,183,255,.12);
    }

    /* Chat list items (professional) */
    .chatitem{
      width:100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: var(--text);
      cursor:pointer;
      margin-bottom: 8px;
      transition: border-color .15s ease, transform .15s ease, background .15s ease, box-shadow .15s ease;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      position:relative;
    }
    .chatitem:hover{
      transform: translateY(-1px);
      border-color: rgba(80,255,215,.26);
      background: rgba(0,0,0,.20);
      box-shadow: 0 0 18px rgba(80,255,215,.06);
    }
    .chatitem.active{
      border-color: rgba(101,183,255,.34);
      background: rgba(0,0,0,.22);
      box-shadow: 0 0 18px rgba(101,183,255,.06);
    }
    .chatitem .metaWrap{ min-width:0; flex:1; }
    .chatitem .t{ font-weight:900; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chatitem .s{ margin-top:4px; font-size: 11px; color: var(--muted2); display:flex; gap:8px; align-items:center; }

    .chip{
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(244,247,255,.86);
      user-select:none;
    }

    .iconBtn{
      width:34px; height:34px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(244,247,255,.92);
      cursor:pointer;
      display:grid; place-items:center;
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
      font-weight: 950; line-height:1; user-select:none;
    }
    .iconBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.36);
      background: rgba(255,255,255,.10);
      box-shadow: var(--neon1);
    }
    .iconBtn.danger{
      border-color: rgba(255,79,216,.30);
      background: rgba(255,79,216,.08);
    }
    .iconBtn.danger:hover{
      border-color: rgba(255,79,216,.48);
      background: rgba(255,79,216,.12);
      box-shadow: var(--neon2);
    }

    /* Dropdown menu */
    .menu{
      position:absolute; right:10px; top:44px;
      min-width: 210px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,12,24,.92);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      display:none;
      z-index: 20;
    }
    .menu.show{ display:block; animation: menuPop .12s ease; }
    @keyframes menuPop{
      from{ transform: translateY(-6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .menu button{
      width:100%;
      border:0;
      background: transparent;
      color: rgba(244,247,255,.92);
      padding: 10px 12px;
      text-align:left;
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .menu button:hover{ background: rgba(255,255,255,.06); }
    .menu .sep{ height:1px; background: rgba(255,255,255,.10); }

    /* Main topbar */
    .topbar{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
      position:relative;
    }
    .crumb{ display:flex; align-items:center; gap: 10px; min-width: 0; }
    .crumb .title{ font-weight: 900; letter-spacing:.25px; font-size: 15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .crumb .hint{ font-size: 12px; color: var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn{
      padding: var(--btnPad);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
      font-weight: 900;
      font-size: 13px;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.36);
      background: rgba(255,255,255,.10);
      box-shadow: var(--neon1);
    }
    .btn.primary{
      border-color: rgba(80,255,215,.34);
      background: linear-gradient(135deg, rgba(80,255,215,.16), rgba(101,183,255,.10));
      box-shadow: var(--neon1);
    }
    .btn.ghost{ background: rgba(0,0,0,.18); }

    /* Views */
    .view{ display:none; padding: 18px; }
    .view.show{ display:block; }

    .hero{
      padding: 16px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(900px 320px at 18% 0%, rgba(80,255,215,.12), transparent 65%),
        radial-gradient(900px 320px at 88% 0%, rgba(101,183,255,.10), transparent 62%),
        rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(420px 160px at 30% 0%, rgba(80,255,215,.12), transparent 60%),
                  radial-gradient(420px 160px at 70% 0%, rgba(101,183,255,.10), transparent 60%);
      opacity:.55;
      pointer-events:none;
      filter: blur(10px);
    }
    .hero h2{ margin:0; font-size: 22px; letter-spacing:.2px; position:relative; z-index:1; }
    .hero p{ margin:8px 0 0 0; color: var(--muted); max-width: 980px; line-height:1.55; position:relative; z-index:1; }
    .quote{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(244,247,255,.92);
      line-height:1.45;
      position:relative; z-index:1;
    }

    .grid{ margin-top: 14px; display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
      padding: 14px;
      display:flex; flex-direction:column; gap: 12px;
      min-height: 170px;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(101,183,255,.22);
      box-shadow: var(--shadow2), var(--neon1);
    }
    .cardhead{ display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; }
    .cardtitle{ display:flex; gap: 12px; align-items:flex-start; }
    .icon{
      width: 42px; height: 42px; border-radius: 14px;
      display:grid; place-items:center;
      font-weight: 950; letter-spacing:.4px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(80,255,215,.14), rgba(101,183,255,.10), rgba(199,165,255,.08));
      box-shadow: var(--neon1);
      user-select:none;
    }
    .card h4{ margin:0; font-size: 15px; }
    .card p{ margin:6px 0 0 0; color: var(--muted); line-height:1.5; }

    .pill{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
      align-self:flex-start;
    }
    .pill.live{ border-color: rgba(80,255,215,.38); background: rgba(80,255,215,.10); color: rgba(230,255,240,.92); }

    .cta{ display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-top:auto; flex-wrap:wrap; }

    /* Chat */
    .chatwrap{
      display:flex; flex-direction:column; gap: 12px;
      height: calc(100vh - 190px);
      min-height: 560px;
    }
    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .toggle{
      display:flex; align-items:center; gap: 8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .toggle:hover{ border-color: rgba(101,183,255,.28); box-shadow: 0 0 0 3px rgba(101,183,255,.08); }
    .toggle input{ transform: translateY(1px); }

    .chatbox{
      flex: 1;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      padding: 14px;
      overflow:auto;
      scroll-behavior:smooth;
    }
    .msg{
      max-width: 78%;
      padding: 12px 12px;
      border-radius: 18px;
      margin: 10px 0;
      line-height:1.55;
      border: 1px solid rgba(255,255,255,.12);
      white-space: pre-wrap;
      word-wrap: break-word;
      position:relative;
    }
    .msg.user{
      margin-left:auto;
      background: linear-gradient(135deg, rgba(80,255,215,.18), rgba(101,183,255,.12));
      border-color: rgba(80,255,215,.30);
      box-shadow: 0 0 14px rgba(80,255,215,.06);
    }
    .msg.ai{ background: rgba(255,255,255,.06); }

    .msgTools{
      margin-top: 8px;
      display:flex; gap: 8px; flex-wrap:wrap;
      opacity:.95;
    }
    .miniBtn{
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(244,247,255,.92);
      cursor:pointer;
      font-size: 12px;
      font-weight: 900;
      transition: transform .15s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
    }
    .miniBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.36);
      background: rgba(0,0,0,.28);
      box-shadow: var(--neon1);
    }

    .typing{
      display:inline-flex; align-items:center; gap:8px;
      color: var(--muted2);
      font-size: 12px;
      margin-top: 6px;
      user-select:none;
    }
    .dots{ display:inline-flex; gap:4px; transform: translateY(1px); }
    .dot{ width:6px;height:6px;border-radius:999px; background: rgba(244,247,255,.55); animation: bounce 1.1s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay: .12s; }
    .dot:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{
      0%, 80%, 100%{ transform: translateY(0); opacity:.55; }
      40%{ transform: translateY(-4px); opacity:1; }
    }

    .composer{ display:flex; gap: 10px; align-items:flex-end; }
    textarea{
      flex:1;
      min-height: 46px; max-height: 170px;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
      line-height:1.45;
    }
    textarea:focus{
      border-color: rgba(101,183,255,.40);
      box-shadow: 0 0 0 3px rgba(101,183,255,.12);
    }

    /* Footer */
    .footer{
      margin-top: 14px;
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      background: rgba(0,0,0,.10);
    }
    .copy{ color: rgba(244,247,255,.78); }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 70;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color: rgba(244,247,255,.95);
      box-shadow: var(--shadow2);
      display:none;
      max-width: min(820px, calc(100vw - 26px));
      line-height:1.45;
    }
    .toast.show{ display:block; animation: pop .18s ease; }
    @keyframes pop{
      from{ transform: translateX(-50%) translateY(8px); opacity:0; }
      to{ transform: translateX(-50%) translateY(0); opacity:1; }
    }
    .toastRow{
      display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap:wrap;
    }
    .toastActions{ display:flex; gap: 8px; }
    .toastActions button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(244,247,255,.95);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 900;
    }
    .toastActions button:hover{ box-shadow: var(--neon1); border-color: rgba(101,183,255,.32); }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      display:none;
      z-index:80;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      padding: 18px;
    }
    .modalOverlay.show{ display:grid; place-items:center; }
    .modal{
      width: min(940px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,12,24,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(420px 160px at 20% 0%, rgba(80,255,215,.12), transparent 60%),
                  radial-gradient(420px 160px at 80% 0%, rgba(101,183,255,.10), transparent 60%);
      filter: blur(12px);
      opacity:.6;
      pointer-events:none;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      position:relative; z-index:1;
    }
    .modalTitle{ font-weight: 950; letter-spacing:.2px; }
    .modalBody{
      padding: 14px 16px;
      color: rgba(244,247,255,.9);
      line-height:1.55;
      max-height: min(70vh, 560px);
      overflow:auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      position:relative; z-index:1;
    }
    .modalFoot{
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      position:relative; z-index:1;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      border-radius: 10px;
      padding: 2px 8px;
      color: rgba(244,247,255,.92);
    }

    :focus-visible{
      outline: 3px solid rgba(101,183,255,.20);
      outline-offset: 2px;
      border-radius: 14px;
    }

    /* Status pulse when online */
    .tag.live{ position: relative; }
    .tag.live::after{
      content:"";
      position:absolute; inset:-3px;
      border-radius:999px;
      border:1px solid rgba(80,255,215,.22);
      opacity:0;
      animation: pulse 2.2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform:scale(1); opacity:0; }
      25%{ opacity:.55; }
      70%{ transform:scale(1.12); opacity:0; }
      100%{ transform:scale(1.12); opacity:0; }
    }
  </style>
</head>

<body>
  <div class="bg-wrap">
    <div class="aurora"></div>
    <canvas id="particles"></canvas>
    <div class="vignette"></div>
  </div>

  <div class="app">
    <aside class="side">
      <div class="glowline"></div>

      <div class="brand">
        <div class="logoMark" aria-hidden="true">
          <svg viewBox="0 0 64 64" fill="none">
            <defs>
              <linearGradient id="g1" x1="6" y1="10" x2="58" y2="54" gradientUnits="userSpaceOnUse">
                <stop stop-color="#50FFD7"/>
                <stop offset="0.55" stop-color="#65B7FF"/>
                <stop offset="1" stop-color="#C7A5FF"/>
              </linearGradient>
              <filter id="glow" x="-40%" y="-40%" width="180%" height="180%">
                <feGaussianBlur stdDeviation="2.4" result="b"/>
                <feMerge>
                  <feMergeNode in="b"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <path filter="url(#glow)" d="M14 50V14h18c8 0 14 6 14 14 0 6-3 10-8 12l10 10h-10l-9-9H24v9H14Zm10-27h8c3 0 5 2 5 5s-2 5-5 5h-8V23Z" fill="url(#g1)" opacity="0.95"/>
            <path filter="url(#glow)" d="M48 50l-5-12h8l5 12h-8Z" fill="#FF4FD8" opacity="0.7"/>
          </svg>
        </div>
        <div>
          <h1><span>Raheem AI</span></h1>
          <div class="sub">Compliance-first chat and document reasoning</div>
        </div>
      </div>

      <div class="nav">
        <button class="navbtn active" id="navHome" type="button" aria-label="Go to Overview">
          <div class="left">
            <span class="tag">Home</span>
            <div style="min-width:0">
              <div style="font-weight:900">Overview</div>
              <div style="font-size:12px;color:var(--muted2);margin-top:2px">Product summary and quick start</div>
            </div>
          </div>
          <span class="tag">‚Üó</span>
        </button>

        <button class="navbtn" id="navChat" type="button" aria-label="Go to Chat">
          <div class="left">
            <span class="tag live">Live</span>
            <div style="min-width:0">
              <div style="font-weight:900">Chat</div>
              <div style="font-size:12px;color:var(--muted2);margin-top:2px">Saved sessions and continuous context</div>
            </div>
          </div>
          <span class="tag">‚Üó</span>
        </button>

        <button class="navbtn" id="navTools" type="button" aria-label="Go to Tools">
          <div class="left">
            <span class="tag">Tools</span>
            <div style="min-width:0">
              <div style="font-weight:900">Generators</div>
              <div style="font-size:12px;color:var(--muted2);margin-top:2px">Fire, DAC, Specs, BER</div>
            </div>
          </div>
          <span class="tag">‚Üó</span>
        </button>

        <button class="navbtn" id="navFuture" type="button" aria-label="Go to Roadmap">
          <div class="left">
            <span class="tag">Roadmap</span>
            <div style="min-width:0">
              <div style="font-weight:900">Future Features</div>
              <div style="font-size:12px;color:var(--muted2);margin-top:2px">BIM, multi-agent, layout</div>
            </div>
          </div>
          <span class="tag">‚Üó</span>
        </button>
      </div>

      <div class="chatlist" id="chatList">
        <h3>
          <span>Saved chats</span>
          <button class="iconBtn danger" id="btnDeleteAllChats" type="button" title="Delete all chats" aria-label="Delete all chats">üóë</button>
        </h3>

        <div class="chatSearch">
          <input id="chatFilter" type="text" placeholder="Search chats..." autocomplete="off" />
        </div>

        <div id="chatItems"></div>

        <button class="btn" id="btnNewChat" type="button" style="width:100%; margin-top:6px;">New chat</button>
      </div>

      <div class="sideFoot" style="padding: 12px 16px 14px 16px; border-top: 1px solid rgba(255,255,255,.10); color: var(--muted2); font-size: 12px; line-height:1.35;">
        <div style="font-weight:900;color:rgba(244,247,255,.86)">Usage tip</div>
        <div style="margin-top:6px">
          Use <b>Evidence mode</b> for stricter answers and citations where available.
          Press <span class="kbd">/</span> to focus the message box.
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="glowline"></div>

      <div class="topbar">
        <div class="crumb">
          <div class="title" id="viewTitle">Overview</div>
          <div class="hint" id="viewHint">Product summary and quick start</div>
        </div>
        <div class="actions">
          <span class="tag warn" id="apiPill">Checking‚Ä¶</span>
          <button class="btn" id="btnStatus" type="button" title="Backend status details">Status</button>
          <button class="btn ghost" id="btnShortcuts" type="button" title="Keyboard shortcuts">Shortcuts</button>
        </div>
      </div>

      <!-- HOME -->
      <section class="view show" id="viewHome">
        <div class="hero">
          <h2>AI for compliance, specifications and technical workflows</h2>
          <p>Ask questions in plain language. Use Evidence mode for stricter answers with citations and traceable logic.</p>
          <div class="quote">Built for practical building workflows: clear outputs, consistent structure, and faster review cycles.</div>
        </div>

        <div class="grid">
          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">AI</div>
                <div>
                  <h4>Chat</h4>
                  <p>TGD & Planning Copilot. Saved sessions, continuous context.</p>
                </div>
              </div>
              <span class="pill live">Live</span>
            </div>
            <div class="cta">
              <span class="pill">Session memory</span>
              <button class="btn primary" id="btnStartChat" type="button">Open chat</button>
            </div>
          </article>

          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">üß∞</div>
                <div>
                  <h4>Generators</h4>
                  <p>Fire Cert, DAC, NBS Spec, BER/DEAP (guided tools).</p>
                </div>
              </div>
              <span class="pill">Starter</span>
            </div>
            <div class="cta">
              <span class="pill">Questionnaires</span>
              <button class="btn" id="btnOpenTools" type="button">Open</button>
            </div>
          </article>
        </div>

        <div class="footer">
          <div class="copy">¬© 2026 Raheem AI. All rights reserved.</div>
          <div>Built by Abdulraheem Hayder Ahmed</div>
        </div>
      </section>

      <!-- CHAT -->
      <section class="view" id="viewChat">
        <div class="hero">
          <h2>Chat</h2>
          <p>Continue a saved chat on the left, or start a new one to keep topics clean.</p>
          <div class="quote" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
            <div style="max-width:780px">
              Tip: Evidence mode is best for regulations and reports. Ask one question per message.
            </div>
            <button class="btn" id="btnExportChat" type="button" title="Export current chat as a text file">Export</button>
          </div>
          <div style="margin-top:10px;font-size:12px;color:var(--muted2);line-height:1.45; position:relative; z-index:1;">
            Keyboard: <span class="kbd">Enter</span> send ‚Ä¢ <span class="kbd">Shift</span>+<span class="kbd">Enter</span> newline ‚Ä¢
            <span class="kbd">Ctrl</span>+<span class="kbd">K</span> clear ‚Ä¢ <span class="kbd">/</span> focus input.
          </div>
        </div>

        <div class="chatwrap">
          <div class="row" style="justify-content:space-between;">
            <div class="row">
              <label class="toggle" title="Prefer stricter, evidence-oriented responses">
                <input type="checkbox" id="forceDocs" />
                Evidence mode
              </label>
              <label class="toggle" title="Enable streaming typewriter effect (cosmetic)">
                <input type="checkbox" id="typewriter" />
                Typewriter
              </label>
              <label class="toggle" title="Stop responses quickly if needed">
                <input type="checkbox" id="fastMode" />
                Fast mode
              </label>
              <label class="toggle" title="Keep backend warm (helpful for Render free-tier)">
                <input type="checkbox" id="keepWarm" />
                Keep warm
              </label>
            </div>
            <div class="row">
              <button class="btn" id="btnClear" type="button">Clear chat</button>
            </div>
          </div>

          <div class="chatbox" id="chatBox" aria-live="polite"></div>

          <div class="composer">
            <textarea id="msg" placeholder="Type your message‚Ä¶ (Shift + Enter for a new line)"></textarea>
            <button class="btn primary" id="send" type="button">Send</button>
          </div>
        </div>

        <div class="footer">
          <div class="copy">¬© 2026 Raheem AI. All rights reserved.</div>
          <div>Tip: Evidence mode is best for technical checks.</div>
        </div>
      </section>

      <!-- TOOLS -->
      <section class="view" id="viewTools">
        <div class="hero">
          <h2>Generators</h2>
          <p>These are guided workflows. You answer questions; Raheem AI produces structured outputs ready for review.</p>
          <div class="quote">Start next: <b>NBS-style Spec Generator</b> + <b>Fire (TGD B) & DAC (TGD M) questionnaires</b>.</div>
        </div>

        <div class="grid">
          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">FCS</div>
                <div>
                  <h4>Fire Safety (TGD B) ‚Äì Questionnaire</h4>
                  <p>Step-by-step yes/no + project inputs. Outputs a structured report draft + submission checklist.</p>
                </div>
              </div>
              <span class="pill">Next</span>
            </div>
            <div class="cta">
              <span class="pill">Non-dwellings</span>
              <button class="btn" data-soon="Fire Safety Questionnaire" type="button">Preview</button>
            </div>
          </article>

          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">DAC</div>
                <div>
                  <h4>DAC (TGD M) ‚Äì Questionnaire</h4>
                  <p>Captures access strategy details and outputs a DAC report with highlighted non-compliance risks.</p>
                </div>
              </div>
              <span class="pill">Next</span>
            </div>
            <div class="cta">
              <span class="pill">Access & use</span>
              <button class="btn" data-soon="DAC Questionnaire" type="button">Preview</button>
            </div>
          </article>

          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">NBS</div>
                <div>
                  <h4>NBS-Style Specification Generator</h4>
                  <p>Turn a brief into structured spec clauses with placeholders and performance requirements.</p>
                </div>
              </div>
              <span class="pill live">Start here</span>
            </div>
            <div class="cta">
              <span class="pill">Specs</span>
              <button class="btn" data-soon="NBS Spec Generator" type="button">Preview</button>
            </div>
          </article>

          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">BER</div>
                <div>
                  <h4>BER / DEAP Copilot</h4>
                  <p>Import IFC/gbXML later. Extract areas, pre-fill DEAP style inputs, and guide remaining data.</p>
                </div>
              </div>
              <span class="pill">Roadmap</span>
            </div>
            <div class="cta">
              <span class="pill">Energy</span>
              <button class="btn" data-soon="BER / DEAP Copilot" type="button">Preview</button>
            </div>
          </article>
        </div>

        <div class="footer">
          <div class="copy">¬© 2026 Raheem AI. All rights reserved.</div>
          <div>Generators preview</div>
        </div>
      </section>

      <!-- ROADMAP -->
      <section class="view" id="viewFuture">
        <div class="hero">
          <h2>Future Features</h2>
          <p>Planned modules: multi-agent debate, BIM layout generation, reg-aware hints, and submission pack building.</p>
          <div class="quote">Roadmap items are previews. Availability depends on testing, performance, and data coverage.</div>
        </div>

        <div class="grid">
          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">DB</div>
                <div>
                  <h4>Design Debate Room</h4>
                  <p>Two AIs argue for/against an option and converge on the best recommendation with clear reasoning.</p>
                </div>
              </div>
              <span class="pill">Roadmap</span>
            </div>
            <div class="cta">
              <span class="pill">Decisions</span>
              <button class="btn" data-soon="Design Debate Room" type="button">Preview</button>
            </div>
          </article>

          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">LAY</div>
                <div>
                  <h4>AI Layout Generator (Revit-first)</h4>
                  <p>Send areas/adjacencies/constraints ‚Üí generate native Revit rooms/walls/doors + reg-aware hints.</p>
                </div>
              </div>
              <span class="pill">Roadmap</span>
            </div>
            <div class="cta">
              <span class="pill">BIM</span>
              <button class="btn" data-soon="AI Layout Generator" type="button">Preview</button>
            </div>
          </article>

          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">SIM</div>
                <div>
                  <h4>‚ÄúWhat-If‚Äù Reg Simulator</h4>
                  <p>Change height/area/occupancy and see implications across Fire, DAC, Planning, and energy.</p>
                </div>
              </div>
              <span class="pill">Roadmap</span>
            </div>
            <div class="cta">
              <span class="pill">Sim</span>
              <button class="btn" data-soon="What-If Reg Simulator" type="button">Preview</button>
            </div>
          </article>

          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">PK</div>
                <div>
                  <h4>Submission Pack Builder</h4>
                  <p>Combine Fire + DAC outputs into a ready-to-use submission bundle with cover letters and indices.</p>
                </div>
              </div>
              <span class="pill">Roadmap</span>
            </div>
            <div class="cta">
              <span class="pill">Docs</span>
              <button class="btn" data-soon="Submission Pack Builder" type="button">Preview</button>
            </div>
          </article>
        </div>

        <div class="footer">
          <div class="copy">¬© 2026 Raheem AI. All rights reserved.</div>
          <div>Roadmap preview</div>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">Modal</div>
        <button class="iconBtn" id="modalClose" type="button" aria-label="Close modal">√ó</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot" style="display:none;"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // 1) HARD FIX: Always call backend with an explicit API_BASE
    //    - No more fetch("/health") on Pages.
    // =========================================================
    const CONFIG = {
      API_BASE_DEFAULT: "https://complyr.onrender.com",   // <-- your backend
      HEALTH_PATH: "/health",                              // keep fast server-side
      CHAT_PATH: "/chat",
      HEALTH_TIMEOUT_MS: 9000,                             // never hang forever
      STATUS_POLL_MS: 20000,
      WARM_PING_MS: 240000,                                // 4 minutes
      CHAT_TIMEOUT_MS: 75000,
      CHAT_RETRY_ONCE: true
    };

    // Allow override ONLY if it matches expected host (prevents random injection)
    let API_BASE = (localStorage.getItem("RAHEEM_API_BASE") || CONFIG.API_BASE_DEFAULT).replace(/\/+$/, "");
    if (!API_BASE.startsWith(CONFIG.API_BASE_DEFAULT)) {
      localStorage.removeItem("RAHEEM_API_BASE");
      API_BASE = CONFIG.API_BASE_DEFAULT;
    }
    function apiUrl(path){
      if(!path) path = "/";
      if(!path.startsWith("/")) path = "/" + path;
      return API_BASE + path;
    }

    // =========================================================
    // Toast (supports Undo actions)
    // =========================================================
    const toast = document.getElementById("toast");
    let toastTimer = null;
    function showToast(msg, actions){
      clearTimeout(toastTimer);
      toast.innerHTML = "";

      if(actions && actions.length){
        const row = document.createElement("div");
        row.className = "toastRow";
        const left = document.createElement("div");
        left.textContent = msg;
        const right = document.createElement("div");
        right.className = "toastActions";
        actions.forEach(a=>{
          const b = document.createElement("button");
          b.type = "button";
          b.textContent = a.label;
          b.onclick = () => { try{ a.onClick(); } finally { hideToast(); } };
          right.appendChild(b);
        });
        row.appendChild(left);
        row.appendChild(right);
        toast.appendChild(row);
      } else {
        toast.textContent = msg;
      }

      toast.classList.add("show");
      toastTimer = setTimeout(()=> toast.classList.remove("show"), 3200);
    }
    function hideToast(){ toast.classList.remove("show"); }

    // =========================================================
    // Modal (supports confirm + custom buttons)
    // =========================================================
    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalFoot = document.getElementById("modalFoot");
    const modalClose = document.getElementById("modalClose");

    function openModal(title, bodyText, footerButtons){
      modalTitle.textContent = title || "Info";
      modalBody.textContent = bodyText || "";
      modalFoot.innerHTML = "";
      if(footerButtons && footerButtons.length){
        modalFoot.style.display = "flex";
        footerButtons.forEach(btn=>{
          const b = document.createElement("button");
          b.type = "button";
          b.className = "btn" + (btn.primary ? " primary" : "");
          b.textContent = btn.label;
          b.onclick = () => { if(btn.onClick) btn.onClick(); };
          modalFoot.appendChild(b);
        });
      } else {
        modalFoot.style.display = "none";
      }
      modalOverlay.classList.add("show");
    }
    function closeModal(){ modalOverlay.classList.remove("show"); }
    modalClose.onclick = closeModal;
    modalOverlay.addEventListener("click", (e)=>{ if(e.target === modalOverlay) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(); });

    // =========================================================
    // Navigation
    // =========================================================
    const viewTitleEl = document.getElementById("viewTitle");
    const viewHintEl  = document.getElementById("viewHint");
    const viewHome    = document.getElementById("viewHome");
    const viewChat    = document.getElementById("viewChat");
    const viewTools   = document.getElementById("viewTools");
    const viewFuture  = document.getElementById("viewFuture");
    const chatList    = document.getElementById("chatList");

    const navHome   = document.getElementById("navHome");
    const navChat   = document.getElementById("navChat");
    const navTools  = document.getElementById("navTools");
    const navFuture = document.getElementById("navFuture");

    function setNavActive(which){
      [navHome, navChat, navTools, navFuture].forEach(b=>b.classList.remove("active"));
      if(which==="home") navHome.classList.add("active");
      if(which==="chat") navChat.classList.add("active");
      if(which==="tools") navTools.classList.add("active");
      if(which==="future") navFuture.classList.add("active");
    }

    function showView(which){
      [viewHome, viewChat, viewTools, viewFuture].forEach(v=>v.classList.remove("show"));
      chatList.classList.remove("show");

      if(which==="home"){
        viewHome.classList.add("show");
        viewTitleEl.textContent = "Overview";
        viewHintEl.textContent  = "Product summary and quick start";
      }
      if(which==="chat"){
        viewChat.classList.add("show");
        viewTitleEl.textContent = "Chat";
        viewHintEl.textContent  = "Saved sessions and continuous context";
        chatList.classList.add("show");
        ensureActiveChat();
        renderChatList();
        renderChat();
        setTimeout(()=> msgEl.focus(), 50);
      }
      if(which==="tools"){
        viewTools.classList.add("show");
        viewTitleEl.textContent = "Generators";
        viewHintEl.textContent  = "Fire, DAC, Specs, BER";
      }
      if(which==="future"){
        viewFuture.classList.add("show");
        viewTitleEl.textContent = "Future Features";
        viewHintEl.textContent  = "Roadmap preview";
      }

      setNavActive(which);
      localStorage.setItem("RAHEEM_VIEW", which);
    }

    navHome.onclick = ()=>showView("home");
    navChat.onclick = ()=>showView("chat");
    navTools.onclick = ()=>showView("tools");
    navFuture.onclick = ()=>showView("future");
    document.getElementById("btnStartChat").onclick = ()=>showView("chat");
    document.getElementById("btnOpenTools").onclick = ()=>showView("tools");

    window.addEventListener("DOMContentLoaded", () => {
      const saved = (localStorage.getItem("RAHEEM_VIEW") || "home").toLowerCase();
      showView(["home","chat","tools","future"].includes(saved) ? saved : "home");
    });

    // =========================================================
    // NICE "Future" previews: modal instead of cringe black box
    // =========================================================
    document.querySelectorAll("[data-soon]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const name = btn.getAttribute("data-soon") || "This feature";
        openModal(
          name + " (Preview)",
          [
            name + " is currently in development.",
            "",
            "What you'll get:",
            "‚Ä¢ Clean guided UI (not random popups)",
            "‚Ä¢ Structured outputs ready for review",
            "‚Ä¢ Faster workflows with less manual formatting",
            "",
            "Status:",
            "‚Ä¢ Planned ‚Üí Prototyping ‚Üí Testing ‚Üí Release",
            "",
            "Want this sooner? Prioritize it in your roadmap list."
          ].join("\n"),
          [
            { label:"Close", onClick: closeModal },
            { label:"Go to Chat", primary:true, onClick: ()=>{ closeModal(); showView("chat"); } }
          ]
        );
      });
    });

    // =========================================================
    // Particles (same vibe, stable)
    // =========================================================
    const canvas = document.getElementById("particles");
    const ctx = canvas.getContext("2d");
    let W=0,H=0, particles=[];
    function resize(){
      W = canvas.width = window.innerWidth;
      H = canvas.height = window.innerHeight;
      const base = Math.floor(Math.min(90, Math.max(40, W/24)));
      particles = Array.from({length:base}).map(()=>( {
        x: Math.random()*W,
        y: Math.random()*H,
        r: Math.random()*1.4 + 0.4,
        vx:(Math.random()*0.22+0.05)*(Math.random()<0.5?-1:1),
        vy:(Math.random()*0.18+0.04)*(Math.random()<0.5?-1:1),
        a: Math.random()*0.45 + 0.10
      }));
    }
    window.addEventListener("resize", resize);
    resize();
    function tick(){
      ctx.clearRect(0,0,W,H);
      for(const p of particles){
        p.x += p.vx; p.y += p.vy;
        if(p.x < -20) p.x = W+20;
        if(p.x > W+20) p.x = -20;
        if(p.y < -20) p.y = H+20;
        if(p.y > H+20) p.y = -20;
        ctx.globalAlpha = p.a;
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fillStyle = "white";
        ctx.fill();
      }
      ctx.globalAlpha = 1;
      requestAnimationFrame(tick);
    }
    if(!window.matchMedia("(prefers-reduced-motion: reduce)").matches){ tick(); }

    // =========================================================
    // 2) REAL FIX: Status monitor that NEVER hangs + supports cold start.
    //    - "Checking..." cannot sit forever
    //    - "Offline" becomes "Waking‚Ä¶" while retrying
    // =========================================================
    const apiPill = document.getElementById("apiPill");
    const btnStatus = document.getElementById("btnStatus");

    const STATUS = {
      state: "checking",          // checking | online | waking | offline
      lastOkTs: 0,
      lastErr: "",
      attempts: 0,
      lastJson: null,
      warmTimer: null,
      pollTimer: null,
      wakingTimer: null
    };

    function setPill(state, text){
      apiPill.classList.remove("live","warn","bad");
      if(state === "online") apiPill.classList.add("live");
      if(state === "checking" || state === "waking") apiPill.classList.add("warn");
      if(state === "offline") apiPill.classList.add("bad");
      apiPill.textContent = text;
    }

    async function fetchWithTimeout(url, options, ms){
      const controller = new AbortController();
      const timer = setTimeout(()=> controller.abort(), ms);
      try{
        return await fetch(url, {
          ...options,
          mode: "cors",
          cache: "no-store",
          signal: controller.signal
        });
      } finally {
        clearTimeout(timer);
      }
    }

    async function pingHealth(){
      const url = apiUrl(CONFIG.HEALTH_PATH);
      try{
        const res = await fetchWithTimeout(url, { method:"GET" }, CONFIG.HEALTH_TIMEOUT_MS);
        const txt = await res.text().catch(()=> "");
        let json = null;
        try{ json = JSON.parse(txt); }catch(e){ /* ignore */ }
        if(res.ok){
          STATUS.lastOkTs = Date.now();
          STATUS.lastErr = "";
          STATUS.lastJson = json;
          return { ok:true, json };
        }
        STATUS.lastErr = "HTTP " + res.status + " " + txt.slice(0,300);
        return { ok:false, err: STATUS.lastErr };
      }catch(e){
        const isAbort = String(e && e.name).includes("AbortError");
        STATUS.lastErr = isAbort ? "Health check timed out" : ("Health check failed: " + (e && e.message ? e.message : String(e)));
        return { ok:false, err: STATUS.lastErr };
      }
    }

    function scheduleWakingLoop(){
      clearInterval(STATUS.wakingTimer);
      STATUS.wakingTimer = setInterval(async ()=>{
        if(STATUS.state !== "waking") return;
        const backoff = Math.min(6, STATUS.attempts);
        const dots = ".".repeat((STATUS.attempts % 3) + 1);
        setPill("waking", "Waking server" + dots);

        const r = await pingHealth();
        STATUS.attempts++;

        if(r.ok){
          STATUS.state = "online";
          STATUS.attempts = 0;
          setPill("online", "Online");
          showToast("Backend is online.");
          clearInterval(STATUS.wakingTimer);
        } else {
          // keep trying. Do NOT spam "Offline".
          if(STATUS.attempts > 8){
            // after enough tries, show offline but keep passive polling
            STATUS.state = "offline";
            setPill("offline", "Offline");
            clearInterval(STATUS.wakingTimer);
          }
        }
      }, 3500);
    }

    async function refreshStatusPill(){
      setPill("checking", "Checking‚Ä¶");
      const r = await pingHealth();
      if(r.ok){
        STATUS.state = "online";
        STATUS.attempts = 0;
        setPill("online", "Online");
        return;
      }
      // If it fails, go into waking loop first (cold start friendly)
      STATUS.state = "waking";
      STATUS.attempts = 0;
      setPill("waking", "Waking server‚Ä¶");
      scheduleWakingLoop();
    }

    btnStatus.onclick = async ()=>{
      const r = await pingHealth();
      const json = r.ok ? (r.json || { ok:true }) : null;

      if(r.ok){
        openModal(
          "Backend status",
          JSON.stringify({
            api_base: API_BASE,
            state: STATUS.state,
            last_ok: STATUS.lastOkTs ? new Date(STATUS.lastOkTs).toLocaleString() : null,
            health: json
          }, null, 2),
          [{ label:"Close", onClick: closeModal }]
        );
        showToast("Online.");
      } else {
        openModal(
          "Backend status",
          [
            "API Base: " + API_BASE,
            "State: " + STATUS.state,
            "",
            "Error:",
            STATUS.lastErr || "Unknown error",
            "",
            "Tip:",
            "If you're on Render free-tier, cold starts are normal.",
            "Turn on 'Keep warm' in Chat to reduce cold starts."
          ].join("\n"),
          [
            { label:"Close", onClick: closeModal },
            { label:"Retry now", primary:true, onClick: async ()=>{ closeModal(); await refreshStatusPill(); } }
          ]
        );
      }
    };

    // Start status polling
    refreshStatusPill();
    STATUS.pollTimer = setInterval(() => {
      // If online, quick confirm. If offline, try waking again (but not too spammy).
      if(STATUS.state === "online") refreshStatusPill();
      if(STATUS.state === "offline") {
        STATUS.state = "waking";
        STATUS.attempts = 0;
        scheduleWakingLoop();
      }
    }, CONFIG.STATUS_POLL_MS);

    // =========================================================
    // Shortcuts modal
    // =========================================================
    document.getElementById("btnShortcuts").onclick = ()=>{
      openModal(
        "Keyboard shortcuts",
        [
          "Enter  ‚Äî Send message",
          "Shift + Enter  ‚Äî New line",
          "/  ‚Äî Focus message input",
          "Ctrl + K  ‚Äî Clear chat",
          "Esc  ‚Äî Close dialogs"
        ].join("\n"),
        [{ label:"Close", onClick: closeModal }]
      );
    };

    // =========================================================
    // 3) Chat state + PROFESSIONAL delete UX (modal confirm + Undo)
    // =========================================================
    const chatBox = document.getElementById("chatBox");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("send");
    const forceDocsEl = document.getElementById("forceDocs");
    const typewriterEl = document.getElementById("typewriter");
    const fastModeEl = document.getElementById("fastMode");
    const keepWarmEl = document.getElementById("keepWarm");

    const btnClear = document.getElementById("btnClear");
    const btnNewChat = document.getElementById("btnNewChat");
    const chatItemsWrap = document.getElementById("chatItems");
    const btnDeleteAllChats = document.getElementById("btnDeleteAllChats");
    const chatFilterEl = document.getElementById("chatFilter");
    const btnExportChat = document.getElementById("btnExportChat");

    const STORAGE_KEY = "raheem_ai_chats_v6";
    const ACTIVE_CHAT_KEY = "raheem_active_chat_id";

    function loadAllChats(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
      catch(e){ return {}; }
    }
    function saveAllChats(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    function newChatId(){ return "chat_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7); }

    function fmtTime(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleString(undefined, { day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit" });
      }catch(e){ return ""; }
    }

    let activeChatId = (localStorage.getItem(ACTIVE_CHAT_KEY) || "").trim() || null;
    function persistActiveChatId(){ if(activeChatId) localStorage.setItem(ACTIVE_CHAT_KEY, activeChatId); }

    function ensureActiveChat(){
      const all = loadAllChats();
      if(activeChatId && all[activeChatId]){ persistActiveChatId(); return all; }
      activeChatId = newChatId();
      all[activeChatId] = {
        title: "New chat",
        updated: Date.now(),
        messages: [{ role:"assistant", content:"Hello. How can I help today?" }]
      };
      saveAllChats(all);
      persistActiveChatId();
      return all;
    }

    function setChatTitleFromFirstUser(all, chatId){
      const c = all[chatId]; if(!c) return;
      const firstUser = (c.messages || []).find(m=>m.role==="user");
      if(firstUser && (c.title==="New chat" || !c.title)){
        const s = (firstUser.content || "").trim();
        c.title = s.slice(0, 44) + (s.length>44 ? "..." : "");
      }
    }

    // Undo buffer
    let lastDeleted = null; // { chatId, chatObj, allBefore? }
    function offerUndoToast(){
      if(!lastDeleted) return;
      showToast("Chat deleted.", [
        { label:"Undo", onClick: ()=>{
          const all = loadAllChats();
          all[lastDeleted.chatId] = lastDeleted.chatObj;
          saveAllChats(all);
          activeChatId = lastDeleted.chatId;
          persistActiveChatId();
          lastDeleted = null;
          renderChatList();
          renderChat();
          showToast("Restored.");
        }}
      ]);
      // Clear undo after 6s
      setTimeout(()=>{ lastDeleted = null; }, 6000);
    }

    function escapeHtml(s){
      return (s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function closeAllMenus(){
      document.querySelectorAll(".menu.show").forEach(m=>m.classList.remove("show"));
    }
    document.addEventListener("click", (e)=>{
      // clicking outside menus closes them
      const inMenu = e.target && (e.target.closest && e.target.closest(".menu"));
      const inMenuBtn = e.target && (e.target.closest && e.target.closest("[data-menubtn]"));
      if(!inMenu && !inMenuBtn) closeAllMenus();
    });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeAllMenus(); });

    function deleteChatConfirm(chatId){
      const all = loadAllChats();
      const c = all[chatId];
      if(!c) return;

      openModal(
        "Delete chat?",
        [
          "This will delete:",
          "‚Ä¢ " + (c.title || "New chat"),
          "",
          "You can undo for a few seconds after deleting."
        ].join("\n"),
        [
          { label:"Cancel", onClick: closeModal },
          { label:"Delete", primary:true, onClick: ()=>{
            closeModal();
            // do deletion
            const all2 = loadAllChats();
            const chatObj = all2[chatId];
            if(!chatObj) return;

            lastDeleted = { chatId, chatObj };

            delete all2[chatId];

            if(chatId === activeChatId){
              const remaining = Object.keys(all2).sort((a,b)=>(all2[b].updated||0)-(all2[a].updated||0));
              activeChatId = remaining[0] || null;
              if(!activeChatId){
                saveAllChats(all2);
                localStorage.removeItem(ACTIVE_CHAT_KEY);
                ensureActiveChat();
              } else {
                persistActiveChatId();
                saveAllChats(all2);
              }
            } else {
              saveAllChats(all2);
            }

            renderChatList();
            renderChat();
            offerUndoToast();
          }}
        ]
      );
    }

    function renameChatPrompt(chatId){
      const all = loadAllChats();
      const c = all[chatId];
      if(!c) return;

      // quick small modal with instructions (rename happens via prompt in textarea style)
      openModal(
        "Rename chat",
        "Enter a new chat title in the box below:",
        [
          { label:"Cancel", onClick: closeModal },
          { label:"Rename", primary:true, onClick: ()=>{
            const newTitle = (document.getElementById("__renameInput")?.value || "").trim();
            if(!newTitle){
              showToast("Title can't be empty.");
              return;
            }
            const all2 = loadAllChats();
            if(!all2[chatId]) return;
            all2[chatId].title = newTitle.slice(0, 80);
            all2[chatId].updated = Date.now();
            saveAllChats(all2);
            closeModal();
            renderChatList();
            showToast("Renamed.");
          }}
        ]
      );

      // inject input into modal body (after openModal wrote text)
      modalBody.innerHTML = `
        <div style="color: rgba(244,247,255,.88); margin-bottom:10px; line-height:1.5;">
          Enter a new chat title:
        </div>
        <input id="__renameInput" type="text" value="${escapeHtml(c.title || "New chat")}"
          style="width:100%; padding: 12px 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,.14);
          background: rgba(0,0,0,.20); color: rgba(244,247,255,.95); outline:none;"
        />
        <div style="margin-top:10px; color: rgba(244,247,255,.60); font-size: 12px;">
          Tip: Keep it short like ‚ÄúBER checks ‚Äì Dwelling A‚Äù.
        </div>
      `;
      setTimeout(()=> document.getElementById("__renameInput")?.focus(), 50);
    }

    function exportChat(chatId){
      const all = loadAllChats();
      const c = all[chatId];
      if(!c) return;

      const title = (c.title || "raheem-ai-chat").replace(/[^\w\- ]+/g, "").trim().replace(/\s+/g, "-").toLowerCase() || "raheem-ai-chat";
      const lines = [];
      (c.messages||[]).forEach(m=>{
        const who = m.role === "user" ? "USER" : "ASSISTANT";
        lines.push("[" + who + "]\n" + (m.content || "") + "\n");
      });
      const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = title + ".txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      showToast("Exported chat.");
    }

    function renderChatList(){
      const all = ensureActiveChat();
      const q = (chatFilterEl.value || "").trim().toLowerCase();

      const ids = Object.keys(all)
        .sort((a,b)=>(all[b].updated||0)-(all[a].updated||0))
        .filter(id=>{
          if(!q) return true;
          const c = all[id];
          const title = (c.title || "").toLowerCase();
          if(title.includes(q)) return true;
          const msgs = (c.messages||[]);
          return msgs.slice(-20).some(m => (m.content||"").toLowerCase().includes(q));
        });

      chatItemsWrap.innerHTML = "";
      ids.forEach(id=>{
        const c = all[id];
        const row = document.createElement("div");
        row.style.position = "relative";

        const btn = document.createElement("button");
        btn.className = "chatitem" + (id===activeChatId ? " active" : "");
        btn.type = "button";

        const title = c.title || "New chat";
        const time = fmtTime(c.updated || Date.now());
        const msgCount = (c.messages||[]).length;

        btn.innerHTML = `
          <div class="metaWrap">
            <div class="t">${escapeHtml(title)}</div>
            <div class="s">
              <span>${escapeHtml(time)}</span><span style="opacity:.7">‚Ä¢</span>
              <span class="chip">${msgCount} msgs</span>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-shrink:0;">
            <button class="iconBtn" data-menubtn="1" type="button" aria-label="Chat menu" title="More">‚ãØ</button>
          </div>
        `;

        // Menu
        const menu = document.createElement("div");
        menu.className = "menu";
        menu.innerHTML = `
          <button type="button" data-act="open">Open <span style="opacity:.65">‚Ü©</span></button>
          <button type="button" data-act="rename">Rename <span style="opacity:.65">‚úé</span></button>
          <button type="button" data-act="export">Export <span style="opacity:.65">‚á©</span></button>
          <div class="sep"></div>
          <button type="button" data-act="delete" style="color: rgba(255,215,242,.95);">Delete <span style="opacity:.65">üóë</span></button>
        `;

        // open on main click (not the menu button)
        btn.addEventListener("click", (ev)=>{
          const menuBtn = ev.target && ev.target.closest && ev.target.closest("[data-menubtn]");
          if(menuBtn) return;
          activeChatId = id;
          persistActiveChatId();
          renderChatList();
          renderChat();
        });

        // menu toggle
        const menuBtn = btn.querySelector("[data-menubtn]");
        menuBtn.addEventListener("click", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const showing = menu.classList.contains("show");
          closeAllMenus();
          if(!showing) menu.classList.add("show");
        });

        menu.addEventListener("click", (ev)=>{
          const act = ev.target && ev.target.getAttribute && ev.target.getAttribute("data-act");
          if(!act) return;
          ev.preventDefault();
          ev.stopPropagation();
          closeAllMenus();
          if(act === "open"){
            activeChatId = id;
            persistActiveChatId();
            renderChatList();
            renderChat();
            return;
          }
          if(act === "rename") return renameChatPrompt(id);
          if(act === "export") return exportChat(id);
          if(act === "delete") return deleteChatConfirm(id);
        });

        row.appendChild(btn);
        row.appendChild(menu);
        chatItemsWrap.appendChild(row);
      });

      if(!ids.length){
        const empty = document.createElement("div");
        empty.style.padding = "10px 6px";
        empty.style.color = "rgba(244,247,255,.65)";
        empty.style.fontSize = "12px";
        empty.textContent = "No chats match your search.";
        chatItemsWrap.appendChild(empty);
      }
    }

    function attachMsgTools(aiDiv, text){
      const tools = document.createElement("div");
      tools.className = "msgTools";

      const copyBtn = document.createElement("button");
      copyBtn.className = "miniBtn";
      copyBtn.type = "button";
      copyBtn.textContent = "Copy";
      copyBtn.onclick = async ()=>{
        try{ await navigator.clipboard.writeText(text || ""); showToast("Copied."); }
        catch(e){ showToast("Copy failed."); }
      };

      const quoteBtn = document.createElement("button");
      quoteBtn.className = "miniBtn";
      quoteBtn.type = "button";
      quoteBtn.textContent = "Quote";
      quoteBtn.onclick = ()=>{
        const q = (text || "").trim();
        if(!q) return;
        const snippet = q.length > 700 ? q.slice(0,700) + "‚Ä¶" : q;
        msgEl.value = (msgEl.value ? (msgEl.value + "\n\n") : "") + "> " + snippet.replace(/\n/g, "\n> ");
        msgEl.focus();
        showToast("Quoted into input.");
      };

      const openBtn = document.createElement("button");
      openBtn.className = "miniBtn";
      openBtn.type = "button";
      openBtn.textContent = "Open";
      openBtn.onclick = ()=> openModal("Assistant reply", text || "", [{ label:"Close", onClick: closeModal }]);

      tools.appendChild(copyBtn);
      tools.appendChild(quoteBtn);
      tools.appendChild(openBtn);
      aiDiv.appendChild(tools);
    }

    function addMsg(who, text, scroll=true){
      const div = document.createElement("div");
      div.className = "msg " + (who==="user" ? "user" : "ai");
      div.textContent = text;
      chatBox.appendChild(div);
      if(who !== "user") attachMsgTools(div, text);
      if(scroll) chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    function addTypingIndicator(targetDiv){
      const wrap = document.createElement("div");
      wrap.className = "typing";
      wrap.innerHTML = `<span>Raheem AI is responding</span><span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      targetDiv.appendChild(wrap);
      return wrap;
    }

    function renderChat(){
      const all = ensureActiveChat();
      const c = all[activeChatId];
      chatBox.innerHTML = "";
      (c.messages||[]).forEach(m=> addMsg(m.role==="user" ? "user" : "ai", m.content, false));
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function clearChat(){
      const all = ensureActiveChat();
      all[activeChatId].messages = [{ role:"assistant", content:"Cleared. What would you like to do next?" }];
      all[activeChatId].updated = Date.now();
      saveAllChats(all);
      renderChat();
      renderChatList();
      showToast("Chat cleared.");
    }
    btnClear.onclick = clearChat;

    btnNewChat.onclick = ()=>{
      const all = loadAllChats();
      activeChatId = newChatId();
      all[activeChatId] = {
        title: "New chat",
        updated: Date.now(),
        messages: [{ role:"assistant", content:"Hello. How can I help today?" }]
      };
      saveAllChats(all);
      persistActiveChatId();
      renderChatList();
      renderChat();
      showToast("New chat created.");
    };

    btnDeleteAllChats.onclick = ()=>{
      openModal(
        "Delete ALL chats?",
        [
          "This removes every saved chat from this browser.",
          "",
          "This cannot be undone."
        ].join("\n"),
        [
          { label:"Cancel", onClick: closeModal },
          { label:"Delete all", primary:true, onClick: ()=>{
            closeModal();
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(ACTIVE_CHAT_KEY);
            activeChatId = null;
            ensureActiveChat();
            renderChatList();
            renderChat();
            showToast("All chats deleted.");
          }}
        ]
      );
    };

    chatFilterEl.addEventListener("input", ()=> renderChatList());

    btnExportChat.onclick = ()=> exportChat(activeChatId);

    // Init chat state once
    ensureActiveChat();

    // =========================================================
    // SSE parsing + streaming
    // =========================================================
    function parseSSETextToAnswer(sseText){
      let out = "";
      const frames = (sseText || "").split(/\n\n/);
      for(const frame of frames){
        const f = frame.trim();
        if(!f) continue;
        if(f.includes("event: error")){
          const line = f.split("\n").find(x => x.startsWith("data:"));
          const msg = line ? line.replace(/^data:\s?/, "") : "Error";
          return msg.replaceAll("\\n","\n").trim();
        }
        const lines = f.split("\n");
        for(const line of lines){
          if(line.startsWith("data:")){
            out += line.replace(/^data:\s?/, "").replaceAll("\\n","\n");
          }
        }
      }
      return out.trim();
    }

    function typewriterSet(el, text){
      el.textContent = "";
      let i = 0;
      const step = ()=>{
        i += Math.max(2, Math.floor(text.length / 240));
        el.textContent = text.slice(0, i);
        if(i < text.length) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    async function fetchChat(url, body){
      // Hard timeout + optional retry once
      try{
        return await fetchWithTimeout(url, {
          method: "POST",
          headers: { "Content-Type":"application/json", "Accept":"text/event-stream" },
          body
        }, CONFIG.CHAT_TIMEOUT_MS);
      }catch(e){
        if(CONFIG.CHAT_RETRY_ONCE){
          await new Promise(r=>setTimeout(r, 650));
          return await fetchWithTimeout(url, {
            method: "POST",
            headers: { "Content-Type":"application/json", "Accept":"text/event-stream" },
            body
          }, CONFIG.CHAT_TIMEOUT_MS);
        }
        throw e;
      }
    }

    // =========================================================
    // 4) Send chat: no more infinite "thinking"
    // =========================================================
    async function send(){
      const text = (msgEl.value || "").trim();
      if(!text) return;
      msgEl.value = "";

      // If offline-ish, wake first (prevents wasted sends)
      if(STATUS.state === "offline" || STATUS.state === "waking"){
        setPill("waking", "Waking server‚Ä¶");
        const r = await pingHealth();
        if(!r.ok){
          showToast("Backend is still waking. Try again in a moment.");
          return;
        }
        STATUS.state = "online";
        setPill("online", "Online");
      }

      const all = ensureActiveChat();
      const c = all[activeChatId];
      c.messages.push({ role:"user", content:text });
      c.updated = Date.now();
      setChatTitleFromFirstUser(all, activeChatId);
      saveAllChats(all);

      addMsg("user", text);
      const aiDiv = addMsg("ai", "");
      const typing = addTypingIndicator(aiDiv);

      const url =
        apiUrl(CONFIG.CHAT_PATH)
        + "?chat_id=" + encodeURIComponent(activeChatId)
        + "&force_docs=" + (forceDocsEl.checked ? "1" : "0")
        + "&fast=" + (fastModeEl && fastModeEl.checked ? "1" : "0");

      const body = JSON.stringify({ message: text, messages: c.messages });

      let full = "";
      let gotAnyToken = false;

      // watchdog (never stuck)
      const watchdog = setTimeout(() => {
        try{
          if(typing && typing.parentNode) typing.parentNode.removeChild(typing);
          const msg = "No response received (timeout). Try again.";
          aiDiv.textContent = msg;
          attachMsgTools(aiDiv, msg);
        }catch(e){}
      }, CONFIG.CHAT_TIMEOUT_MS + 1200);

      try{
        const res = await fetchChat(url, body);

        if(!res.ok){
          const errText = await res.text().catch(()=>"(no error body)");
          if(typing && typing.parentNode) typing.parentNode.removeChild(typing);
          const msg = "Server error " + res.status + ": " + (errText || "").slice(0, 1600);
          aiDiv.textContent = msg;
          attachMsgTools(aiDiv, msg);
          STATUS.state = "offline";
          setPill("offline", "Offline");
          return;
        }

        if(!res.body || !res.body.getReader){
          const raw = await res.text().catch(()=> "");
          const reply = parseSSETextToAnswer(raw) || " ";
          if(typing && typing.parentNode) typing.parentNode.removeChild(typing);
          if(typewriterEl.checked) typewriterSet(aiDiv, reply);
          else aiDiv.textContent = reply;
          attachMsgTools(aiDiv, reply);

          const all2 = ensureActiveChat();
          const c2 = all2[activeChatId];
          c2.messages.push({ role:"assistant", content: reply });
          c2.updated = Date.now();
          saveAllChats(all2);
          renderChatList();
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";

        while(true){
          const { value, done } = await reader.read();
          if(done) break;

          buffer += decoder.decode(value, { stream:true });
          const parts = buffer.split(/\n\n/);
          buffer = parts.pop() || "";

          for(const chunk of parts){
            const cframe = (chunk || "").trim();
            if(!cframe) continue;

            if(cframe.includes("event: error")){
              const line = cframe.split("\n").find(x=>x.startsWith("data:"));
              const msg = line ? line.replace(/^data:\s?/, "") : "Error";
              if(typing && typing.parentNode) typing.parentNode.removeChild(typing);
              const err = msg.replaceAll("\\n","\n").trim();
              aiDiv.textContent = err;
              attachMsgTools(aiDiv, err);
              continue;
            }
            if(cframe.includes("event: done")) continue;

            const lines = cframe.split("\n");
            for(const line of lines){
              if(line.startsWith("data:")){
                const delta = line.replace(/^data:\s?/, "").replaceAll("\\n","\n");
                if(delta){
                  gotAnyToken = true;
                  if(typing && typing.parentNode) typing.parentNode.removeChild(typing);
                  full += delta;
                  aiDiv.textContent = full;
                  chatBox.scrollTop = chatBox.scrollHeight;
                }
              }
            }
          }
        }

        if(!gotAnyToken && typing && typing.parentNode) typing.parentNode.removeChild(typing);

        const finalText = full.trim() || " ";
        if(typewriterEl.checked && finalText.length < 4500) typewriterSet(aiDiv, finalText);
        else aiDiv.textContent = finalText;
        attachMsgTools(aiDiv, finalText);

        const all2 = ensureActiveChat();
        const c2 = all2[activeChatId];
        c2.messages.push({ role:"assistant", content: finalText });
        c2.updated = Date.now();
        saveAllChats(all2);
        renderChatList();

        STATUS.state = "online";
        setPill("online", "Online");
      }catch(e){
        console.error("Chat send error:", e);
        if(typing && typing.parentNode) typing.parentNode.removeChild(typing);

        let msg = "Connection error. Try again.";
        if(String(e && e.name).includes("AbortError")){
          msg = "Request timed out (cold start or slow backend). Try again.";
        }
        aiDiv.textContent = msg;
        attachMsgTools(aiDiv, msg);

        STATUS.state = "waking";
        setPill("waking", "Waking server‚Ä¶");
        scheduleWakingLoop();
      }finally{
        clearTimeout(watchdog);
      }
    }

    sendBtn.onclick = send;
    msgEl.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // =========================================================
    // Keep-warm ping (optional)
    // =========================================================
    function setKeepWarm(on){
      localStorage.setItem("RAHEEM_KEEP_WARM", on ? "1" : "0");
      clearInterval(STATUS.warmTimer);
      if(!on) return;

      STATUS.warmTimer = setInterval(async ()=>{
        // Only ping when not actively chatting, just keep server from sleeping
        try{
          await fetchWithTimeout(apiUrl(CONFIG.HEALTH_PATH), { method:"GET" }, 8000);
        }catch(e){ /* ignore */ }
      }, CONFIG.WARM_PING_MS);
    }
    keepWarmEl.checked = (localStorage.getItem("RAHEEM_KEEP_WARM") === "1");
    setKeepWarm(keepWarmEl.checked);
    keepWarmEl.addEventListener("change", ()=> {
      setKeepWarm(keepWarmEl.checked);
      showToast(keepWarmEl.checked ? "Keep warm enabled." : "Keep warm disabled.");
    });

    // =========================================================
    // Keyboard shortcuts
    // =========================================================
    document.addEventListener("keydown", (e)=>{
      if(e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
        const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
        if(tag !== "textarea" && tag !== "input"){
          e.preventDefault();
          showView("chat");
          msgEl.focus();
        }
      }
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
        e.preventDefault();
        clearChat();
      }
    });

    // Make sure first render happens if user lands in Chat
    window.addEventListener("DOMContentLoaded", ()=>{
      // render list if chat view is restored
      const saved = (localStorage.getItem("RAHEEM_VIEW") || "home").toLowerCase();
      if(saved === "chat"){
        renderChatList();
        renderChat();
      }
    });
  </script>
</body>
</html>


