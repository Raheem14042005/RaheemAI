<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raheem AI</title>
  <style>
    :root {
      --bg1: #060713; --bg2: #0b1030; --text: #f4f7ff; --muted: #a0a8c2;
      --accent1: #50FFD7; --accent2: #65B7FF; --border-color: rgba(255,255,255,.12);
      --font-sans: ui-sans-serif, system-ui, -apple-system, sans-serif;
    }
    body { margin: 0; font-family: var(--font-sans); background-color: var(--bg1); color: var(--text); }
    .container { max-width: 900px; margin: 0 auto; padding: 1rem; display: flex; flex-direction: column; height: 100vh; }
    #header { padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
    #header h1 { margin: 0; font-size: 1.5rem; }
    .controls { display: flex; gap: 1rem; padding: 1rem 0; flex-wrap: wrap; align-items: center; }
    .controls select, .controls input, .controls button {
      padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color);
      background-color: var(--bg2); color: var(--text); font-family: var(--font-sans);
    }
    .controls button { cursor: pointer; background-color: rgba(255,255,255,0.1); }
    .chat-area { flex-grow: 1; display: flex; gap: 1rem; overflow: hidden; margin-bottom: 1rem; }
    #chat-box { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; overflow-y: auto; background: rgba(0,0,0,0.2); }
    #sources-panel { width: 300px; flex-shrink: 0; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; overflow-y: auto; background: rgba(0,0,0,0.2); }
    #sources-panel h3 { margin-top: 0; }
    .message { margin-bottom: 1rem; padding: 0.8rem 1rem; border-radius: 12px; line-height: 1.5; max-width: 90%; }
    .user-message { background-color: rgba(101, 183, 255, 0.1); border-left: 3px solid var(--accent2); margin-left: auto; }
    .ai-message { background-color: rgba(255, 255, 255, 0.07); }
    .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--muted); }
    .message-sender { font-weight: bold; }
    .message-tools { margin-top: 0.75rem; display: flex; gap: 0.5rem; }
    .tool-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); color: var(--text); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; }
    .citation { font-size: 0.8rem; display: block; padding: 0.5rem; border-radius: 6px; background: rgba(0,0,0,0.3); margin-top: 0.5rem; }
    #input-area { display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    #message-input { flex-grow: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg2); color: var(--text); resize: none; font-family: var(--font-sans); font-size: 1rem;}
    #send-button { padding: 0.75rem 1.5rem; border: none; background-color: var(--accent1); color: var(--bg1); font-weight: bold; border-radius: 8px; cursor: pointer; }
    #send-button:disabled { background-color: #555; cursor: not-allowed; }
    #status-indicator { height: 24px; text-align: center; padding: 0.5rem 0; color: var(--muted); font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <header id="header">
      <h1>Raheem AI</h1>
    </header>
    <div class="controls">
      <select id="pdf-select"><option value="">All Documents</option></select>
      <input type="number" id="page-hint-input" placeholder="Page hint (optional)">
      <button id="clear-chat-button">Clear Chat</button>
    </div>
    <div class="chat-area">
      <div id="chat-box"></div>
      <aside id="sources-panel">
        <h3>Citations</h3>
        <div id="sources-list"></div>
      </aside>
    </div>
    <div id="status-indicator"></div>
    <div id="input-area">
      <textarea id="message-input" placeholder="Ask about TGDs, planning, specs..." rows="1"></textarea>
      <button id="send-button">Send</button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const pdfSelect = document.getElementById('pdf-select');
    const pageHintInput = document.getElementById('page-hint-input');
    const clearChatButton = document.getElementById('clear-chat-button');
    const statusIndicator = document.getElementById('status-indicator');
    const sourcesList = document.getElementById('sources-list');

    let chatHistory = [];
    let currentAiMessageElement = null;

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    clearChatButton.addEventListener('click', () => {
      chatBox.innerHTML = '';
      sourcesList.innerHTML = '';
      chatHistory = [];
    });

    async function initialize() {
      try {
        const response = await fetch('/pdfs');
        if (!response.ok) throw new Error('Failed to fetch PDFs');
        const data = await response.json();
        populatePdfDropdown(data.pdfs || []);
      } catch (error) {
        console.error('Error fetching PDFs:', error);
        statusIndicator.textContent = 'Could not load PDF list.';
      }
    }

    function populatePdfDropdown(pdfs) {
      pdfs.forEach(pdf => {
        const option = document.createElement('option');
        option.value = pdf;
        option.textContent = pdf;
        pdfSelect.appendChild(option);
      });
    }

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message || sendButton.disabled) return;

      addMessage('user', message);
      chatHistory.push({ role: 'user', content: message });
      messageInput.value = '';
      statusIndicator.textContent = 'Raheem AI is thinking...';
      sendButton.disabled = true;

      const apiUrl = buildApiUrl();
      let fullResponseText = '';
      currentAiMessageElement = addMessage('ai', '▋');

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message, messages: chatHistory.slice(0, -1) })
        });

        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\\n');
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              fullResponseText += line.substring(6);
              currentAiMessageElement.querySelector('.message-content').textContent = fullResponseText + ' ▋';
            }
          }
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      } catch (error) {
        console.error('Error:', error);
        const errorText = `An error occurred: ${error.message}`;
        if (currentAiMessageElement) {
            currentAiMessageElement.querySelector('.message-content').textContent = errorText;
        } else {
            addMessage('ai', errorText);
        }
      } finally {
        currentAiMessageElement.querySelector('.message-content').textContent = fullResponseText;
        chatHistory.push({ role: 'assistant', content: fullResponseText });
        addMessageTools(currentAiMessageElement, fullResponseText);
        extractAndDisplayCitations(fullResponseText);
        statusIndicator.textContent = '';
        sendButton.disabled = false;
        currentAiMessageElement = null;
      }
    }

    function buildApiUrl() {
      let url = '/chat?';
      const params = new URLSearchParams();
      if (pdfSelect.value) params.append('pinned', pdfSelect.value);
      if (pageHintInput.value) params.append('page', pageHintInput.value);
      return url + params.toString();
    }

    function addMessage(sender, text) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('message', `${sender}-message`);
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      messageElement.innerHTML = `
        <div class="message-header">
          <span class="message-sender">${sender === 'user' ? 'You' : 'Raheem AI'}</span>
          <span class="message-timestamp">${timestamp}</span>
        </div>
        <div class="message-content"></div>
      `;
      messageElement.querySelector('.message-content').textContent = text;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
      return messageElement;
    }

    function addMessageTools(messageElement, text) {
      if (!messageElement) return;
      const toolsContainer = document.createElement('div');
      toolsContainer.classList.add('message-tools');
      
      const copyButton = document.createElement('button');
      copyButton.classList.add('tool-btn');
      copyButton.textContent = 'Copy';
      copyButton.onclick = () => {
        navigator.clipboard.writeText(text);
        copyButton.textContent = 'Copied!';
        setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
      };

      toolsContainer.appendChild(copyButton);
      messageElement.appendChild(toolsContainer);
    }
    
    function extractAndDisplayCitations(text) {
        const citationRegex = /\\(Source: ([^,]+), Page (\\d+)\\)/g;
        let match;
        let citationsFound = false;
        while ((match = citationRegex.exec(text)) !== null) {
            citationsFound = true;
            const citationElement = document.createElement('div');
            citationElement.classList.add('citation');
            citationElement.textContent = `${match[2]}, Page ${match[3]}`;
            sourcesList.appendChild(citationElement);
        }
        if (citationsFound) {
             text = text.replace(citationRegex, "");
        }
        return text;
    }

    initialize();
  </script>
</body>
</html>