<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Raheem AI</title>

  <style>
    :root{
      --bg0:#050610;
      --bg1:#070a18;
      --bg2:#0a0f22;

      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.11);
      --stroke: rgba(255,255,255,.14);

      --text:#f4f7ff;
      --muted: rgba(244,247,255,.78);
      --muted2: rgba(244,247,255,.60);

      --a1:#50ffd7;
      --a2:#65b7ff;
      --a3:#c7a5ff;
      --hot:#ff4fd8;

      --shadow: 0 28px 72px rgba(0,0,0,.58);
      --shadow2: 0 18px 48px rgba(0,0,0,.42);

      --r:22px;
      --r2:16px;

      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 18% -10%, rgba(80,255,215,.14), transparent 60%),
        radial-gradient(1100px 650px at 85% 0%, rgba(101,183,255,.14), transparent 58%),
        radial-gradient(900px 620px at 50% 115%, rgba(199,165,255,.12), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
      overflow-x:hidden;
    }

    .bg-wrap{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
    }

    .aurora{
      position:absolute;
      inset:-25%;
      background:
        radial-gradient(900px 520px at 12% 18%, rgba(80,255,215,.14) 0%, rgba(80,255,215,0) 65%),
        radial-gradient(900px 520px at 88% 14%, rgba(101,183,255,.14) 0%, rgba(101,183,255,0) 62%),
        radial-gradient(980px 560px at 50% 108%, rgba(199,165,255,.12) 0%, rgba(199,165,255,0) 60%),
        radial-gradient(840px 520px at 45% 40%, rgba(255,79,216,.06) 0%, rgba(255,79,216,0) 60%);
      filter: blur(22px);
      opacity:.85;
      transform: translate3d(0,0,0);
      animation: auroraMove 22s ease-in-out infinite;
    }

    @keyframes auroraMove{
      0%,100%{ transform: translate3d(0,0,0) scale(1); }
      45%{ transform: translate3d(12px,-10px,0) scale(1.02); }
      75%{ transform: translate3d(-12px,10px,0) scale(1.015); }
    }

    canvas#particles{
      position:absolute;
      inset:0;
      opacity:.18;
      filter: blur(.2px);
    }

    .vignette{
      position:absolute;
      inset:-1px;
      background: radial-gradient(900px 520px at 50% 22%, rgba(0,0,0,0), rgba(0,0,0,.58));
      opacity:.9;
    }

    @media (prefers-reduced-motion: reduce){
      .aurora{ animation:none; }
      canvas#particles{ display:none; }
    }

    .app{
      position:relative;
      z-index:1;
      min-height:100vh;
      display:grid;
      grid-template-columns: 330px 1fr;
      gap: 18px;
      padding: 18px;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .side{ position:sticky; top:0; }
    }

    .side, .main{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .main{
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height: calc(100vh - 36px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 16px 16px 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .logoMark{
      width: 46px;
      height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: 0 0 26px rgba(80,255,215,.10), 0 0 26px rgba(101,183,255,.08);
      display:grid;
      place-items:center;
      overflow:hidden;
      position:relative;
    }

    .logoMark svg{ width:38px; height:38px; opacity:.95; }

    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.5px;
      font-weight: 900;
      line-height:1.1;
    }

    .brand h1 span{
      background: linear-gradient(90deg, var(--a1), var(--a2), var(--a3));
      -webkit-background-clip: text;
      background-clip:text;
      color: transparent;
      text-shadow: 0 0 18px rgba(101,183,255,.12);
    }

    .brand .sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted2);
      line-height:1.2;
    }

    .nav{
      padding: 12px 12px 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .navbtn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }
    .navbtn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.34);
      background: rgba(0,0,0,.24);
    }

    .navbtn .left{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .tag{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .tag.live{
      border-color: rgba(80,255,215,.38);
      color: rgba(230,255,240,.92);
      background: rgba(80,255,215,.10);
    }
    .tag.new{
      border-color: rgba(199,165,255,.35);
      color: rgba(244,247,255,.92);
      background: rgba(199,165,255,.10);
    }

    .sideFoot{
      padding: 12px 16px 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
    }

    .topbar{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .crumb{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .crumb .title{
      font-weight: 900;
      letter-spacing:.25px;
      font-size: 15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .crumb .hint{
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{ display:flex; gap:10px; align-items:center; }

    .btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      font-weight: 800;
      font-size: 13px;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.36);
      background: rgba(255,255,255,.10);
    }
    .btn.primary{
      border-color: rgba(80,255,215,.34);
      background: linear-gradient(135deg, rgba(80,255,215,.16), rgba(101,183,255,.10));
      box-shadow: 0 0 18px rgba(80,255,215,.08);
    }
    .btn.ghost{
      border-color: rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
    }
    .btn.danger{
      border-color: rgba(255,79,216,.32);
      background: rgba(255,79,216,.10);
    }
    .btn:disabled{
      opacity: .55;
      cursor:not-allowed;
      transform:none !important;
    }

    .view{ display:none; padding: 18px; }
    .view.show{ display:block; }

    .hero{
      padding: 16px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(900px 320px at 18% 0%, rgba(80,255,215,.12), transparent 65%),
        radial-gradient(900px 320px at 88% 0%, rgba(101,183,255,.10), transparent 62%),
        rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
    }
    .hero h2{ margin:0; font-size: 22px; letter-spacing:.2px; }
    .hero p{ margin:8px 0 0 0; color: var(--muted); max-width: 980px; line-height:1.55; }

    .quote{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(244,247,255,.92);
      line-height:1.45;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .cardhead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }

    .cardtitle{
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }

    .icon{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-weight: 900;
      letter-spacing:.4px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(80,255,215,.14), rgba(101,183,255,.10), rgba(199,165,255,.08));
      box-shadow: 0 0 16px rgba(101,183,255,.08);
    }

    .card h4{ margin:0; font-size: 15px; }
    .card p{ margin:6px 0 0 0; color: var(--muted); line-height:1.5; }

    .pill{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
      align-self:flex-start;
    }

    .cta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top:auto;
    }

    .footer{
      margin-top: 14px;
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      background: rgba(0,0,0,.10);
    }
    .copy{ color: rgba(244,247,255,.78); }
    .smallHint{
      margin-top:10px;
      font-size: 12px;
      color: var(--muted2);
      line-height:1.45;
    }

    /* =========================
       TOAST
       ========================= */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 50;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color: rgba(244,247,255,.95);
      box-shadow: var(--shadow2);
      display:none;
      max-width: min(760px, calc(100vw - 26px));
      line-height:1.45;
    }
    .toast.show{ display:block; animation: pop .18s ease; }
    @keyframes pop{
      from{ transform: translateX(-50%) translateY(8px); opacity:0; }
      to{ transform: translateX(-50%) translateY(0); opacity:1; }
    }

    /* =========================
       FIRE CERT (REFINED)
       ========================= */
    .fcwrap{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      margin-top: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .fcwrap{ grid-template-columns: 1fr; }
    }

    .panel{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panelHead{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      background: rgba(0,0,0,.12);
    }
    .panelHead h3{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
      font-weight: 900;
    }
    .panelHead .sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted2);
      line-height:1.35;
      max-width: 640px;
    }
    .panelBody{ padding: 14px; }

    .stepper{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .stepChip{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color: rgba(244,247,255,.90);
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      font-weight: 800;
      font-size: 12px;
      white-space:nowrap;
    }
    .stepChip:hover{
      transform: translateY(-1px);
      border-color: rgba(101,183,255,.36);
      background: rgba(0,0,0,.20);
    }
    .stepChip.active{
      border-color: rgba(80,255,215,.36);
      background: linear-gradient(135deg, rgba(80,255,215,.14), rgba(101,183,255,.10));
      box-shadow: 0 0 16px rgba(80,255,215,.06);
    }
    .stepChip .n{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight: 900;
    }
    .stepChip.active .n{
      border-color: rgba(80,255,215,.34);
      background: rgba(80,255,215,.10);
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .formGrid{ grid-template-columns: 1fr; }
    }

    .field{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      padding: 12px;
    }
    .field.full{ grid-column: 1 / -1; }
    .labelRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.25px;
      color: rgba(244,247,255,.92);
      display:flex;
      align-items:center;
      gap: 8px;
      line-height:1.25;
    }

    .helpBtn{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      font-size: 12px;
      font-weight: 900;
      color: rgba(244,247,255,.92);
      cursor: pointer;
      user-select:none;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      flex-shrink:0;
    }
    .helpBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(199,165,255,.38);
      background: rgba(255,255,255,.10);
    }

    .helpText{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      line-height:1.45;
      font-size: 12px;
      display:none;
    }
    .helpText.show{ display:block; }

    input[type="text"], input[type="number"], select, textarea.fcText{
      width:100%;
      padding: 11px 11px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
      line-height:1.45;
      font-size: 13px;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea.fcText:focus{
      border-color: rgba(101,183,255,.40);
      box-shadow: 0 0 0 3px rgba(101,183,255,.12);
    }

    .tinyRow{
      margin-top:10px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .miniActions{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .miniLink{
      font-size: 12px;
      color: rgba(244,247,255,.78);
      text-decoration: underline;
      cursor:pointer;
      user-select:none;
    }
    .miniLink:hover{ color: rgba(244,247,255,.92); }

    .naToggle{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:flex-start;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .naToggle input{ transform: translateY(1px); }

    .progress{
      margin-top: 8px;
      width:100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(80,255,215,.75), rgba(101,183,255,.70), rgba(199,165,255,.60));
      border-radius: 999px;
      transition: width .18s ease;
    }

    .summary{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .sumCard{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
      padding: 14px;
    }
    .sumCard h4{
      margin:0;
      font-size: 13px;
      letter-spacing:.2px;
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .sumCard p{
      margin:8px 0 0 0;
      color: var(--muted);
      line-height:1.5;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .chipRow{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .chip{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(244,247,255,.86);
      white-space:nowrap;
    }
    .chip.good{ border-color: rgba(80,255,215,.34); background: rgba(80,255,215,.10); }
    .chip.warn{ border-color: rgba(255,199,80,.30); background: rgba(255,199,80,.10); }
    .chip.bad{ border-color: rgba(255,79,216,.34); background: rgba(255,79,216,.10); }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: rgba(244,247,255,.86);
    }

    /* Report modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      z-index: 60;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(980px, 100%);
      max-height: min(84vh, 860px);
      overflow:hidden;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(8,10,20,.92);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(0,0,0,.22);
    }
    .modalHead .t{
      font-weight: 950;
      letter-spacing:.2px;
      font-size: 13px;
    }
    .modalBody{
      padding: 14px;
      overflow:auto;
    }
    .modalBody pre{
      margin:0;
      white-space: pre-wrap;
      line-height:1.55;
      color: rgba(244,247,255,.92);
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="bg-wrap">
    <div class="aurora"></div>
    <canvas id="particles"></canvas>
    <div class="vignette"></div>
  </div>

  <div class="app">
    <aside class="side">
      <div class="brand">
        <div class="logoMark" aria-hidden="true">
          <svg viewBox="0 0 64 64" fill="none">
            <defs>
              <linearGradient id="g1" x1="6" y1="10" x2="58" y2="54" gradientUnits="userSpaceOnUse">
                <stop stop-color="#50FFD7"/>
                <stop offset="0.55" stop-color="#65B7FF"/>
                <stop offset="1" stop-color="#C7A5FF"/>
              </linearGradient>
              <filter id="glow" x="-40%" y="-40%" width="180%" height="180%">
                <feGaussianBlur stdDeviation="2.4" result="b"/>
                <feMerge>
                  <feMergeNode in="b"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <path filter="url(#glow)" d="M14 50V14h18c8 0 14 6 14 14 0 6-3 10-8 12l10 10h-10l-9-9H24v9H14Zm10-27h8c3 0 5 2 5 5s-2 5-5 5h-8V23Z" fill="url(#g1)" opacity="0.95"/>
            <path filter="url(#glow)" d="M48 50l-5-12h8l5 12h-8Z" fill="#FF4FD8" opacity="0.7"/>
          </svg>
        </div>
        <div>
          <h1><span>Raheem AI</span></h1>
          <div class="sub">Compliance-first chat and guided reports</div>
        </div>
      </div>

      <div class="nav">
        <button class="navbtn" id="navHome" type="button">
          <div class="left">
            <span class="tag">Home</span>
            <div style="min-width:0">
              <div style="font-weight:900">Overview</div>
              <div style="font-size:12px;color:var(--muted2);margin-top:2px">Product summary and quick start</div>
            </div>
          </div>
          <span class="tag">↗</span>
        </button>

        <button class="navbtn" id="navChat" type="button">
          <div class="left">
            <span class="tag live">Live</span>
            <div style="min-width:0">
              <div style="font-weight:900">Chat</div>
              <div style="font-size:12px;color:var(--muted2);margin-top:2px">Your existing TGD assistant (unchanged)</div>
            </div>
          </div>
          <span class="tag">↗</span>
        </button>

        <button class="navbtn" id="navFireCert" type="button">
          <div class="left">
            <span class="tag new">New</span>
            <div style="min-width:0">
              <div style="font-weight:900">Fire Cert</div>
              <div style="font-size:12px;color:var(--muted2);margin-top:2px">Guided Fire Safety Report workflow</div>
            </div>
          </div>
          <span class="tag">↗</span>
        </button>

        <button class="navbtn" id="navFuture" type="button">
          <div class="left">
            <span class="tag">Roadmap</span>
            <div style="min-width:0">
              <div style="font-weight:900">Future Features</div>
              <div style="font-size:12px;color:var(--muted2);margin-top:2px">Reports, BIM, integrations</div>
            </div>
          </div>
          <span class="tag">↗</span>
        </button>
      </div>

      <div class="sideFoot">
        <div style="font-weight:850;color:rgba(244,247,255,.86)">Usage tip</div>
        <div style="margin-top:6px">
          Fire Cert saves answers to your project. The client sees a normal form — no JSON screens.
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="crumb">
          <div class="title" id="viewTitle">Overview</div>
          <div class="hint" id="viewHint">Product summary and quick start</div>
        </div>
        <div class="actions">
          <button class="btn" id="btnStatus" type="button" title="Check backend health">Status</button>
          <button class="btn primary" id="btnDocs" type="button" title="Open API documentation">Docs</button>
        </div>
      </div>

      <!-- HOME -->
      <section class="view show" id="viewHome">
        <div class="hero">
          <h2>AI chat for compliance, specifications and technical workflows</h2>
          <p>
            Use Chat for TGD questions (unchanged). Use Fire Cert for guided project input and a draft Fire Safety Report.
          </p>
          <div class="quote">
            Fire Cert is designed to be “client safe”: clean questions, plain-language help, and no JSON exposure.
          </div>
        </div>

        <div class="grid">
          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">AI</div>
                <div>
                  <h4>Chat</h4>
                  <p>Your existing TGD compliance assistant stays exactly as it is.</p>
                </div>
              </div>
              <span class="pill" style="border-color: rgba(80,255,215,.38); background: rgba(80,255,215,.10); color: rgba(230,255,240,.92)">Live</span>
            </div>
            <div class="cta">
              <span class="pill">Evidence mode</span>
              <button class="btn primary" id="btnStartChat" type="button">Open chat</button>
            </div>
          </article>

          <article class="card">
            <div class="cardhead">
              <div class="cardtitle">
                <div class="icon">FCS</div>
                <div>
                  <h4>Fire Cert</h4>
                  <p>Guided questions → stored answers → generate a professional report draft.</p>
                </div>
              </div>
              <span class="pill" style="border-color: rgba(199,165,255,.35); background: rgba(199,165,255,.10); color: rgba(244,247,255,.92)">New</span>
            </div>
            <div class="cta">
              <span class="pill">TGD B Volume 1</span>
              <button class="btn primary" id="btnStartFireCert" type="button">Start Fire Cert</button>
            </div>
          </article>
        </div>

        <div class="footer">
          <div class="copy">© 2026 Raheem AI. All rights reserved.</div>
          <div>Built By Abdulraheem Hayder Ahmed</div>
        </div>
      </section>

      <!-- CHAT (placeholder view: keep your existing chat implementation in your own file if you want) -->
      <section class="view" id="viewChat">
        <div class="hero">
          <h2>Chat</h2>
          <p>
            This view is intentionally minimal in this HTML refinement. Keep your current chat logic as-is.
          </p>
          <div class="quote">
            Fire Cert does not touch the TGD assistant. They are separate modules.
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h4 style="margin:0;">Note</h4>
          <p style="margin:8px 0 0 0;color:var(--muted);line-height:1.55;">
            Paste your current Chat UI back into this section if you want it in the same file.
            This refined HTML focuses on improving Fire Cert without risking changes to your compliance assistant.
          </p>
        </div>

        <div class="footer">
          <div class="copy">© 2026 Raheem AI. All rights reserved.</div>
          <div>Tip: Evidence mode is best for technical checks.</div>
        </div>
      </section>

      <!-- FIRE CERT (REFINED + WIRED) -->
      <section class="view" id="viewFireCert">
        <div class="hero">
          <h2>Fire Cert — Fire Safety Report Generator</h2>
          <p>
            Answer guided questions aligned to <b>TGD B 2024 Volume 1</b>. Your answers are saved to a project. Each question has a plain-language help icon (<b>i</b>).
          </p>
          <div class="quote">
            Tip: If you’re missing info, leave it blank or add a note. The report will stay honest (e.g. “Not assessed (pending info)”).
          </div>
        </div>

        <div class="fcwrap">
          <!-- LEFT: Wizard -->
          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Fire Cert Wizard</h3>
                <div class="sub">This form is “client safe” — no JSON, just normal questions. Answers are saved automatically.</div>
              </div>
              <div class="chipRow" style="margin-top:0">
                <span class="chip good" id="fcChipProject">Project: not started</span>
                <span class="chip warn" id="fcChipDraft">Draft</span>
              </div>
            </div>

            <div class="panelBody">
              <div class="tinyRow" style="margin-top:0;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <button class="btn primary" id="fcBtnInit" type="button">Start / Resume Project</button>
                  <button class="btn" id="fcBtnSync" type="button">Refresh</button>
                  <button class="btn danger" id="fcBtnResetProject" type="button">Reset Project</button>
                </div>
                <div class="miniActions">
                  <button class="btn" id="fcBtnJumpNext" type="button">Jump to next unanswered</button>
                </div>
              </div>

              <div class="stepper" id="fcStepper"></div>

              <div class="formGrid" id="fcForm">
                <div class="field full">
                  <div class="mono">Loading schema…</div>
                </div>
              </div>

              <div class="tinyRow">
                <div style="min-width:220px; flex:1;">
                  <div class="progress" aria-label="Progress"><div id="fcProgress"></div></div>
                  <div class="mono" id="fcProgressText" style="margin-top:8px;">Progress: —</div>
                </div>

                <div class="miniActions">
                  <button class="btn ghost" id="fcBack" type="button">Back</button>
                  <button class="btn primary" id="fcNext" type="button">Next</button>
                </div>
              </div>

              <div class="tinyRow" style="justify-content:space-between;">
                <div class="miniActions" style="justify-content:flex-start;">
                  <button class="btn" id="fcBtnSaveLocal" type="button">Save local copy</button>
                </div>

                <div class="miniActions">
                  <button class="btn primary" id="fcBtnGenerate" type="button">Generate Report</button>
                </div>
              </div>

              <div class="smallHint">
                Generate Report calls <span class="mono">/firecert/generate-report</span> and shows the draft report on screen.
              </div>
            </div>
          </div>

          <!-- RIGHT: Summary -->
          <div class="summary">
            <div class="sumCard">
              <h4>
                Project Summary
                <span class="tag">Auto</span>
              </h4>
              <p id="fcSumProject">Start a project, then fill Step 0. This panel updates automatically.</p>
              <div class="chipRow" id="fcSumChips"></div>
              <div class="smallHint" id="fcSumTips">
                Plain-language help is on every field via the <b>i</b> icon.
              </div>
            </div>

            <div class="sumCard">
              <h4>
                Completion & Flags
                <span class="tag">Live</span>
              </h4>
              <p id="fcSumFlags">No flags yet.</p>
              <div class="smallHint">
                Outcome states used in the report:
                ✅ Compliant • ⚠️ Compensatory • ❌ Alternative solution • ⏳ Not assessed
              </div>
            </div>

            <div class="sumCard">
              <h4>
                Report Output
                <span class="tag">Preview</span>
              </h4>
              <p>
                After generation, your report appears in a viewer. You can copy it or download as a simple Word-compatible file.
              </p>
              <div class="miniActions" style="justify-content:flex-start;">
                <button class="btn" id="fcBtnCopyReport" type="button" disabled>Copy report text</button>
                <button class="btn" id="fcBtnDownloadDoc" type="button" disabled>Download as .doc</button>
              </div>
            </div>
          </div>
        </div>

        <div class="footer">
          <div class="copy">© 2026 Raheem AI. All rights reserved.</div>
          <div>Fire Cert Module (Wired)</div>
        </div>
      </section>

      <!-- FUTURE -->
      <section class="view" id="viewFuture">
        <div class="hero">
          <h2>Future Features</h2>
          <p>
            Roadmap preview. Fire Cert is the current focus.
          </p>
          <div class="quote">
            Each module is shipped incrementally with reliability and clarity first.
          </div>
        </div>

        <div class="footer">
          <div class="copy">© 2026 Raheem AI. All rights reserved.</div>
          <div>Roadmap</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Report Modal -->
  <div class="modalOverlay" id="reportModal">
    <div class="modal">
      <div class="modalHead">
        <div class="t">Fire Safety Report (Draft)</div>
        <div class="miniActions">
          <button class="btn" id="reportClose" type="button">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <pre id="reportText">No report yet.</pre>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const DEFAULT_API_BASE = "https://complyr.onrender.com"; // keep your current backend
    const API_BASE = (localStorage.getItem("RAHEEM_API_BASE") || DEFAULT_API_BASE).trim();

    // Safety: prevent arbitrary API_BASE overrides (protects users and prevents broken configs)
    if (!API_BASE.startsWith("https://complyr.onrender.com")) {
      localStorage.removeItem("RAHEEM_API_BASE");
    }
    function apiUrl(path){ return API_BASE.replace(/\/+$/,"") + path; }

    // =========================
    // HELPERS
    // =========================
    const toast = document.getElementById("toast");
    let toastTimer = null;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 2800);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function safeJson(res){
      const t = await res.text();
      try { return JSON.parse(t); } catch(e){ return { ok:false, error: t || ("HTTP " + res.status) }; }
    }

    // =========================
    // NAVIGATION
    // =========================
    const viewTitle = document.getElementById("viewTitle");
    const viewHint  = document.getElementById("viewHint");
    const viewHome  = document.getElementById("viewHome");
    const viewChat  = document.getElementById("viewChat");
    const viewFireCert = document.getElementById("viewFireCert");
    const viewFuture= document.getElementById("viewFuture");

    function showView(which){
      [viewHome, viewChat, viewFireCert, viewFuture].forEach(v=>v.classList.remove("show"));
      if(which==="home"){
        viewHome.classList.add("show");
        viewTitle.textContent = "Overview";
        viewHint.textContent  = "Product summary and quick start";
      }
      if(which==="chat"){
        viewChat.classList.add("show");
        viewTitle.textContent = "Chat";
        viewHint.textContent  = "TGD assistant (unchanged)";
      }
      if(which==="firecert"){
        viewFireCert.classList.add("show");
        viewTitle.textContent = "Fire Cert";
        viewHint.textContent  = "Guided Fire Safety Report workflow";
        fcInitOnce();
      }
      if(which==="future"){
        viewFuture.classList.add("show");
        viewTitle.textContent = "Future Features";
        viewHint.textContent  = "Roadmap preview";
      }
    }

    document.getElementById("navHome").onclick  = ()=>showView("home");
    document.getElementById("navChat").onclick  = ()=>showView("chat");
    document.getElementById("navFireCert").onclick = ()=>showView("firecert");
    document.getElementById("navFuture").onclick= ()=>showView("future");

    document.getElementById("btnStartChat").onclick = ()=>showView("chat");
    document.getElementById("btnStartFireCert").onclick = ()=>showView("firecert");

    document.getElementById("btnDocs").onclick = ()=> window.open(apiUrl("/swagger"), "_blank");
    document.getElementById("btnStatus").onclick = async ()=>{
      try{
        const r = await fetch(apiUrl("/health"));
        const j = await safeJson(r);
        if(!r.ok || !j.ok){
          showToast("Status error: " + (j.error || r.status));
          return;
        }
        showToast(j.vertex_ready ? "Status: Online (AI ready)" : "Status: Online (AI warming up)");
      }catch(e){
        showToast("Status check failed. Backend may be offline or blocked by CORS.");
      }
    };

    // =========================
    // FIRE CERT (WIRED)
    // =========================
    const FC_LOCAL_KEY = "raheem_firecert_project_v1"; // stores {project_id, last_step_id}
    const FC_LAST_REPORT_KEY = "raheem_firecert_last_report_v1";

    let fcInited = false;
    let fcSchema = null;      // schema from backend
    let fcProjectId = null;   // persisted project id
    let fcProject = null;     // full project from backend
    let fcStepIndex = 0;      // which step we are viewing

    const elStepper = document.getElementById("fcStepper");
    const elForm = document.getElementById("fcForm");
    const elProgress = document.getElementById("fcProgress");
    const elProgressText = document.getElementById("fcProgressText");
    const elChipProject = document.getElementById("fcChipProject");
    const elSumProject = document.getElementById("fcSumProject");
    const elSumChips = document.getElementById("fcSumChips");
    const elSumFlags = document.getElementById("fcSumFlags");

    const btnBack = document.getElementById("fcBack");
    const btnNext = document.getElementById("fcNext");
    const btnInit = document.getElementById("fcBtnInit");
    const btnSync = document.getElementById("fcBtnSync");
    const btnReset = document.getElementById("fcBtnResetProject");
    const btnJumpNext = document.getElementById("fcBtnJumpNext");
    const btnSaveLocal = document.getElementById("fcBtnSaveLocal");
    const btnGenerate = document.getElementById("fcBtnGenerate");

    const reportModal = document.getElementById("reportModal");
    const reportClose = document.getElementById("reportClose");
    const reportTextEl = document.getElementById("reportText");
    const btnCopyReport = document.getElementById("fcBtnCopyReport");
    const btnDownloadDoc = document.getElementById("fcBtnDownloadDoc");

    function fcLoadLocal(){
      try{
        return JSON.parse(localStorage.getItem(FC_LOCAL_KEY) || "{}");
      }catch(e){
        return {};
      }
    }
    function fcSaveLocal(){
      const payload = { project_id: fcProjectId, last_step_id: fcSchema?.steps?.[fcStepIndex]?.id || null, saved: Date.now() };
      localStorage.setItem(FC_LOCAL_KEY, JSON.stringify(payload));
    }

    function fcGetAnswer(qid){
      const a = fcProject?.answers?.[qid];
      if(!a) return { value:null, na:false, notes:"", refs:"" };
      return {
        value: (a.value ?? null),
        na: !!a.na,
        notes: (a.notes || ""),
        refs: (a.refs || "")
      };
    }

    function fcSetChip(text, kind="good"){
      elChipProject.className = "chip " + (kind==="warn"?"warn":kind==="bad"?"bad":"good");
      elChipProject.textContent = text;
    }

    function fcSteps(){
      return fcSchema?.steps || [];
    }

    function fcCurrentStep(){
      const steps = fcSteps();
      return steps[fcStepIndex] || null;
    }

    async function fcFetchSchema(){
      const r = await fetch(apiUrl("/firecert/schema"));
      const j = await safeJson(r);
      if(!r.ok || !j.ok || !j.schema){
        throw new Error(j.error || "Failed to load schema");
      }
      fcSchema = j.schema;
    }

    async function fcInitOrResumeProject(){
      // If we already have a project id, just fetch it
      const local = fcLoadLocal();
      if(local.project_id){
        fcProjectId = local.project_id;
        await fcFetchProject();
        // restore step if possible
        const steps = fcSteps();
        if(local.last_step_id){
          const idx = steps.findIndex(s=>s.id === local.last_step_id);
          if(idx >= 0) fcStepIndex = idx;
        }
        fcSaveLocal();
        return;
      }

      // create new project
      const r = await fetch(apiUrl("/firecert/project/init"), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ meta:{} })
      });
      const j = await safeJson(r);
      if(!r.ok || !j.ok || !j.project){
        throw new Error(j.error || "Project init failed");
      }
      fcProjectId = j.project.project_id;
      fcSaveLocal();
      await fcFetchProject();
    }

    async function fcFetchProject(){
      if(!fcProjectId) throw new Error("Missing project_id");
      const r = await fetch(apiUrl("/firecert/project?project_id=" + encodeURIComponent(fcProjectId)));
      const j = await safeJson(r);
      if(!r.ok || !j.ok || !j.project){
        throw new Error(j.error || "Failed to fetch project");
      }
      fcProject = j.project;
      fcSetChip("Project: " + fcProjectId.slice(0,8) + "…", "good");
    }

    async function fcPatchMeta(metaPatch){
      if(!fcProjectId) return;
      const r = await fetch(apiUrl("/firecert/project/meta"), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ project_id: fcProjectId, meta: metaPatch || {} })
      });
      const j = await safeJson(r);
      if(!r.ok || !j.ok){
        throw new Error(j.error || "Meta update failed");
      }
      // update local copy
      fcProject.meta = fcProject.meta || {};
      Object.assign(fcProject.meta, metaPatch || {});
    }

    async function fcSaveAnswer(qid, value, na, notes, refs){
      if(!fcProjectId) throw new Error("Missing project_id");

      const payload = {
        project_id: fcProjectId,
        qid,
        value: value,
        na: !!na,
        notes: notes || "",
        refs: refs || ""
      };

      const r = await fetch(apiUrl("/firecert/answer"), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const j = await safeJson(r);
      if(!r.ok || !j.ok){
        throw new Error(j.error || "Answer save failed");
      }

      // refresh project so gating/auto-NA is up-to-date
      await fcFetchProject();
      fcSaveLocal();
    }

    function fcRenderStepper(){
      const steps = fcSteps();
      elStepper.innerHTML = "";

      steps.forEach((s, idx)=>{
        const b = document.createElement("div");
        b.className = "stepChip " + (idx===fcStepIndex ? "active" : "");
        b.innerHTML = `<span class="n">${idx+1}</span><span>${escapeHtml(s.title || s.id)}</span>`;
        b.onclick = ()=>{
          fcStepIndex = idx;
          fcSaveLocal();
          fcRenderAll();
        };
        elStepper.appendChild(b);
      });
    }

    function fcMakeField(q, answer){
      const qid = q.id;
      const label = q.label || qid;
      const help = q.help || "Fill in the value that applies to your project. If unknown, leave blank or add a note.";

      const field = document.createElement("div");
      field.className = "field " + ((q.type==="text" || q.type==="multiselect") ? "full" : "");
      field.dataset.qid = qid;

      const helpId = "help_" + qid;
      const inputId = "in_" + qid;

      const top = document.createElement("div");
      top.className = "labelRow";
      top.innerHTML = `
        <label for="${escapeHtml(inputId)}">${escapeHtml(label)}</label>
        <div class="helpBtn" data-help="${escapeHtml(helpId)}" title="Explain">i</div>
      `;
      field.appendChild(top);

      let inputEl;

      // Types: bool, select, multiselect, number, text
      if(q.type === "bool"){
        inputEl = document.createElement("select");
        inputEl.id = inputId;
        inputEl.innerHTML = `
          <option value=""></option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        `;
        const v = (answer.value === true) ? "true" : (answer.value === false) ? "false" : "";
        inputEl.value = v;

      } else if(q.type === "select"){
        inputEl = document.createElement("select");
        inputEl.id = inputId;
        const opts = Array.isArray(q.options) ? q.options : [];
        inputEl.innerHTML = `<option value=""></option>` + opts.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
        inputEl.value = (answer.value ?? "");

      } else if(q.type === "multiselect"){
        // Use a multi-select <select multiple> (simple, client-safe)
        inputEl = document.createElement("select");
        inputEl.id = inputId;
        inputEl.multiple = true;
        inputEl.size = Math.min(8, Math.max(4, (q.options||[]).length || 4));
        const opts = Array.isArray(q.options) ? q.options : [];
        inputEl.innerHTML = opts.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
        const arr = Array.isArray(answer.value) ? answer.value : [];
        [...inputEl.options].forEach(opt=>{
          opt.selected = arr.includes(opt.value);
        });

      } else if(q.type === "number"){
        inputEl = document.createElement("input");
        inputEl.id = inputId;
        inputEl.type = "number";
        inputEl.placeholder = "0";
        inputEl.value = (answer.value ?? "");

      } else {
        // text
        inputEl = document.createElement("input");
        inputEl.id = inputId;
        inputEl.type = "text";
        inputEl.placeholder = "Type here…";
        inputEl.value = (answer.value ?? "");
      }

      field.appendChild(inputEl);

      // Help text
      const helpBox = document.createElement("div");
      helpBox.className = "helpText";
      helpBox.id = helpId;
      helpBox.textContent = help;
      field.appendChild(helpBox);

      // NA toggle + Notes + Refs
      const row = document.createElement("div");
      row.className = "tinyRow";

      row.innerHTML = `
        <label class="naToggle"><input type="checkbox" id="na_${escapeHtml(qid)}" ${answer.na ? "checked" : ""}/> Not applicable</label>
        <div class="miniActions">
          <span class="miniLink" data-toggle="notes_${escapeHtml(qid)}">Notes</span>
          <span class="miniLink" data-toggle="refs_${escapeHtml(qid)}">Refs</span>
          <button class="btn" data-save="${escapeHtml(qid)}" type="button">Save</button>
        </div>
      `;
      field.appendChild(row);

      const notesBox = document.createElement("div");
      notesBox.className = "helpText";
      notesBox.id = "notes_" + qid;
      notesBox.innerHTML = `
        <div style="font-weight:900;margin-bottom:6px;color:rgba(244,247,255,.92)">Notes (optional)</div>
        <textarea class="fcText" rows="3" id="notesIn_${escapeHtml(qid)}" placeholder="Add a short note if needed (e.g. assumptions, pending info).">${escapeHtml(answer.notes || "")}</textarea>
      `;
      field.appendChild(notesBox);

      const refsBox = document.createElement("div");
      refsBox.className = "helpText";
      refsBox.id = "refs_" + qid;
      refsBox.innerHTML = `
        <div style="font-weight:900;margin-bottom:6px;color:rgba(244,247,255,.92)">Refs (optional)</div>
        <input type="text" id="refsIn_${escapeHtml(qid)}" placeholder="e.g. TGD B Vol 1 Section X Table Y" value="${escapeHtml(answer.refs || "")}"/>
      `;
      field.appendChild(refsBox);

      // Disable input if NA
      function applyNA(){
        const na = document.getElementById("na_" + qid).checked;
        inputEl.disabled = na;
        if(na){
          inputEl.style.opacity = "0.6";
        }else{
          inputEl.style.opacity = "1";
        }
      }
      setTimeout(applyNA, 0);

      // Wire help buttons/toggles
      field.querySelector(".helpBtn").onclick = ()=>{
        helpBox.classList.toggle("show");
      };
      field.querySelectorAll("[data-toggle]").forEach(x=>{
        x.onclick = ()=>{
          const id = x.getAttribute("data-toggle");
          const el = document.getElementById(id);
          if(el) el.classList.toggle("show");
        };
      });

      // Save button
      field.querySelector("[data-save]").onclick = async ()=>{
        try{
          const na = document.getElementById("na_" + qid).checked;

          let value = null;
          if(!na){
            if(q.type === "bool"){
              const v = inputEl.value.trim();
              value = (v === "true") ? true : (v === "false") ? false : null;
            }else if(q.type === "multiselect"){
              value = [...inputEl.selectedOptions].map(o=>o.value);
            }else if(q.type === "number"){
              const v = inputEl.value;
              value = (v === "" ? null : Number(v));
              if(value !== null && Number.isNaN(value)) value = null;
            }else{
              const v = inputEl.value;
              value = (v === "" ? null : v);
            }
          }

          const notes = (document.getElementById("notesIn_" + qid)?.value || "").trim();
          const refs = (document.getElementById("refsIn_" + qid)?.value || "").trim();

          await fcSaveAnswer(qid, value, na, notes, refs);
          showToast("Saved: " + label);
          fcRenderAll(); // refresh UI with updated auto-NA/gating
        }catch(e){
          console.error(e);
          showToast("Save failed: " + (e.message || "error"));
        }
      };

      // NA toggle
      document.addEventListener("change", (ev)=>{
        if(ev.target && ev.target.id === ("na_" + qid)){
          applyNA();
        }
      });

      // Auto-save on Enter (nice)
      inputEl.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" && q.type !== "multiselect"){
          e.preventDefault();
          field.querySelector("[data-save]")?.click();
        }
      });

      return field;
    }

    function fcRenderForm(){
      const step = fcCurrentStep();
      if(!step){
        elForm.innerHTML = `<div class="field full"><div class="mono">No step selected.</div></div>`;
        return;
      }

      const questions = step.questions || [];
      elForm.innerHTML = "";

      if(!questions.length){
        elForm.innerHTML = `<div class="field full"><div class="mono">No questions in this step.</div></div>`;
        return;
      }

      // NOTE: gating happens server-side through auto-NA and schema show_if.
      // In UI we still render all questions in the step, but NA ones are disabled.
      // If you want *only visible*, you can request /firecert/next-question or implement client show_if evaluation.
      questions.forEach(q=>{
        const ans = fcGetAnswer(q.id);
        const el = fcMakeField(q, ans);
        // If auto-NA already applied (na=true and notes contains auto), keep disabled
        elForm.appendChild(el);
      });
    }

    function fcComputeProgress(){
      const steps = fcSteps();
      const allQ = steps.flatMap(s => (s.questions||[]));
      const total = allQ.length || 1;

      let answered = 0;
      allQ.forEach(q=>{
        const a = fcProject?.answers?.[q.id];
        if(!a) return;
        if(a.na) { answered += 1; return; }
        const v = a.value;
        if(v === null || v === undefined) return;
        if(typeof v === "string" && !v.trim()) return;
        if(Array.isArray(v) && v.length === 0) return;
        answered += 1;
      });

      const pct = Math.max(0, Math.min(100, Math.round((answered/total)*100)));
      return { answered, total, pct };
    }

    function fcUpdateSummary(){
      const meta = fcProject?.meta || {};
      const answers = fcProject?.answers || {};

      // project summary text
      const addr = meta.s0_location || meta.location || "";
      const desc = meta.s0_description || "";
      const storeys = meta.s0_storeys_ag ?? "";
      const basements = meta.s0_storeys_bg ?? "";
      const height = meta.s0_height_building ?? "";
      const top = meta.s0_height_top_storey ?? "";

      // try to use answers if user typed into those fields (we're using /answer not /meta for most)
      function aVal(id){
        const a = answers[id];
        if(!a || a.na) return "";
        return (a.value ?? "");
      }

      const tgdEdition = aVal("s0_tgd_edition") || "TGD B 2024 – Volume 1";
      const withinScope = aVal("s0_within_scope");
      const top60 = aVal("s0_topmost_60m");
      const worksType = aVal("s0_works_type");

      const lines = [];
      if(addr) lines.push("Site: " + addr);
      if(desc) lines.push("Description: " + desc);
      if(worksType) lines.push("Works type: " + worksType);
      if(storeys !== "" || basements !== "") lines.push("Storeys: " + (storeys===""?"?":storeys) + " above ground, " + (basements===""?"?":basements) + " basements");
      if(height !== "" || top !== "") lines.push("Heights: building " + (height===""?"?":height) + "m, top storey " + (top===""?"?":top) + "m");
      lines.push("Guidance: " + tgdEdition);

      elSumProject.textContent = lines.length ? lines.join("\n") : "Fill Step 0 first. This panel updates automatically.";

      // chips
      elSumChips.innerHTML = "";
      const chips = [];

      if(withinScope === false) chips.push({t:"Outside scope?", c:"warn"});
      if(top60 === false) chips.push({t:"Top floor > 60m", c:"bad"});
      if(worksType && worksType !== "New building") chips.push({t:"Existing works", c:"warn"});

      const prog = fcComputeProgress();
      chips.push({t: "Progress " + prog.pct + "%", c: prog.pct >= 80 ? "good" : prog.pct >= 40 ? "warn" : "bad"});

      if(chips.length){
        chips.forEach(x=>{
          const sp = document.createElement("span");
          sp.className = "chip " + (x.c==="bad"?"bad":x.c==="warn"?"warn":"good");
          sp.textContent = x.t;
          elSumChips.appendChild(sp);
        });
      }

      // flags (simple but helpful)
      const flags = [];
      if(withinScope === false) flags.push("Project marked outside typical Volume 1 scope → consider alternative / performance-based approach.");
      if(top60 === false) flags.push("Topmost floor height appears above 60m → verify scope and strategy.");
      if(worksType && worksType !== "New building") flags.push("Existing works selected → ensure ‘reasonable achievability’ is addressed.");

      elSumFlags.textContent = flags.length ? flags.join(" ") : "No flags yet.";
    }

    function fcRenderAll(){
      fcRenderStepper();
      fcRenderForm();
      fcUpdateSummary();

      const prog = fcComputeProgress();
      elProgress.style.width = prog.pct + "%";
      elProgressText.textContent = "Progress: " + prog.pct + "% (" + prog.answered + "/" + prog.total + " complete or NA)";

      btnBack.disabled = (fcStepIndex === 0);
      btnNext.textContent = (fcStepIndex === fcSteps().length - 1) ? "Finish" : "Next";
    }

    async function fcJumpToNextUnanswered(){
      if(!fcProjectId){
        showToast("Start a project first.");
        return;
      }
      try{
        const r = await fetch(apiUrl("/firecert/next-question"), {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ project_id: fcProjectId })
        });
        const j = await safeJson(r);
        if(!r.ok || !j.ok){
          showToast("Jump failed: " + (j.error || "error"));
          return;
        }
        if(j.done){
          showToast("All relevant questions are complete (or marked NA).");
          return;
        }
        // jump to step
        const stepId = j.step;
        const idx = fcSteps().findIndex(s=>s.id === stepId);
        if(idx >= 0){
          fcStepIndex = idx;
          fcSaveLocal();
          fcRenderAll();
          showToast("Jumped to: " + (j.step_title || stepId));
        }else{
          showToast("Next question found, but step not matched in UI.");
        }
      }catch(e){
        console.error(e);
        showToast("Jump failed.");
      }
    }

    async function fcGenerateReport(){
      if(!fcProjectId){
        showToast("Start a project first.");
        return;
      }
      try{
        btnGenerate.disabled = true;
        showToast("Generating report…");
        const r = await fetch(apiUrl("/firecert/generate-report"), {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ project_id: fcProjectId })
        });
        const j = await safeJson(r);
        if(!r.ok || !j.ok){
          showToast("Generate failed: " + (j.error || "error"));
          return;
        }
        const report = (j.report || "").trim();
        if(!report){
          showToast("Generated, but no report text returned.");
          return;
        }
        localStorage.setItem(FC_LAST_REPORT_KEY, report);
        reportTextEl.textContent = report;
        reportModal.classList.add("show");

        btnCopyReport.disabled = false;
        btnDownloadDoc.disabled = false;

        showToast("Report generated.");
      }catch(e){
        console.error(e);
        showToast("Generate failed.");
      }finally{
        btnGenerate.disabled = false;
      }
    }

    function fcCopyReport(){
      const report = localStorage.getItem(FC_LAST_REPORT_KEY) || "";
      if(!report.trim()){
        showToast("No report to copy.");
        return;
      }
      navigator.clipboard.writeText(report).then(()=>{
        showToast("Copied report text.");
      }).catch(()=>{
        showToast("Copy failed.");
      });
    }

    function fcDownloadDoc(){
      const report = localStorage.getItem(FC_LAST_REPORT_KEY) || "";
      if(!report.trim()){
        showToast("No report to download.");
        return;
      }

      // A very simple Word-compatible .doc (HTML) download
      const html =
`<html><head><meta charset="utf-8"><title>Fire Safety Report</title></head>
<body><pre style="white-space:pre-wrap; font-family:Calibri, Arial, sans-serif; font-size:11pt; line-height:1.5;">${escapeHtml(report)}</pre></body></html>`;

      const blob = new Blob([html], { type: "application/msword" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "Fire_Safety_Report_Draft.doc";
      a.click();
      URL.revokeObjectURL(a.href);
      showToast("Downloaded .doc draft.");
    }

    async function fcInitOnce(){
      if(fcInited) return;
      fcInited = true;

      try{
        // schema first
        await fcFetchSchema();

        // project load/resume (optional until user clicks init)
        const local = fcLoadLocal();
        if(local.project_id){
          fcProjectId = local.project_id;
          await fcFetchProject();
          const steps = fcSteps();
          if(local.last_step_id){
            const idx = steps.findIndex(s=>s.id === local.last_step_id);
            if(idx >= 0) fcStepIndex = idx;
          }
          fcSaveLocal();
          fcRenderAll();
        }else{
          fcSetChip("Project: not started", "warn");
          elForm.innerHTML = `<div class="field full"><div class="mono">Click “Start / Resume Project” to begin.</div></div>`;
          elStepper.innerHTML = "";
          elProgressText.textContent = "Progress: —";
        }

      }catch(e){
        console.error(e);
        fcSetChip("Schema error", "bad");
        elForm.innerHTML = `<div class="field full"><div class="mono">Failed to load Fire Cert schema. Check backend.</div></div>`;
      }

      // Buttons
      btnInit.onclick = async ()=>{
        try{
          btnInit.disabled = true;
          await fcInitOrResumeProject();
          showToast("Project ready.");
          fcRenderAll();
        }catch(e){
          console.error(e);
          showToast("Init failed: " + (e.message || "error"));
        }finally{
          btnInit.disabled = false;
        }
      };

      btnSync.onclick = async ()=>{
        try{
          btnSync.disabled = true;
          if(!fcProjectId){
            showToast("No project. Click Start first.");
            return;
          }
          await fcFetchProject();
          fcRenderAll();
          showToast("Refreshed.");
        }catch(e){
          console.error(e);
          showToast("Refresh failed.");
        }finally{
          btnSync.disabled = false;
        }
      };

      btnReset.onclick = async ()=>{
        const ok = confirm("Reset Fire Cert project link on this browser? This does NOT delete server memory, it just unlinks this device.\n\n(You can start a fresh project afterwards.)");
        if(!ok) return;
        localStorage.removeItem(FC_LOCAL_KEY);
        localStorage.removeItem(FC_LAST_REPORT_KEY);
        fcProjectId = null;
        fcProject = null;
        fcStepIndex = 0;
        fcSetChip("Project: not started", "warn");
        elStepper.innerHTML = "";
        elForm.innerHTML = `<div class="field full"><div class="mono">Click “Start / Resume Project” to begin.</div></div>`;
        elProgressText.textContent = "Progress: —";
        showToast("Reset complete.");
      };

      btnJumpNext.onclick = fcJumpToNextUnanswered;

      btnBack.onclick = ()=>{
        if(fcStepIndex > 0){
          fcStepIndex--;
          fcSaveLocal();
          fcRenderAll();
        }
      };
      btnNext.onclick = ()=>{
        if(fcStepIndex < fcSteps().length - 1){
          fcStepIndex++;
          fcSaveLocal();
          fcRenderAll();
        }else{
          showToast("Wizard steps complete. Use “Jump to next unanswered” to find anything missing.");
        }
      };

      btnSaveLocal.onclick = ()=>{
        fcSaveLocal();
        showToast("Saved local project link.");
      };

      btnGenerate.onclick = fcGenerateReport;

      // Modal controls
      reportClose.onclick = ()=> reportModal.classList.remove("show");
      reportModal.onclick = (e)=>{
        if(e.target === reportModal) reportModal.classList.remove("show");
      };

      // Copy/download
      btnCopyReport.onclick = fcCopyReport;
      btnDownloadDoc.onclick = fcDownloadDoc;

      // Load existing report if present
      const existing = (localStorage.getItem(FC_LAST_REPORT_KEY) || "").trim();
      if(existing){
        btnCopyReport.disabled = false;
        btnDownloadDoc.disabled = false;
      }
    }

    // =========================
    // Particles (calmer)
    // =========================
    const canvas = document.getElementById("particles");
    const ctx = canvas.getContext("2d");
    let W=0,H=0, particles=[];
    function resize(){
      W = canvas.width = window.innerWidth;
      H = canvas.height = window.innerHeight;
      const base = Math.floor(Math.min(80, Math.max(35, W/26)));
      particles = Array.from({length:base}).map(()=>({
        x: Math.random()*W,
        y: Math.random()*H,
        r: Math.random()*1.4 + 0.4,
        vx:(Math.random()*0.22+0.05)*(Math.random()<0.5?-1:1),
        vy:(Math.random()*0.18+0.04)*(Math.random()<0.5?-1:1),
        a: Math.random()*0.45 + 0.10
      }));
    }
    window.addEventListener("resize", resize);
    resize();

    function tick(){
      ctx.clearRect(0,0,W,H);
      for(const p of particles){
        p.x += p.vx;
        p.y += p.vy;
        if(p.x < -10) p.x = W+10;
        if(p.x > W+10) p.x = -10;
        if(p.y < -10) p.y = H+10;
        if(p.y > H+10) p.y = -10;

        ctx.beginPath();
        ctx.globalAlpha = p.a;
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fillStyle = "#ffffff";
        ctx.fill();
      }
      ctx.globalAlpha = 1;
      requestAnimationFrame(tick);
    }
    tick();

    // default view
    showView("home");
  </script>
</body>
</html>
